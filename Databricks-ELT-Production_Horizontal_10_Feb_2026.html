<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnvizGnt - Databricks ELT Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- JS-YAML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  <style>
    :root {
      /* Primary Colors */
      --primary-color: #1976D2;
      --primary-light: #42A5F5;
      --primary-dark: #1565C0;

      /* Secondary Colors */
      --secondary-color: #43A047;
      --secondary-light: #66BB6A;
      --secondary-dark: #388E3C;

      /* Accent Colors */
      --accent-color: #263238;
      --accent-light: #37474F;

      /* Semantic Colors */
      --success-color: #43A047;
      --warning-color: #FB8C00;
      --danger-color: #E53935;
      --info-color: #039BE5;

      /* Neutral Colors */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F7FA;
      --bg-tertiary: #ECEFF1;

      --text-primary: #212121;
      --text-secondary: #757575;
      --text-tertiary: #9E9E9E;

      --border-color: #E0E0E0;
      --border-dark: #BDBDBD;

      /* Special Colors */
      --file-source-bg: #FFF8E1;
      --file-source-border: #FFB300;

      /* Legacy Support (deprecated) */
      --dark-bg: #1E1E1E;
      --light-bg: #F5F7FA;
    }

    [data-theme="dark"] {
      /* Richer Dark Theme Palette (Slate/Blue-Grey based) */
      --bg-primary: #0f172a;
      /* Slate 900 - Deep rich background */
      --bg-secondary: #1e293b;
      /* Slate 800 - Component background */
      --bg-tertiary: #334155;
      /* Slate 700 - Lighter element background */

      --text-primary: #f8fafc;
      /* Slate 50 - High contrast text */
      --text-secondary: #cbd5e1;
      /* Slate 300 - Secondary text */
      --text-tertiary: #94a3b8;
      /* Slate 400 - Muted text */

      --border-color: #334155;
      /* Slate 700 - Subtle borders */
      --border-dark: #475569;
      /* Slate 600 - Stronger borders */

      --primary-color: #3b82f6;
      /* Blue 500 - Brighter primary for dark mode */
      --primary-light: #60a5fa;
      /* Blue 400 */
      --primary-dark: #2563eb;
      /* Blue 600 */

      --accent-color: #475569;
      /* Slate 600 */

      /* Semantic Colors Adjusted for Dark Mode */
      --success-color: #4ade80;
      /* Green 400 */
      --warning-color: #fbbf24;
      /* Amber 400 */
      --danger-color: #f87171;
      /* Red 400 */
      --info-color: #38bdf8;
      /* Sky 400 */

      --file-source-bg: #422006;
      /* Dark amber background */
      --file-source-border: #d97706;
      /* Amber 600 */

      --light-bg: #1e293b;
      /* Re-map light-bg to dark component bg for compatibility */
    }

    /* Dark Mode Global Overrides */
    [data-theme="dark"] body {
      background-color: #020617;
      /* Very dark slate/black for body background */
      color: var(--text-primary);
    }

    [data-theme="dark"] .main-container {
      background: var(--bg-primary);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-bottom: 1px solid var(--border-color);
    }

    [data-theme="dark"] .logo-container {
      background: rgba(255, 255, 255, 0.05);
      box-shadow: none;
      border: 1px solid var(--border-color);
    }



    /* Tabs */
    [data-theme="dark"] .nav-tabs-custom {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    [data-theme="dark"] .nav-tabs-custom .nav-link {
      color: var(--text-secondary);
    }

    [data-theme="dark"] .nav-tabs-custom .nav-link:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    [data-theme="dark"] .nav-tabs-custom .nav-link.active {
      background: var(--bg-primary);
      color: var(--primary-light);
      border-color: var(--border-color);
      border-bottom-color: var(--bg-primary);
      border-top-color: var(--primary-light);
    }

    /* Cards & Panels */
    [data-theme="dark"] .card,
    [data-theme="dark"] .sidebar-panel,
    [data-theme="dark"] .canvas-area,
    [data-theme="dark"] .step-card,
    [data-theme="dark"] .table-card,
    [data-theme="dark"] .connection-form,
    [data-theme="dark"] .transform-section,
    [data-theme="dark"] .help-steps,
    [data-theme="dark"] .table-selector,
    [data-theme="dark"] .designer-canvas {
      background: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .card.bg-light {
      background-color: var(--bg-tertiary) !important;
      border: 1px solid var(--border-color);
    }

    /* Text Colors */
    [data-theme="dark"] .text-muted {
      color: var(--text-tertiary) !important;
    }

    [data-theme="dark"] h1,
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4,
    [data-theme="dark"] h5,
    [data-theme="dark"] h6,
    [data-theme="dark"] .sidebar-title,
    [data-theme="dark"] .step-title,
    [data-theme="dark"] .table-card-title,
    [data-theme="dark"] .card-title {
      color: var(--text-primary) !important;
    }

    /* Form Elements */
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] .join-logic-select {
      background-color: var(--bg-primary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    [data-theme="dark"] .form-label,
    [data-theme="dark"] label {
      color: var(--text-secondary);
    }

    /* Tables */
    [data-theme="dark"] .table {
      color: var(--text-secondary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .table thead th {
      color: var(--text-primary);
      border-bottom-color: var(--border-dark);
      background-color: var(--bg-tertiary);
    }

    [data-theme="dark"] .table-item,
    [data-theme="dark"] .column-item {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid transparent;
    }

    [data-theme="dark"] .table-item:hover,
    [data-theme="dark"] .column-item:hover {
      background: var(--bg-primary);
      border-color: var(--border-dark);
    }

    /* Modals */
    [data-theme="dark"] .modal-content {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .modal-header,
    [data-theme="dark"] .modal-footer {
      border-color: var(--border-color);
    }

    [data-theme="dark"] .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
    }

    /* Buttons */
    [data-theme="dark"] .btn-outline-secondary {
      color: var(--text-secondary);
      border-color: var(--border-dark);
    }

    [data-theme="dark"] .btn-outline-secondary:hover {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }

    [data-theme="dark"] .transformation-btn {
      background-color: var(--bg-primary);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .transformation-btn:hover {
      background-color: rgba(147, 51, 234, 0.1);
      /* Purple tint */
      border-color: #9333ea;
      color: #d8b4fe;
    }



    /* Stepper */
    [data-theme="dark"] .stepper-step {
      background: var(--bg-secondary);
      border-color: var(--border-dark);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .stepper-step.active {
      background: var(--bg-primary);
      border-color: var(--primary-color);
      color: var(--text-primary);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }

    [data-theme="dark"] .step-line {
      background-color: var(--border-dark);
    }

    [data-theme="dark"] .stepper-header::before {
      background: var(--border-dark);
    }

    /* Code/Pre */
    [data-theme="dark"] code {
      color: var(--warning-color);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 4px;
      border-radius: 4px;
    }

    /* Custom Scrollbar for Dark Mode */
    [data-theme="dark"] ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    [data-theme="dark"] ::-webkit-scrollbar-thumb {
      background: var(--border-dark);
      border-radius: 4px;
    }

    [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Flow Steps */
    [data-theme="dark"] .flow-step {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .flow-step:hover {
      border-color: var(--primary-color);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      transform: translateY(-3px);
    }

    /* Join Config */
    [data-theme="dark"] .join-connector {
      background: var(--bg-tertiary);
      border-color: var(--border-dark);
    }

    [data-theme="dark"] .join-connector::before {
      color: var(--primary-light);
    }

    [data-theme="dark"] .join-row {
      background: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .join-row:hover {
      background: var(--bg-primary);
      border-color: var(--primary-color);
    }

    [data-theme="dark"] .join-logic-static {
      background: var(--bg-tertiary);
      border-color: var(--border-dark);
      color: var(--text-secondary);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-secondary);
      min-height: 100vh;
      padding: 10px;
    }

    .main-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Header Styles */
    /* Premium Configured Connections Styles */
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
      border-radius: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      overflow: hidden;
    }

    [data-theme="dark"] .glass-card {
      background: rgba(30, 41, 59, 0.7);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
    }

    .hero-section {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2.5rem;
      position: relative;
      overflow: hidden;
    }

    .hero-section::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      opacity: 0.3;
    }

    .hero-section.target-hero {
      background: linear-gradient(135deg, var(--file-source-border) 0%, #b45309 100%);
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      padding: 1.5rem;
    }

    .metric-box {
      background: var(--light-bg);
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    [data-theme="dark"] .metric-box {
      background: rgba(255, 255, 255, 0.03);
    }

    .metric-box:hover {
      background: white;
      border-color: var(--primary-light);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .metric-box:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .metric-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .metric-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .connection-nav-item {
      position: relative;
      transition: all 0.2s ease;
      border-right: 3px solid transparent;
      margin-bottom: 4px;
      border-radius: 8px 0 0 8px;
    }

    .connection-nav-item:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }

    .connection-nav-item.active-source {
      background: linear-gradient(90deg, rgba(25, 118, 210, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
      border-right-color: var(--primary-color);
    }

    .connection-nav-item.active-target {
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
      border-right-color: var(--file-source-border);
    }

    .btn-soft-primary {
      background-color: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .btn-soft-primary:hover {
      background-color: #0d6efd;
      color: white;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
    }

    [data-theme="dark"] .connection-nav-item.active-source {
      background: linear-gradient(90deg, rgba(25, 118, 210, 0.2) 0%, rgba(0, 0, 0, 0) 100%);
    }

    [data-theme="dark"] .connection-nav-item.active-target {
      background: linear-gradient(90deg, rgba(217, 119, 6, 0.2) 0%, rgba(0, 0, 0, 0) 100%);
    }

    /* Workspace Readiness Status Bar */
    .readiness-bar {
      background: #f8fafc;
      border-bottom: 1px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: -20px -20px 20px -20px;
      /* Offset parent padding */
    }

    .readiness-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
      padding: 4px 12px;
      border-radius: 20px;
      background: white;
      border: 1px solid var(--border-color);
    }

    .readiness-item.ready {
      color: var(--success-color);
      border-color: rgba(var(--success-rgb, 76, 175, 80), 0.3);
      background: rgba(var(--success-rgb, 76, 175, 80), 0.05);
    }

    .readiness-item i {
      font-size: 0.8rem;
    }

    /* Modern Header Design */
    .header {
      background: #0f172a;
      /* Slate 900 base */
      background: radial-gradient(circle at top center, #1e293b 0%, #0f172a 80%);
      color: white;
      padding: 12px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .logo-container {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 8px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
    }

    .logo-container:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .logo-text {
      font-size: 22px;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.5px;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      line-height: 1;
    }

    .logo-an {
      color: #f8fafc;
    }

    .logo-viz {
      color: #3b82f6;
    }

    /* Modern Blue */
    .logo-gnt {
      color: #f8fafc;
    }

    .header-title-section {
      border-left: 1px solid rgba(255, 255, 255, 0.15);
      padding-left: 24px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: #f1f5f9;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header h1 i {
      color: #60a5fa;
      /* Light Blue Icon */
      font-size: 16px;
    }

    .header-subtitle {
      color: #94a3b8;
      /* Slate 400 */
      font-size: 12px;
      margin-top: 2px;
      font-weight: 400;
      opacity: 1;
    }

    .header .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    /* Theme Toggle Switch - Modernized */
    .theme-switch-wrapper {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .theme-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      /* Slightly smaller */
      height: 22px;
      margin: 0;
    }

    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.3);
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: #cbd5e1;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--primary-color);
    }

    input:checked+.slider:before {
      transform: translateX(22px);
      background-color: white;
    }

    .theme-icon {
      color: #94a3b8;
      font-size: 12px;
      margin: 0 6px;
    }

    input:checked~.theme-icon.fa-moon {
      color: #f8fafc;
    }

    input:not(:checked)~.theme-icon.fa-sun {
      color: #fbbf24;
    }

    /* User Profile Modern Pill */
    .user-profile-pill {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 4px 4px 4px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 30px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .user-profile-pill:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .user-details {
      text-align: right;
      line-height: 1.2;
    }

    .user-name {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #f1f5f9;
    }

    .user-role {
      display: block;
      font-size: 11px;
      color: #94a3b8;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Navigation Tabs */
    .nav-tabs-custom {
      background: #f8f9fa;
      padding: 0 20px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      gap: 5px;
    }

    .nav-tabs-custom .nav-link {
      color: #6c757d;
      border: none;
      border-radius: 8px 8px 0 0;
      padding: 12px 20px;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
      position: relative;
      margin-bottom: -1px;
      font-size: 0.95rem;
    }

    .nav-tabs-custom .nav-link:hover {
      color: var(--primary-color);
      background: rgba(var(--primary-rgb, 13, 110, 253), 0.05);
      /* Fallback to standard blue if var unavailable */
    }

    .nav-tabs-custom .nav-link.active {
      color: var(--primary-color);
      background: white;
      border: 1px solid #dee2e6;
      border-bottom-color: white;
      border-top: 3px solid var(--primary-color);
      font-weight: 600;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.02);
    }

    .nav-tabs-custom .nav-link i {
      margin-right: 8px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .nav-tabs-custom .nav-link.active i {
      opacity: 1;
    }

    /* Content Area */
    .content-area {
      padding: 10px 15px;
    }

    /* Workflow Designer Section */
    /* Workflow Designer Section */
    .designer-container {
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr) 250px;
      /* Reduced right sidebar to 250px */
      /* 3-Column Layout */
      gap: 15px;
      margin-bottom: 15px;
      height: 600px;
      /* Fixed height for consistency */
    }

    .table-selector {
      grid-column: 1;
      height: 100%;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 15px;
      overflow-y: auto;
    }

    /* Target the wrapper div for the center column */
    .designer-canvas {
      grid-column: 2;
      height: 100%;
      border-radius: 12px;
      /* Inline style override handled here if needed, but easier to change HTML */
    }

    .sidebar-panel {
      grid-column: 3;
      background: white;
      /* Match table-selector */
      border: 1px solid #dee2e6;
      /* Match table-selector */
      border-radius: 12px;
      padding: 15px;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      /* Prevent horizontal expansion */
      width: 100%;
      /* Fill the grid track */
      min-width: 250px;
      /* Enforce min width */
      max-width: 250px;
      /* Enforce max width */
    }



    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }

    .canvas-area {
      background: white;
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      min-height: 500px;
      padding: 15px;
      position: relative;
    }

    /* Step Cards */
    .step-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s;
      border-left: 4px solid var(--primary-color);
    }

    .step-card:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0, 153, 255, 0.2);
    }

    .step-card.active {
      background: linear-gradient(to right, #e3f2fd 0%, #ffffff 100%);
      border-left-color: var(--primary-color);
    }

    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .step-title {
      font-weight: 600;
      font-size: 15px;
      color: #333;
    }

    .step-status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success-color);
    }

    .step-status.pending {
      background: var(--warning-color);
    }

    .step-status.error {
      background: var(--danger-color);
    }

    /* Flow Visualization */
    .flow-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .flow-step {
      background: white;
      border-radius: 16px;
      padding: 15px 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 600px;
      position: relative;
      transition: all 0.3s;
      border: 1px solid #f0f0f0;
    }

    .flow-step:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 153, 255, 0.15);
      border-color: rgba(0, 153, 255, 0.2);
    }

    .flow-step-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .flow-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .flow-icon.source {
      background: linear-gradient(135deg, var(--primary-color) 0%, #0066CC 100%);
    }

    .flow-icon.transform {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #5a9216 100%);
    }

    .flow-icon.load {
      background: linear-gradient(135deg, #4facfe 0%, var(--primary-color) 100%);
    }

    .flow-icon.execute {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #38d97b 100%);
    }

    .flow-icon.monitor {
      background: linear-gradient(135deg, var(--accent-color) 0%, #34495e 100%);
    }

    .arrow-connector {
      font-size: 32px;
      color: var(--primary-color);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: translateY(0);
        opacity: 1;
      }

      50% {
        transform: translateY(8px);
        opacity: 0.6;
      }
    }

    /* Theme Styles for DW/DM */
    .theme-silver {
      color: #6c757d !important;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-left: 4px solid #6c757d;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .theme-gold {
      color: #b78900 !important;
      background: linear-gradient(135deg, #fff9db 0%, #fff3cd 100%);
      border-left: 4px solid #ffc107;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .badge-silver {
      background-color: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      display: inline-block;
    }

    .badge-gold {
      background-color: #ffc107;
      color: #000;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      display: inline-block;
    }

    /* Custom Design Type Buttons */
    .btn-custom-dw,
    .btn-custom-dm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 500;
      border: 1px solid var(--border-dark);
      border-radius: 6px;
      background: white;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.7;
    }

    .btn-custom-dw:hover,
    .btn-custom-dm:hover {
      background: var(--bg-tertiary);
      opacity: 1;
    }

    /* Active States */
    .btn-check:checked+.btn-custom-dw {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      /* Premium Slate Gradient */
      color: white;
      border-color: #475569;
      opacity: 1;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(71, 85, 105, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .btn-check:checked+.btn-custom-dm {
      background: #ffc107;
      /* Gold */
      color: black;
      border-color: #ffc107;
      opacity: 1;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* Dark Mode Overrides */
    [data-theme="dark"] .btn-custom-dw,
    [data-theme="dark"] .btn-custom-dm {
      background: var(--bg-secondary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .btn-check:checked+.btn-custom-dw {
      background: #495057;
      border-color: #6c757d;
    }

    [data-theme="dark"] .btn-check:checked+.btn-custom-dm {
      background: #ffca2c;
      /* Brighter Gold */
      color: black;
    }

    /* Visual Designer Styles */
    .designer-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .table-selector {
      background: white;
      border-radius: 12px;
      padding: 10px;
      border: 2px solid #bdc3c7;
      max-height: 660px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .table-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid var(--primary-color);
    }

    .table-item:hover {
      background: rgba(25, 118, 210, 0.08);
      transform: translateX(5px);
      border-left-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
    }

    .table-item.selected {
      background: rgba(67, 160, 71, 0.08);
      border-left-color: var(--success-color);
      font-weight: 600;
    }

    .designer-canvas {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      min-height: 300px;
      border: 2px solid #bdc3c7;
      position: relative;
    }

    .table-card {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .table-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid #e9ecef;
    }

    .table-card-title {
      font-weight: 700;
      color: #333;
      font-size: 15px;
    }



    .column-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .preview-table-container {
      max-height: 200px;
      overflow: auto;
      margin-top: 15px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .preview-table-container table {
      margin-bottom: 0;
    }

    .preview-table-container th {
      background-color: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .column-item {
      padding: 8px 12px;
      margin-bottom: 5px;
      background: #f8f9fa;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .column-schema-row {
      padding: 0px 4px;
      margin-bottom: 0;
      border-radius: 4px;
      min-height: 24px;
      transition: all 0.2s;
      /* Ensure inner flex container takes full width */
      display: block;
    }

    .column-item:hover,
    .column-schema-row:hover {
      background: #e9ecef;
    }

    .column-checkbox {
      margin-right: 6px;
      transform: scale(0.85);
    }

    .join-connector {
      display: flex;
      align-items: center;
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid var(--secondary-color);
    }

    .join-config {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      width: -webkit-fill-available;
    }

    .transform-section {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .transform-section.target-config {
      background: linear-gradient(to right, #f0f9ff 0%, #f0fdf4 100%);
      border: 2px solid var(--primary-color);
      border-left: 5px solid var(--primary-color);
    }

    .transform-section.target-config h6 {
      color: var(--accent-color);
    }

    .computed-column {
      background: #fff3cd;
      border-left: 4px solid var(--warning-color);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .connection-form {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .connection-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .connection-status.connected {
      background: var(--success-color);
      box-shadow: 0 0 8px var(--success-color);
    }

    .connection-status.disconnected {
      background: var(--danger-color);
    }

    /* Horizontal Stepper Styles */
    .stepper-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
      padding: 0 20px;
    }

    .stepper-header::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
      transform: translateY(-50%);
    }

    .stepper-step {
      position: relative;
      z-index: 1;
      background: white;
      padding: 8px 15px;
      min-width: 140px;
      /* Enforce uniform width */
      border-radius: 30px;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 150px;
      justify-content: center;
    }

    .stepper-step:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stepper-step.active {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 153, 255, 0.3);
    }

    .stepper-step.completed {
      border-color: var(--success-color);
      color: var(--success-color);
    }

    .stepper-step.completed .step-icon {
      background: var(--success-color);
      color: white;
    }

    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #666;
      transition: all 0.3s;
    }

    .stepper-step.active .step-icon {
      background: white;
      color: var(--primary-color);
    }

    .step-label {
      font-weight: 600;
      font-size: 14px;
    }

    .step-content-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      border: 1px solid #f0f0f0;
      min-height: 200px;
      /* Reduced from 400px to avoid excessive whitespace */
    }

    .step-pane {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
    }

    .step-pane.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Hide original flow elements */
    .flow-step,
    .arrow-connector {
      display: none !important;
    }

    /* D3 Lineage Graph Styles */
    .node rect {
      cursor: pointer;
      transition: all 0.3s;
    }

    .node:hover rect {
      filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
      stroke: var(--primary-color);
      stroke-width: 2px;
    }

    .node text {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      pointer-events: none;
    }

    /* Flow Animation */
    @keyframes flow {
      from {
        stroke-dashoffset: 24;
      }

      to {
        stroke-dashoffset: 0;
      }
    }

    .link {
      fill: none;
      stroke-opacity: 0.6;
      transition: all 0.3s;
      stroke-dasharray: 12 4;
      animation: flow 1.5s linear infinite;
      stroke-linecap: round;
    }

    .link:hover {
      stroke-opacity: 1;
      stroke-width: 4px !important;
      /* Force width on hover */
      animation-duration: 0.5s;
      /* Speed up on hover */
      filter: drop-shadow(0 0 5px rgba(33, 150, 243, 0.5));
    }

    .d3-tooltip {
      position: absolute;
      text-align: left;
      padding: 12px;
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      pointer-events: none;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      font-size: 0.85rem;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
      min-width: 200px;
    }

    .d3-tooltip h6 {
      margin-bottom: 5px;
      color: var(--primary-dark);
      font-weight: 700;
    }

    /* Accordion Styles */
    details.transform-section summary {
      position: relative;
      padding-left: 30px;
    }

    details.transform-section summary::before {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%) rotate(-90deg);
      transition: transform 0.3s ease;
      color: var(--primary-color);
      font-size: 14px;
    }

    details.transform-section[open] summary::before {
      transform: translateY(-50%) rotate(0deg);
    }

    details.transform-section summary::-webkit-details-marker {
      display: none;
    }

    /* File Drop Zone Styles */
    .designer-canvas {
      position: relative;
    }

    .designer-canvas.drag-over {
      background: linear-gradient(135deg, rgba(0, 153, 255, 0.1) 0%, rgba(122, 193, 67, 0.1) 100%);
      border-color: var(--primary-color);
      border-style: solid;
    }

    .file-drop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 153, 255, 0.05);
      border: 3px dashed var(--primary-color);
      border-radius: 12px;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: none;
    }

    .file-drop-overlay.active {
      display: flex;
    }

    .file-drop-content {
      text-align: center;
      color: var(--primary-color);
    }

    .file-drop-content i {
      font-size: 48px;
      margin-bottom: 15px;
      animation: bounce 1s infinite;
    }

    /* Clean Sidebar Tabs */
    .nav-tabs-clean {
      border-bottom: 2px solid #f0f0f0;
    }

    .nav-tabs-clean .nav-link {
      border: none;
      color: #6c757d;
      font-weight: 500;
      font-size: 0.9rem;
      padding-bottom: 8px;
      background: transparent;
      margin-right: 15px;
      padding-left: 0;
      padding-right: 0;
    }

    .nav-tabs-clean .nav-link:hover {
      color: var(--primary-color);
    }

    .nav-tabs-clean .nav-link.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      background: transparent;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .table-card.file-source {
      border-left: 4px solid var(--file-source-border);
      background: linear-gradient(to right, var(--file-source-bg) 0%, #ffffff 100%);
    }

    .table-card.file-source .table-card-title::before {
      content: '\f15b';
      font-family: 'Font Awesome 6 Free';
      font-weight: 400;
      margin-right: 8px;
      color: var(--warning-color);
    }

    .file-info {
      font-size: 0.75rem;
      color: #666;
      margin-top: 5px;
    }

    /* Canvas Help Styles */
    .canvas-help-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 45px 20px;
    }

    .canvas-help-icon {
      transform: rotate(-90deg);
      color: var(--primary-color);
      animation: pointLeft 3s ease-in-out infinite;
    }

    @keyframes pointLeft {

      0%,
      100% {
        transform: rotate(-90deg) translateY(0);
      }

      50% {
        transform: rotate(-90deg) translateY(-200px);
      }
    }

    .canvas-help-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    .help-steps {
      text-align: left;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color);
    }

    .help-step {
      display: flex;
      align-items: start;
      gap: 12px;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .help-step:hover {
      background: var(--bg-secondary);
      transform: translateX(5px);
    }

    .help-step:last-child {
      margin-bottom: 0;
    }

    .help-step-icon {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }

    .help-step-icon.step-1 {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    }

    .help-step-icon.step-2 {
      background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-light) 100%);
    }

    .help-step-icon.step-3 {
      background: linear-gradient(135deg, var(--warning-color) 0%, #FFA726 100%);
    }

    .help-step-content {
      flex: 1;
    }

    .help-step-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    .help-step-desc {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.5;
      margin: 0;
    }

    .help-tip {
      background: linear-gradient(135deg, #E3F2FD 0%, #F0F9FF 100%);
      border-left: 4px solid var(--info-color);
      padding: 12px 15px;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .help-tip i {
      color: var(--info-color);
      margin-right: 8px;
    }

    .table-card.file-source .column-item label {
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
      display: block;
    }

    .table-card.file-source .preview-table-container th {
      word-break: break-word;
      max-width: 200px;
      white-space: normal;
      font-size: 0.75rem;
    }

    .table-card.file-source .preview-table-container td {
      word-break: break-word;
      max-width: 200px;
      white-space: normal;
      font-size: 0.75rem;
    }



    /* Join Connector Styles */

    /* Target Role Toggle Buttons */
    .target-role-toggle {
      display: inline-flex;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 3px;
      gap: 3px;
      border: 1px solid var(--border-color);
    }

    .role-btn {
      padding: 5px 12px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .role-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .role-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .role-btn.active {
      color: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    /* Lookup - Blue */
    .role-btn.active.lookup {
      background: linear-gradient(135deg, #039BE5 0%, #0277BD 100%);
    }

    /* Dimension - Purple */
    .role-btn.active.dimension {
      background: linear-gradient(135deg, #8E24AA 0%, #6A1B9A 100%);
    }

    /* Fact - Green */
    .role-btn.active.fact {
      background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
    }

    .role-btn i {
      font-size: 0.7rem;
    }

    /* Join Connector Styles */
    .join-connector {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin: 15px auto;
      /* Centered */
      position: relative;
      width: 98%;
      /* Force full width usage */
      min-width: 800px;
      /* Prevent squishing */
    }

    .join-connector::before {
      content: 'â¬‡';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      color: var(--primary-color);
    }

    .join-config {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .join-config span {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .join-config select {
      font-size: 0.85rem;
    }

    /* Modern Transformation Buttons */
    .transformation-buttons-container {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .transformation-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #ffffff;
      border: 1.5px dashed #d0d0d0;
      border-radius: 8px;
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .transformation-btn i {
      font-size: 1.1rem;
      color: #9333ea;
    }

    .transformation-btn:hover {
      border-color: #9333ea;
      border-style: solid;
      background: #faf5ff;
      color: #7c3aed;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(147, 51, 234, 0.1);
    }

    .transformation-btn:active {
      transform: translateY(0);
    }

    /* Transformation item cards */
    .transformation-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
    }

    .transformation-item:hover {
      border-color: #9333ea;
      box-shadow: 0 2px 8px rgba(147, 51, 234, 0.1);
    }

    /* Flow Arrows between buttons */
    .flow-arrow {
      color: #9333ea;
      /* Using the theme purple */
      font-size: 1.2rem;
      padding: 0 10px;
      opacity: 0.7;
      animation: pulseFlow 2s infinite ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes pulseFlow {

      0%,
      100% {
        transform: translateX(0);
        opacity: 0.5;
        color: #d8b4fe;
      }

      50% {
        transform: translateX(3px);
        opacity: 1;
        color: #9333ea;
      }
    }

    .transformation-buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      /* Reduced gap since arrows take space */
      margin-bottom: 10px;
      align-items: center;
    }

    /* --- New Join UI Styles --- */
    .join-logic-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100px;
    }

    .join-logic-select {
      appearance: none;
      -webkit-appearance: none;
      background-color: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary-color);
      text-align: center;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }

    .join-logic-select:hover {
      background-color: #e2e8f0;
      border-color: #94a3b8;
    }

    .join-logic-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
      border-color: var(--primary-color);
    }

    .join-logic-static {
      font-size: 0.75rem;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      background: #f8fafc;
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
      width: 100%;
      text-align: center;
    }

    .join-row {
      background: white;
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 4px;
      transition: all 0.2s;
    }

    .join-row:hover {
      border-color: #e2e8f0;
      background: #f8fafc;
    }

    .join-column-select {
      height: 24px;
      font-size: 0.75rem;
      padding: 0 24px 0 8px;
      /* space for arrow */
      background-position: right 4px center;
      /* adjust arrow position if needed */
    }

    /* Connection Setup Styles */
    .connection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      padding: 10px 0;
    }

    .connection-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    [data-theme="dark"] .connection-card {
      background: var(--bg-secondary);
      border-color: var(--border-color);
    }

    .connection-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      z-index: 1;
    }

    .connection-card.selected {
      border-color: var(--primary-color);
      background: rgba(var(--primary-rgb, 25, 118, 210), 0.1);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 25, 118, 210), 0.3);
      transform: translateY(-2px);
    }

    .check-indicator {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary-color);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .connection-card.selected .check-indicator {
      display: flex;
    }

    .connection-icon {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 15px;
    }

    .connection-icon-placeholder {
      width: 60px;
      height: 60px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      color: #757575;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .connection-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
      font-size: 0.95rem;
    }

    .connection-type {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .connection-card.recommended {
      border: 1px solid var(--primary-color);
      background: rgba(var(--primary-rgb, 25, 118, 210), 0.02);
      box-shadow: 0 4px 12px rgba(var(--primary-rgb, 25, 118, 210), 0.15);
    }

    .recommended-badge {
      position: absolute;
      top: -10px;
      right: 15px;
      background: var(--primary-color);
      color: white;
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 2;
      text-transform: uppercase;
    }

    .connection-option {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 15px;
      cursor: pointer;
      pointer-events: auto;
      /* Ensure clickable */
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .connection-option:hover {
      border-color: var(--primary-color);
      background: #f8fafc;
    }

    .connection-option.selected {
      border-color: var(--primary-color);
      background: rgba(var(--primary-rgb, 25, 118, 210), 0.08);
      box-shadow: 0 0 0 2px rgba(var(--primary-rgb, 25, 118, 210), 0.2);
    }

    .connection-option .option-icon {
      font-size: 1.25rem;
      color: var(--primary-color);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(var(--primary-rgb, 25, 118, 210), 0.1);
      border-radius: 6px;
    }

    .connection-option .check-circle {
      margin-left: auto;
      width: 20px;
      height: 20px;
      border: 2px solid #cbd5e1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .connection-option.selected .check-circle {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    .connection-option .check-circle::after {
      content: '\f00c';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      color: white;
      font-size: 10px;
      display: none;
    }

    .connection-option.selected .check-circle::after {
      display: block;
    }

    @keyframes pointLeft {

      0%,
      100% {
        transform: translateX(0);
      }

      50% {
        transform: translateX(-10px);
      }
    }

    .animate-point-left {
      animation: pointLeft 1.5s infinite ease-in-out;
    }

    /* Connection Summary Sidebar Styles */
    :root {
      --primary-light: #e7f1ff;
      /* Light blue */
      --warning-light: #fff9e6;
      /* Light yellow */
    }

    .active-source {
      background-color: var(--primary-light) !important;
      border-right: 4px solid var(--primary-color) !important;
      color: var(--primary-color) !important;
    }

    /* Ensure inner text inherits color or is explicitly set */
    .active-source .fw-bold {
      color: #0d6efd !important;
    }

    .active-source .text-muted {
      color: #495057 !important;
      opacity: 0.8;
    }

    .active-target {
      background-color: var(--warning-light) !important;
      border-right: 4px solid #ffc107 !important;
      color: #856404 !important;
    }

    .active-target .fw-bold {
      color: #856404 !important;
    }

    .active-target .text-muted {
      color: #6c757d !important;
      opacity: 0.8;
    }

    .icon-box {
      transition: all 0.3s ease;
    }

    /* FIX: Ensure non-active tab panes are properly hidden and don't take up space */
    .tab-content .tab-pane:not(.active) {
      display: none !important;
    }

    /* ID-SPECIFIC OVERRIDE: Double guarantee for connection/workspace tabs */
    #connections:not(.active),
    #workspace:not(.active) {
      display: none !important;
    }

    /* Workspace Tree Sidebar Styles */
    .workspace-tree {
      position: relative;
    }

    .workspace-tree .list-group-item {
      position: relative;
      padding: 12px 16px 12px 45px !important;
      /* Increased padding for click target */
      border: none;
      background: transparent;
      color: #495057;
      /* Darker grey for better contrast */
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 2px;
      border-radius: 4px;
      /* Slight rounding */
    }

    .workspace-tree .list-group-item:hover {
      background-color: #f1f3f5;
      color: #0d6efd;
    }

    .workspace-tree .list-group-item.active {
      background-color: #e7f1ff;
      /* Light blue background */
      color: #0d6efd;
      font-weight: 600;
    }

    /* Vertical line - Continuous */
    .workspace-tree::before {
      content: "";
      position: absolute;
      top: 15px;
      bottom: 25px;
      left: 20px;
      border-left: 1px solid #dee2e6;
      z-index: 1;
    }

    /* Hide per-item vertical line to rely on container line */
    .workspace-tree .list-group-item::before {
      display: none;
    }

    /* Horizontal connector */
    .workspace-tree .list-group-item::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 20px;
      width: 18px;
      /* Slightly longer to reach text */
      border-top: 1px solid #dee2e6;
      z-index: 2;
    }

    /* Connector Node (Dot) */
    .workspace-tree .list-group-item .tree-node {
      position: absolute;
      left: 15px;
      /* Centered on vertical line */
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #adb5bd;
      z-index: 3;
      transition: all 0.2s;
    }

    .workspace-tree .list-group-item:hover .tree-node {
      border-color: #0d6efd;
      background: #e7f1ff;
    }

    .workspace-tree .list-group-item.active .tree-node {
      border-color: #0d6efd;
      background: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }

    /* Lake Configuration Card Styles */
    .lake-card {
      border: 1px solid #e9ecef;
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .lake-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      border-color: #0d6efd;
    }

    .lake-card.selected {
      border-color: #0d6efd;
      background-color: #f0f7ff;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    /* Transformation Buttons Compact Styles */
    .transformation-buttons-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .transformation-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      background: white;
      color: #6c757d;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .transformation-btn:hover {
      background: var(--primary-light);
      border-color: var(--primary-color);
      color: var(--primary-color);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .flow-arrow {
      color: #adb5bd;
      font-size: 0.75rem;
      margin: 0 2px;
    }

    /* === Long Table Name Handling === */
    /* === Long Table Name Handling (Refactored for Flexbox) === */
    .table-item>div {
      display: flex;
      align-items: center;
      width: 100%;
      overflow: hidden;
      /* Needed for text truncation within flex items */
    }

    /* The name container (strong) should take available space and truncate */
    .table-item strong {
      flex: 1;
      min-width: 0;
      /* Crucial for text-overflow in flexbox */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 4px;
      /* Space before potential badge */
    }

    /* Icons and Badges should not shrink */
    .table-item .badge,
    .table-item i {
      flex-shrink: 0;
    }

    .table-item small {
      display: block;
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Hover State: Expand long names if needed, or keep generic hover effect */
    .table-item:hover {
      position: relative;
      z-index: 100;
      background: #f8f9fa;
      /* Optional: We can choose to expand on hover or just show tooltip. 
           For now, let's keep the flex layout stable on hover but possibly expand height if wrapped?
           Actually, the user liked the hover-expand behavior, let's try to preserve it but ensure badges are visible by default. 
        */
      overflow: visible;
    }

    /* When hovering, let the text wrap IF it was truncated? 
       Actually, switching from flex ellipsis to normal wrapping on hover can be jumpy.
       For now, let's PRIORITIZE visibility of the badge. */
    .table-item:hover strong {
      /* Optional: overflow: visible; white-space: normal; */
    }

    .table-item:hover {
      background: #f8f9fa;
      position: relative;
      z-index: 1000;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap !important;
      display: inline-block;
    }

    .card-title:hover {
      max-width: none;
      white-space: normal !important;
      overflow: visible;
    }

    code {
      word-break: break-word;
      white-space: pre-wrap;
    }

    [data-theme="dark"] .table-item:hover {
      background: var(--bg-secondary);
    }

    /* === End Long Table Name Handling === */

    /* FORCE VISIBILITY FOR DM ROLE BADGE */
    .dm-role-badge,
    .sidebar-role-badge {
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* =========================================================================
       PRODUCTION MODAL STYLES â€” Workflow & Transform Config
       ========================================================================= */

    /* Modal Header â€” Premium Gradient */
    #workflowSummaryModal .modal-header {
      background: linear-gradient(135deg, #f8f9fc 0%, #eef1f7 100%);
      border-bottom: 1px solid #e2e6ed;
      padding: 1.25rem 1.5rem;
    }

    #workflowSummaryModal .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: #1a1f36;
    }

    #workflowSummaryModal .modal-title i {
      font-size: 1.1rem;
    }

    /* Modal Footer â€” Premium Actions */
    #workflowSummaryModal .modal-footer {
      background: #fafbfc;
      border-top: 1px solid #e8ecf0;
      padding: 0.875rem 1.5rem;
      gap: 0.5rem;
    }

    #workflowSummaryModal .modal-footer .btn-secondary {
      background: white;
      color: #495057;
      border: 1px solid #d1d5db;
      font-weight: 500;
      padding: 0.5rem 1.25rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    #workflowSummaryModal .modal-footer .btn-secondary:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    #workflowSummaryModal .modal-footer .btn-primary {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      border: none;
      font-weight: 600;
      padding: 0.5rem 1.5rem;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(5, 150, 105, 0.25);
      transition: all 0.2s;
    }

    #workflowSummaryModal .modal-footer .btn-primary:hover {
      background: linear-gradient(135deg, #047857 0%, #065f46 100%);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.35);
      transform: translateY(-1px);
    }

    /* Tab Overrides for Modal Tabs */
    #workflowTabs {
      background: #f8f9fc;
      border-bottom: 2px solid #e8ecf0;
      padding-bottom: 0 !important;
    }

    #workflowTabs .nav-link {
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      border: none;
      border-bottom: 2px solid transparent;
      border-radius: 0;
      padding: 0.75rem 1.25rem;
      margin-bottom: -2px;
      transition: all 0.25s ease;
    }

    #workflowTabs .nav-link:hover {
      color: #334155;
      border-bottom-color: #cbd5e1;
      background: transparent;
    }

    #workflowTabs .nav-link.active {
      color: #2563eb;
      background: transparent;
      border: none;
      border-bottom: 2px solid #2563eb;
      border-top: none;
      font-weight: 600;
      box-shadow: none;
    }

    #workflowTabs .nav-link i {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    #workflowTabs .nav-link.active i {
      opacity: 1;
    }

    /* Dark Code Viewer â€” JSON/YAML */
    #workflowSummaryModal pre {
      background: #1e293b !important;
      color: #e2e8f0;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 1.25rem !important;
      font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.82rem;
      line-height: 1.7;
      max-height: 500px;
      overflow-y: auto;
      position: relative;
      tab-size: 2;
      -moz-tab-size: 2;
    }

    #workflowSummaryModal pre::-webkit-scrollbar {
      width: 6px;
    }

    #workflowSummaryModal pre::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 3px;
    }

    #workflowSummaryModal pre::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }

    #workflowSummaryModal pre::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* Copy Button â€” Positioned inside code blocks */
    #workflowSummaryModal .position-relative>.btn-outline-primary {
      background: rgba(255, 255, 255, 0.08);
      color: #94a3b8;
      border: 1px solid #475569;
      border-radius: 6px;
      font-size: 0.75rem;
      padding: 0.35rem 0.65rem;
      backdrop-filter: blur(4px);
      transition: all 0.2s;
      z-index: 10;
    }

    #workflowSummaryModal .position-relative>.btn-outline-primary:hover {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    /* Copy Success State */
    #workflowSummaryModal .position-relative>.btn-outline-primary.copied {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border-color: #10b981;
    }

    /* Narrative Section â€” Accent Borders */
    #workflowNarrativeContent h6.fw-bold {
      font-size: 0.9rem;
      color: #334155;
      letter-spacing: 0.01em;
    }

    #workflowNarrativeContent .bg-light {
      background: #f8fafc !important;
      border: 1px solid #e8ecf0;
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
    }

    #workflowNarrativeContent p {
      font-size: 0.9rem;
      color: #475569;
      line-height: 1.65;
    }

    #workflowNarrativeContent code {
      background: #eef2ff;
      color: #4338ca;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.82rem;
      font-weight: 500;
    }

    #workflowNarrativeContent ul {
      padding-left: 1.25rem;
    }

    #workflowNarrativeContent li {
      font-size: 0.875rem;
      color: #475569;
      padding: 0.2rem 0;
    }

    /* Select Jobs Tab â€” Card Style Checkboxes */
    #workflowJobList .list-group-item {
      border: 1px solid #e8ecf0;
      border-radius: 8px !important;
      margin-bottom: 0.5rem;
      padding: 0.875rem 1rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    #workflowJobList .list-group-item:hover {
      background: #f8fafc;
      border-color: #3b82f6;
      box-shadow: 0 1px 4px rgba(59, 130, 246, 0.1);
    }

    #workflowJobList .form-check-input:checked {
      background-color: #2563eb;
      border-color: #2563eb;
    }

    #workflowJobList .form-check-input {
      width: 1.15em;
      height: 1.15em;
      border: 2px solid #cbd5e1;
      border-radius: 4px;
      transition: all 0.15s;
    }

    /* Select Jobs Info Alert */
    #workflow-jobs .alert-info {
      background: #eff6ff !important;
      border-left: 3px solid #3b82f6 !important;
      color: #1e40af;
      border-radius: 6px;
    }

    /* Modal Content Border Radius */
    #workflowSummaryModal .modal-content {
      border-radius: 12px;
      overflow: hidden;
      border: none;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12), 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    /* Dark theme overrides */
    [data-theme="dark"] #workflowSummaryModal .modal-header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-bottom-color: #334155;
    }

    [data-theme="dark"] #workflowSummaryModal .modal-title {
      color: #f1f5f9;
    }

    [data-theme="dark"] #workflowSummaryModal .modal-footer {
      background: #1e293b;
      border-top-color: #334155;
    }

    [data-theme="dark"] #workflowTabs {
      background: #1e293b;
      border-bottom-color: #334155;
    }

    [data-theme="dark"] #workflowTabs .nav-link {
      color: #94a3b8;
    }

    [data-theme="dark"] #workflowTabs .nav-link.active {
      color: #60a5fa;
      border-bottom-color: #3b82f6;
    }

    [data-theme="dark"] #workflowNarrativeContent .bg-light {
      background: #1e293b !important;
      border-color: #334155;
    }

    [data-theme="dark"] #workflowNarrativeContent p,
    [data-theme="dark"] #workflowNarrativeContent li {
      color: #cbd5e1;
    }

    [data-theme="dark"] #workflowNarrativeContent h6.fw-bold {
      color: #e2e8f0;
    }

    [data-theme="dark"] #workflowNarrativeContent code {
      background: #312e81;
      color: #a5b4fc;
    }

    [data-theme="dark"] #workflowJobList .list-group-item {
      background: #0f172a;
      border-color: #334155;
      color: #e2e8f0;
    }

    [data-theme="dark"] #workflowJobList .list-group-item:hover {
      background: #1e293b;
    }

    [data-theme="dark"] #workflowSummaryModal .modal-content {
      background: #0f172a;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>

<body>

  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="logo-container">
          <div class="logo-text">
            <span class="logo-an">Anviz</span><span class="logo-viz">e</span><span class="logo-gnt">nt</span>
          </div>
        </div>
        <div class="header-title-section">
          <h1><i class="fas fa-database"></i> Databricks ELT Platform</h1>
          <div class="header-subtitle">Enterprise Data Warehouse to Data Mart Pipeline</div>
        </div>
      </div>

      <div class="user-info">
        <!-- Theme Switch -->
        <div class="theme-switch-wrapper">
          <i class="fas fa-sun theme-icon"></i>
          <label class="theme-switch" for="theme-checkbox">
            <input type="checkbox" id="theme-checkbox" onchange="toggleTheme()">
            <div class="slider"></div>
          </label>
          <i class="fas fa-moon theme-icon"></i>
        </div>

        <!-- User Profile Pill -->
        <div class="user-profile-pill" title="User Profile">
          <div class="user-details d-none d-md-block">
            <span class="user-name">Partner Admin</span>
            <span class="user-role">partner_id: 12345</span>
          </div>
          <div class="user-avatar">
            PA
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Navigation -->
  <ul class="nav nav-tabs nav-tabs-custom" id="mainTabs" role="tablist">
    <li class="nav-item">

      <a class="nav-link active" id="workflow-tab" data-bs-toggle="tab" href="#workflow" role="tab">
        <i class="fas fa-project-diagram"></i> Configure Pipeline
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="jobs-tab" data-bs-toggle="tab" href="#jobs" role="tab">
        <i class="fas fa-tasks"></i> Jobs & Execution
      </a>
    </li>

    <li class="nav-item">
      <a class="nav-link" id="lineage-tab" data-bs-toggle="tab" href="#lineage" role="tab">
        <i class="fas fa-code-branch"></i> Data Lineage
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="monitoring-tab" data-bs-toggle="tab" href="#monitoring" role="tab">
        <i class="fas fa-tachometer-alt"></i> Monitoring
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="connections-tab" data-bs-toggle="tab" href="#connections" role="tab"
        onclick="loadConnectionSummaryPage()">
        <i class="fas fa-network-wired"></i> Configured Connections
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="workspace-tab" data-bs-toggle="tab" href="#workspace" role="tab">
        <i class="fas fa-layer-group text-primary"></i> Workspace / Platform Setup
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content content-area" id="mainTabContent">
    <!-- Workflow Tab -->
    <div class="tab-pane fade show active" id="workflow" role="tabpanel">
      <h3 class="mb-2"><i class="fas fa-cogs"></i> Interactive Data Pipeline Flow</h3>

      <div class="stepper-header">
        <div class="stepper-step active" onclick="activateStep('connect')">
          <div class="step-icon"><i class="fas fa-plug"></i></div>
          <div class="step-label">Source</div>
        </div>
        <div class="step-line"></div>
        <div class="stepper-step" onclick="activateStep('metadata')">
          <div class="step-icon"><i class="fas fa-search-plus"></i></div>
          <div class="step-label">Metadata</div>
        </div>
        <div class="step-line"></div>
        <div class="stepper-step" onclick="activateStep('target')">
          <div class="step-icon"><i class="fas fa-bullseye"></i></div>
          <div class="step-label">Target</div>
        </div>
        <div class="step-line"></div>
        <div class="stepper-step" onclick="activateStep('transform')">
          <div class="step-icon"><i class="fas fa-drafting-compass"></i></div>
          <div class="step-label">Transform</div>
        </div>
        <div class="step-line"></div>
        <div class="stepper-step" onclick="activateStep('vcs')">
          <div class="step-icon"><i class="fab fa-github"></i></div>
          <div class="step-label">Review</div>
        </div>
        <div class="step-line"></div>
        <div class="stepper-step" onclick="activateStep('execute')">
          <div class="step-icon"><i class="fas fa-play"></i></div>
          <div class="step-label">Deploy</div>
        </div>
      </div>

      <div class="step-content-container">
        <!-- Step 1: Connect -->
        <div class="step-pane active" id="step-connect">

          <!-- Workspace Readiness Banner (Pre-flight Check) -->
          <div class="readiness-banner mb-4" id="workspaceReadinessBar">
            <div class="d-flex justify-content-between align-items-center p-3 rounded shadow-sm"
              style="background: linear-gradient(to right, #f8f9fa, #e9ecef); border-left: 5px solid #ffc107;">
              <div class="d-flex align-items-center">
                <div
                  class="icon-box bg-warning text-dark rounded-circle me-3 d-flex align-items-center justify-content-center"
                  style="width: 40px; height: 40px;">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div>
                  <h6 class="mb-0 fw-bold text-dark">Workspace Readiness Check</h6>
                  <small class="text-muted">Ensure all platform prerequisites are met before designing.</small>
                </div>
              </div>
              <div class="d-flex align-items-center gap-3">
                <!-- Lake Status -->
                <div class="d-flex align-items-center text-muted" id="status-lake">
                  <i class="fas fa-exclamation-circle text-warning me-2"></i> Lake Storage
                </div>
                <div class="vr mx-2"></div>
                <!-- Compute Status (Placeholder) -->
                <div class="d-flex align-items-center text-muted" id="status-compute">
                  <i class="fas fa-check-circle text-success me-2"></i> Compute
                </div>
                <div class="vr mx-2"></div>
                <!-- Gov Status (Placeholder) -->
                <div class="d-flex align-items-center text-muted" id="status-gov">
                  <i class="fas fa-check-circle text-success me-2"></i> Governance
                </div>

                <button class="btn btn-sm btn-primary ms-3 px-3 rounded-pill"
                  onclick="$('#mainTabs a[href=\'#workspace\']').tab('show')">
                  <i class="fas fa-cog me-2"></i> Configure Setup
                </button>
              </div>
            </div>
          </div>

          <!-- View 1: Connection Selection Grid -->
          <div id="connect-grid-view">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4><i class="fas fa-plug text-primary"></i> Configure Data Source</h4>
            </div>

            <div class="card">
              <div class="card-body">

                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="input-group">
                      <span class="input-group-text bg-white border-end-0"><i
                          class="fas fa-search text-muted"></i></span>
                      <input type="text" class="form-control border-start-0" id="connectionSearch"
                        placeholder="Type part of database/driver name to filter"
                        onkeyup="filterConnections(this.value)">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="document.getElementById('connectionSearch').value = ''; filterConnections('');">
                        <i class="fas fa-eraser"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6 d-flex justify-content-end align-items-center">
                    <span class="me-2 text-muted">Sort by:</span>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="sortOptions" id="sortTitle" value="title"
                        onchange="sortConnections('title')">
                      <label class="form-check-label" for="sortTitle">Title</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="sortOptions" id="sortScore" value="score"
                        checked onchange="sortConnections('score')">
                      <label class="form-check-label" for="sortScore">Score</label>
                    </div>
                  </div>
                </div>

                <div id="connectionsGrid" class="connection-grid">
                  <!-- Connections will be injected here via JS -->
                </div>
              </div>
            </div>
          </div>

          <!-- View 2: Connection Configuration Form -->
          <div id="connect-form-view" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" onclick="showConnectionGrid()">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <h4 class="mb-0"><i class="fas fa-plug text-primary"></i> Configure <span
                    id="selectedConnName">Connection</span></h4>
                <span class="badge bg-primary ms-3 shadow-sm">SOURCE</span>
                <span class="badge bg-light text-dark border ms-2 shadow-sm"><i
                    class="fas fa-exchange-alt text-success me-1"></i> Source & Target</span>
              </div>
              <button class="btn btn-primary" onclick="activateStep('metadata')">Next Step <i
                  class="fas fa-arrow-right"></i></button>
            </div>

            <div class="connection-form">
              <!-- Connection Mode Switch -->
              <div class="d-flex justify-content-center mb-2">
                <div class="btn-group btn-group-sm" role="group">
                  <input type="hidden" id="connectionRole" value="source">
                  <input type="radio" class="btn-check" name="connectionMode" id="modeApi" autocomplete="off" checked
                    onclick="toggleConnectionMode('api')">
                  <label class="btn btn-outline-primary" for="modeApi">API Connection</label>

                  <input type="radio" class="btn-check" name="connectionMode" id="modeJdbc" autocomplete="off"
                    onclick="toggleConnectionMode('jdbc')">
                  <label class="btn btn-outline-primary" for="modeJdbc">JDBC Connection</label>
                </div>
              </div>

              <!-- Connection Identity -->
              <div class="mb-3 p-2 bg-light border rounded">
                <div class="row g-2 align-items-center">
                  <div class="col-md-5">
                    <label class="form-label mb-0 small"><strong>Connection Name</strong> <span
                        class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm" id="connectionName"
                      placeholder="e.g., Production Data Warehouse" value="Demo Workspace Connection">
                  </div>
                  <div class="col-md-7">
                    <label class="form-label mb-0 small"><strong>Description</strong></label>
                    <input type="text" class="form-control form-control-sm" id="connectionDescription"
                      placeholder="e.g., Main source for daily usage">
                  </div>
                </div>
              </div>

              <!-- API Fields -->
              <div id="api-fields">
                <div class="mb-3">
                  <label class="form-label"><strong>Workspace URL</strong></label>
                  <input type="text" class="form-control" id="workspaceUrl"
                    placeholder="https://your-workspace.cloud.databricks.com"
                    value="https://demo-workspace.cloud.databricks.com">
                </div>
              </div>

              <!-- JDBC Fields -->
              <div id="jdbc-fields" style="display: none;">
                <div class="row">
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label class="form-label"><strong>Server Hostname</strong></label>
                      <input type="text" class="form-control" id="serverHost"
                        placeholder="adb-xxxxxxxx.xx.azuredatabricks.net">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"><strong>Port</strong></label>
                      <input type="text" class="form-control" id="serverPort" value="443">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label"><strong>HTTP Path</strong></label>
                  <input type="text" class="form-control" id="httpPath" placeholder="sql/protocolv1/o/xxxx/xxxx">
                </div>
              </div>

              <!-- Common Fields -->
              <div class="mb-3">
                <label class="form-label"><strong>Access Token</strong></label>
                <input type="password" class="form-control" id="accessToken"
                  placeholder="Enter your personal access token" value="dapi***************************">
              </div>

              <!-- Integration Options -->
              <!-- Integration Options -->
              <div class="mb-3 p-3 bg-light border rounded">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="useSourceForTarget" style="cursor: pointer;">
                  <label class="form-check-label fw-bold text-nowrap" for="useSourceForTarget" style="cursor: pointer;">
                    <i class="fas fa-bullseye text-primary me-1"></i> Use this connection for Target as well <span
                      class="fw-normal text-muted fst-italic ms-1" style="font-size: 0.9em;">(Ignore if target is
                      different)</span>
                  </label>
                  <div class="text-muted small ms-4">Automatically selects this connection when configuring the Target
                    step.</div>
                </div>
              </div>

              <div class="mb-3 text-center">
                <span class="connection-status disconnected" id="connectionStatus"></span>
                <span id="connectionText">Not Connected</span>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary flex-grow-1" onclick="testConnection()" id="btnTestConnection">
                  <i class="fas fa-plug"></i> Test Connection
                </button>
                <button class="btn btn-primary flex-grow-1" onclick="saveAndLoadMetadata()" id="btnSaveLoad">
                  <i class="fas fa-save"></i> Save & Next
                </button>
              </div>
            </div>
          </div> <!-- End of connect-form-view -->
        </div>

        <!-- Step 2: Metadata -->
        <div class="step-pane" id="step-metadata">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-download text-primary"></i> Load Metadata</h4>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="activateStep('connect')"><i
                  class="fas fa-arrow-left"></i> Previous</button>
              <button class="btn btn-primary" onclick="activateStep('target')">Next Step <i
                  class="fas fa-arrow-right"></i></button>
            </div>
          </div>

          <!-- Connection Selector -->
          <div class="card bg-light mb-3">
            <div class="card-body" style="padding: 10px 15px;">
              <div class="row align-items-end g-2">
                <div class="col-md-6">
                  <label class="form-label mb-1" style="font-size: 0.9rem;"><strong><i class="fas fa-plug"></i>
                      Connection</strong></label>
                  <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm" id="metaConnectionSelect" style="flex: 1;">
                      <option value="current" selected>Use Current Connection (demo-workspace)</option>
                      <option value="new">Configure New Connection...</option>
                      <option value="conn1">Production Workspace</option>
                      <option value="conn2">Development Workspace</option>
                      <option value="conn3">Staging Workspace</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="activateStep('connect')"
                      title="Go to Connection Setup">
                      <i class="fas fa-cog"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <small class="text-muted" style="font-size: 0.75rem;">
                    <i class="fas fa-info-circle"></i> Select a connection or configure a new one to load metadata
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Catalog & Schema Selection Section -->
          <div class="card bg-light mb-3">
            <div class="card-body">
              <div class="row align-items-end">
                <div class="col-md-4">
                  <label class="form-label"><strong>Select Catalog</strong></label>
                  <select class="form-select" id="metaCatalogSelect" onchange="updateSchemaOptions()">
                    <option value="main" selected>main</option>
                    <option value="analytics">analytics</option>
                    <option value="sandbox">sandbox</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label"><strong>Select Schema</strong></label>
                  <select class="form-select" id="metaSchemaSelect">
                    <option value="all" selected>All Schemas</option>
                    <option value="dw">dw</option>
                    <option value="dm">dm</option>
                    <option value="staging">staging</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <button class="btn btn-primary w-100" onclick="loadMetadata()">
                    <i class="fas fa-sync"></i> Fetch Metadata
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Catalog:</strong> <code id="metaCatalog">main</code></p>
              <p><strong>Schemas Loaded:</strong> <span id="schemaCount">3</span></p>
              <p><strong>Tables Loaded:</strong> <span id="tableCount">47</span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Storage Format:</strong> Delta Lake</p>
              <p><strong>Location:</strong> s3://databricks-warehouse/</p>
              <p><strong>Last Sync:</strong> <span id="lastSync">2025-11-03 20:43</span></p>
            </div>
          </div>
          <div id="metadataSuccessAlert" class="alert alert-success mt-3" style="display: none;">
            <i class="fas fa-check-circle"></i> <strong>Metadata Loaded Successfully</strong>
            <ul class="mb-0 mt-2">
              <li><code>main.dw</code> - 47 tables (customers, sales_orders, products, etc.)</li>
              <li><code>main.dm</code> - 23 tables</li>
              <li><code>main.staging</code> - 15 tables</li>
            </ul>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary btn-sm" onclick="loadMetadata()" style="display: none;">
              <i class="fas fa-sync"></i> Refresh Metadata
            </button>
            <button id="btnViewMetadataExplorer" class="btn btn-outline-primary" style="display: none;"
              onclick="showMetadataExplorer()">
              <i class="fas fa-sitemap me-1"></i> View Metadata Explorer
            </button>
          </div>
        </div>

        <!-- Metadata Explorer Modal -->
        <div class="modal fade" id="metadataExplorerModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="height: 85vh;">
              <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-sitemap text-primary me-2"></i>Metadata Explorer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-0">
                <div class="d-flex h-100">
                  <!-- Left Pane: Tree View -->
                  <div class="border-end bg-white" style="width: 35%; overflow-y: auto;">
                    <div class="p-3 bg-light border-bottom sticky-top">
                      <input type="text" class="form-control form-control-sm" placeholder="Filter objects..."
                        id="metaExplorerSearch">
                    </div>
                    <div class="p-2" id="metaExplorerTree">
                      <!-- Tree content will be injected here -->
                      <div class="text-center text-muted mt-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    </div>
                  </div>
                  <!-- Right Pane: Details View -->
                  <div class="flex-grow-1 bg-light" style="width: 65%; overflow-y: auto;">
                    <div id="metaDetailPane" class="p-4">
                      <div class="text-center text-muted" style="margin-top: 20%;">
                        <i class="fas fa-mouse-pointer fa-3x mb-3 text-secondary"></i>
                        <h5>Select an item to view details</h5>
                        <p>Click on a table or column in the tree view to inspect its properties.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Target Setup -->
        <div class="step-pane" id="step-target">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-bullseye text-primary"></i> Configure Target Source</h4>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="activateStep('metadata')"><i
                  class="fas fa-arrow-left"></i> Previous</button>
              <button class="btn btn-primary" onclick="activateStep('transform')">Next Step <i
                  class="fas fa-arrow-right"></i></button>
            </div>
          </div>

          <div class="card p-4">
            <div class="mb-4">
              <label class="form-label d-block fw-bold display-6 fs-5 mb-3">Connection Mode</label>
              <div class="row g-3 mb-4" id="targetModeGrid">
                <div class="col-md-4">
                  <div class="connection-option selected" onclick="selectTargetMode('same', this)">
                    <div class="option-icon"><i class="fas fa-redo"></i></div>
                    <div>
                      <div class="fw-bold text-dark" style="font-size: 0.95rem;">Use Source Connection</div>
                      <div class="text-muted small">Same as Source</div>
                    </div>
                    <div class="check-circle"></div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="connection-option" onclick="selectTargetMode('existing', this)">
                    <div class="option-icon"><i class="fas fa-list"></i></div>
                    <div>
                      <div class="fw-bold text-dark" style="font-size: 0.95rem;">Pick from Existing</div>
                      <div class="text-muted small">Workspace Config</div>
                    </div>
                    <div class="check-circle"></div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="connection-option" onclick="selectTargetMode('new', this)">
                    <div class="option-icon"><i class="fas fa-plus"></i></div>
                    <div>
                      <div class="fw-bold text-dark" style="font-size: 0.95rem;">New Connection</div>
                      <div class="text-muted small">Manual Setup</div>
                    </div>
                    <div class="check-circle"></div>
                  </div>
                </div>
              </div>

              <!-- Hidden Radio Inputs to maintain state logic if needed, or we rely purely on JS now -->
              <div class="d-none">
                <input type="radio" name="targetConnectionMode" id="targetConnSame" value="same" checked>
                <input type="radio" name="targetConnectionMode" id="targetConnExisting" value="existing">
                <input type="radio" name="targetConnectionMode" id="targetConnNew" value="new">
              </div>

              <small class="text-muted d-block mt-2" id="targetConnHelp"><i class="fas fa-info-circle me-1"></i> Using
                the same connection credentials defined in the Source Setup step.</small>
            </div>

            <!-- Existing Connection Selection -->
            <div id="targetConnSelectGroup" class="mb-4" style="display: none;">
              <label class="form-label fw-bold">Select Connection</label>
              <select class="form-select form-select-lg" id="targetConnectionSelect" disabled>
                <option value="current" selected>Current Workspace</option>
                <option value="conn1">Production DB</option>
                <option value="conn2">Staging DB</option>
              </select>
            </div>

            <!-- New Connection Inputs -->
            <div id="targetConnNewGroup" class="mb-4" style="display: none;">
              <!-- View 1: Grid Wrapper -->
              <div id="targetConnNewGridWrapper">
                <label class="form-label fw-bold mb-3">Select Connection Type</label>

                <!-- Added Search for Target -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="input-group">
                      <span class="input-group-text bg-white border-end-0"><i
                          class="fas fa-search text-muted"></i></span>
                      <input type="text" class="form-control border-start-0" id="targetConnectionSearch"
                        placeholder="Type part of database/driver name to filter"
                        onkeyup="filterTargetConnections(this.value)">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="document.getElementById('targetConnectionSearch').value = ''; filterTargetConnections('');">
                        <i class="fas fa-eraser"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <div id="targetNewConnGrid" class="connection-grid mb-4"></div>
              </div>

              <div id="targetConnNewFormWrapper" style="display:none;" class="border-top pt-3">
                <div class="d-flex align-items-center mb-3">
                  <button class="btn btn-outline-secondary btn-sm me-3" onclick="showTargetConnectionGrid()">
                    <i class="fas fa-arrow-left"></i> Back
                  </button>
                  <h6 class="fw-bold mb-0"><i class="fas fa-edit"></i> Configure <span
                      id="targetNewConnTypeLabel">Connection</span></h6>
                  <span class="badge bg-warning text-dark ms-auto shadow-sm">TARGET</span>
                </div>

                <div class="connection-form">
                  <!-- Connection Mode Switch -->
                  <div class="d-flex justify-content-center mb-2">
                    <div class="btn-group btn-group-sm" role="group">
                      <input type="hidden" id="targetConnectionRole" value="target">
                      <input type="radio" class="btn-check" name="targetConnectionModeSwitch" id="targetModeApi"
                        autocomplete="off" checked onclick="toggleTargetConnectionFormMode('api')">
                      <label class="btn btn-outline-primary" for="targetModeApi">API Connection</label>

                      <input type="radio" class="btn-check" name="targetConnectionModeSwitch" id="targetModeJdbc"
                        autocomplete="off" onclick="toggleTargetConnectionFormMode('jdbc')">
                      <label class="btn btn-outline-primary" for="targetModeJdbc">JDBC Connection</label>
                    </div>
                  </div>

                  <!-- Target Connection Identity -->
                  <div class="mb-3 p-2 bg-light border rounded">
                    <div class="row g-2 align-items-center">
                      <div class="col-md-5">
                        <label class="form-label mb-0 small"><strong>Connection Name</strong> <span
                            class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="targetConnectionName"
                          placeholder="e.g., Target Data Mart" value="Marketing Data Mart">
                      </div>
                      <div class="col-md-7">
                        <label class="form-label mb-0 small"><strong>Description</strong></label>
                        <input type="text" class="form-control form-control-sm" id="targetConnectionDescription"
                          placeholder="e.g., Destination for transformed marketing data">
                      </div>
                    </div>
                  </div>

                  <!-- API Fields -->
                  <div id="target-api-fields">
                    <div class="mb-3">
                      <label class="form-label small fw-bold">Workspace URL</label>
                      <input type="text" class="form-control" id="targetWorkspaceUrl"
                        placeholder="https://your-workspace.cloud.databricks.com">
                    </div>
                  </div>

                  <!-- JDBC Fields -->
                  <div id="target-jdbc-fields" style="display: none;">
                    <div class="row section-row">
                      <div class="col-md-8">
                        <div class="mb-3">
                          <label class="form-label small fw-bold">Server Hostname</label>
                          <input type="text" class="form-control" id="targetServerHost"
                            placeholder="adb-xxxxxxxx.xx.azuredatabricks.net">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label small fw-bold">Port</label>
                          <input type="text" class="form-control" id="targetServerPort" value="443">
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small fw-bold">HTTP Path</label>
                      <input type="text" class="form-control" id="targetHttpPath"
                        placeholder="sql/protocolv1/o/xxxx/xxxx">
                    </div>
                  </div>

                  <!-- Common Fields -->
                  <div class="mb-3">
                    <label class="form-label small fw-bold">Access Token</label>
                    <input type="password" class="form-control" id="targetAccessToken"
                      placeholder="Enter your personal access token">
                  </div>

                  <div class="mb-3 text-center">
                    <span class="connection-status disconnected" id="targetConnectionStatus"></span>
                    <span id="targetConnectionText">Not Connected</span>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary flex-grow-1" onclick="testTargetConnection()"
                      id="btnTestTargetConnection">
                      <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button class="btn btn-primary flex-grow-1" onclick="saveTargetConnection()" id="btnSaveTarget">
                      <i class="fas fa-save"></i> Save & Next
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="targetSchemaConfig">
              <div class="row g-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold fs-5">Target Catalog</label>
                  <select class="form-select form-select-lg" id="targetCatalog" onchange="updateTargetSchemaOptions()">
                    <option value="main" selected>main</option>
                    <option value="analytics">analytics</option>
                    <option value="sandbox">sandbox</option>
                  </select>
                  <div class="form-text">Top-level container for data assets</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold fs-5">Target Schema</label>
                  <select class="form-select form-select-lg" id="targetSchema" onchange="updateFullTargetPath()">
                    <option value="dm" selected>dm</option>
                    <option value="dw">dw</option>
                    <option value="staging">staging</option>
                  </select>
                  <div class="form-text">Organizational unit within catalog (Database)</div>
                </div>
              </div>

              <div class="mt-4 p-3 bg-light rounded text-center border-start border-4 border-primary">
                <span class="text-muted">Target Path Preview:</span> <code id="fullTargetPath"
                  class="fw-bold text-primary fs-5 ms-2">main.dm.table_name</code>
              </div>
            </div>

            <!-- Validation Error Area -->
            <div id="targetValidation" class="mt-3" style="display: none;"></div>
          </div>
        </div>

        <!-- Step 4: Build -->
        <div class="step-pane" id="step-transform">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-3">
              <h4><i class="fas fa-drafting-compass text-primary"></i> Visual Transformation Designer</h4>

              <!-- Compact Target Configuration Button -->
              <button class="btn btn-sm btn-outline-primary" onclick="activateStep('target')" id="targetConfigButton">
                <i class="fas fa-bullseye"></i>
                <span id="targetConfigLabel">Define Target</span>
              </button>
            </div>

            <div>
              <button class="btn btn-outline-secondary me-2" onclick="activateStep('target')"><i
                  class="fas fa-arrow-left"></i> Previous</button>
              <button class="btn btn-primary" onclick="activateStep('vcs')">Next Step <i
                  class="fas fa-arrow-right"></i></button>
            </div>
          </div>

          <!-- Target Path Display (Compact) -->
          <div id="targetPathDisplay" class="alert alert-info py-2 px-3 mb-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <i class="fas fa-database"></i>
                <strong>Target:</strong>
                <code id="compactTargetPath" class="text-primary">main.dm.table_name</code>
              </div>
              <button class="btn btn-sm btn-link text-primary p-0" onclick="activateStep('target')">
                <i class="fas fa-edit"></i> Edit
              </button>
            </div>
          </div>
          <div class="transform-section target-config mb-3" style="padding: 10px 12px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 theme-silver" style="font-size: 0.95rem;">
                <i class="fas fa-warehouse me-2" id="targetConfigIcon"></i> <span id="targetConfigTitle">Target Data
                  Warehouse
                  Configuration</span>
              </h6>
              <div id="designTypeBadge" class="badge badge-silver" style="font-size: 0.9rem; padding: 6px 12px;">
                ðŸ¢ Building: <strong>Data Warehouse</strong>
              </div>
            </div>

            <!-- Row 1: Connection, Design Type, Catalog -->
            <div class="row g-2 mb-2">
              <!-- Connection -->
              <div class="col-md-5">
                <label class="form-label mb-1" style="font-size: 0.85rem;"><strong><i class="fas fa-plug"></i>
                    Connection</strong></label>
                <div class="d-flex align-items-center gap-2">
                  <select class="form-select form-select-sm" id="designConnectionSelect" style="flex: 1;">
                    <option value="current" selected>Current: demo-workspace.cloud.databricks.com</option>
                    <option value="new">Configure New Connection...</option>
                    <option value="conn1">Production Workspace</option>
                    <option value="conn2">Development Workspace</option>
                    <option value="conn3">Staging Workspace</option>
                  </select>
                  <button class="btn btn-sm btn-outline-secondary" onclick="activateStep('connect')"
                    title="Go to Connection Setup">
                    <i class="fas fa-cog"></i>
                  </button>
                </div>
              </div>

              <!-- Design Type -->
              <div class="col-md-4">
                <label class="form-label mb-1" style="font-size: 0.85rem;"><strong>Design Type</strong></label>
                <div class="d-flex gap-2 w-100" role="group">
                  <div class="flex-grow-1">
                    <input type="radio" class="btn-check" name="designType" id="designTypeDW" autocomplete="off" checked
                      onchange="updateDesignType('dw')">
                    <label class="btn-custom-dw" for="designTypeDW">
                      <i class="fas fa-warehouse me-2"></i> Data Warehouse
                    </label>
                  </div>

                  <div class="flex-grow-1">
                    <input type="radio" class="btn-check" name="designType" id="designTypeDM" autocomplete="off"
                      onchange="updateDesignType('dm')">
                    <label class="btn-custom-dm" for="designTypeDM">
                      <i class="fas fa-chart-pie me-2"></i> Data Mart
                    </label>
                  </div>
                </div>
              </div>

              <!-- Catalog.Schema -->
              <div class="col-md-3">
                <label class="form-label mb-1" style="font-size: 0.85rem;"><strong>Catalog.Schema</strong></label>
                <select class="form-select form-select-sm" id="dmCatalog" onchange="generateSQL()">
                  <option value="main.dw" selected>main.dw</option>
                  <option value="main.staging">main.staging</option>
                  <option value="main.raw">main.raw</option>
                  <option value="analytics.dw">analytics.dw</option>
                </select>
              </div>
            </div>

            <!-- Row 2: Table Name, Description -->
            <div class="row g-2">
              <!-- Table Name -->
              <div class="col-md-4">
                <label class="form-label mb-1" style="font-size: 0.85rem;"><strong>Table Name <span
                      class="text-danger">*</span></strong></label>
                <input type="text" class="form-control form-control-sm" id="dmTableName"
                  placeholder="e.g., fact_sales, dim_customer" onkeyup="generateSQL()">
                <small class="text-muted" style="font-size: 0.7rem;">Full: <code id="fullTableName"
                    style="font-size: 0.7rem;">main.dw.sales_summary</code></small>
              </div>

              <!-- Description -->
              <div class="col-md-8">
                <label class="form-label mb-1" style="font-size: 0.85rem;"><strong>Description</strong></label>
                <input type="text" class="form-control form-control-sm" id="dmDescription"
                  placeholder="Optional description">
              </div>
            </div>

          </div>

          <!-- Visual Designer Interface -->
          <div class="designer-container">
            <!-- Left Panel: Table Selector -->
            <div class="table-selector" style="max-height: 600px; overflow-y: auto; overflow-x: auto;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="fas fa-table"></i> Available Tables</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="openAiBuilderModal()" data-bs-toggle="tooltip"
                  title="AI Data Builder">
                  <i class="fas fa-robot"></i>
                </button>
              </div>
              <input type="text" class="form-control form-control-sm mb-3" placeholder="Search tables..."
                onkeyup="filterTables(this.value)">

              <div id="tableList">
                <div class="table-item" onclick="addTableToCanvas('sales_orders')" data-table="sales_orders">
                  <div><span class="badge bg-primary me-2">SRC</span><strong>sales_orders</strong></div>
                  <small class="text-muted">crm.sales_orders</small>
                </div>
                <div class="table-item" onclick="addTableToCanvas('customers')" data-table="customers">
                  <div><span class="badge bg-primary me-2">SRC</span><strong>customers</strong></div>
                  <small class="text-muted">crm.customers</small>
                </div>
                <div class="table-item" onclick="addTableToCanvas('products')" data-table="products">
                  <div><span class="badge bg-primary me-2">SRC</span><strong>products</strong></div>
                  <small class="text-muted">erp.products</small>
                </div>
                <div class="table-item" onclick="addTableToCanvas('transactions')" data-table="transactions">
                  <div><span class="badge bg-primary me-2">SRC</span><strong>transactions</strong></div>
                  <small class="text-muted">finance.transactions</small>
                </div>
              </div>
            </div>

            <!-- Right Panel: Designer Canvas -->
            <div class="designer-canvas" id="designerCanvas" ondragover="handleDragOver(event)"
              ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)"
              style="overflow-y: auto; overflow-x: auto; position: relative;">

              <!-- File Drop Overlay -->
              <div class="file-drop-overlay" id="fileDropOverlay">
                <div class="file-drop-content">
                  <i class="fas fa-file-upload"></i>
                  <h5>Drop CSV or Excel file here</h5>
                  <p class="mb-0">Supported formats: .csv, .xlsx, .xls</p>
                </div>
              </div>

              <div class="canvas-help-container" id="emptyMessage">
                <div class="text-center mb-5">
                  <div class="canvas-icon-wrapper mb-3">
                    <i class="fas fa-hand-point-left fa-3x text-primary animate-point-left" style="opacity: 0.8;"></i>
                  </div>
                  <h4 class="fw-bold text-dark mb-2">Start Designing Your Pipeline</h4>
                  <p class="text-muted" style="max-width: 400px; margin: 0 auto;">Select tables from the left panel or
                    drop files here to begin building your transformation logic.</p>
                </div>

                <div class="row g-4 justify-content-center">
                  <div class="col-auto">
                    <div class="d-flex align-items-center gap-3 p-3 bg-white rounded shadow-sm border">
                      <div class="bg-light rounded-circle p-3 d-flex align-items-center justify-content-center"
                        style="width: 50px; height: 50px;">
                        <i class="fas fa-table text-primary"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 fw-bold">Select Tables</h6>
                        <small class="text-muted">Click tables on the left sidebar</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-auto">
                    <div class="d-flex align-items-center gap-3 p-3 bg-white rounded shadow-sm border">
                      <div class="bg-light rounded-circle p-3 d-flex align-items-center justify-content-center"
                        style="width: 50px; height: 50px;">
                        <i class="fas fa-file-csv text-success"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 fw-bold">Upload Files</h6>
                        <small class="text-muted">Drag & drop CSV/Excel files</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selected Tables will appear here dynamically -->
              <div id="selectedTables"></div>
            </div>

            <!-- Right Sidebar: Data Processing Options -->
            <div class="sidebar-panel">
              <!-- Header with Status -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="sidebar-title mb-0"><i class="fas fa-sliders-h me-2"></i>Advanced Props.</h6>
                <span class="text-muted" style="font-size: 0.75rem;">&nbsp;</span>
              </div>

              <!-- Tabs -->
              <ul class="nav nav-tabs nav-tabs-clean mb-3" id="sidebarTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="tab-node-link" data-bs-toggle="tab" data-bs-target="#tab-node"
                    type="button" role="tab">Node</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="tab-target-link" data-bs-toggle="tab" data-bs-target="#tab-target"
                    type="button" role="tab">Incremental</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="tab-sql-link" data-bs-toggle="tab" data-bs-target="#tab-sql"
                    type="button" role="tab">SCD</button>
                </li>
              </ul>

              <!-- Tab Content -->
              <div class="tab-content" id="sidebarTabsContent">

                <!-- Node Tab (Processing Options) -->
                <div class="tab-pane fade show active" id="tab-node" role="tabpanel">
                  <p class="text-muted mb-3 small fst-italic">
                    Configure table and row-level transformations.
                  </p>

                  <div class="mb-4">
                    <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Table & Row
                      Options</label>
                    <div class="d-flex flex-column gap-2">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="dq-audit" checked>
                        <label class="form-check-label small" for="dq-audit">Add Audit Columns</label>
                        <div class="form-text" style="font-size: 0.65rem;">Adds <code>_processed_at</code>,
                          <code>_source_file</code>
                        </div>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="dq-duplicates">
                        <label class="form-check-label small" for="dq-duplicates">Deduplicate Rows</label>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="dq-nulls">
                        <label class="form-check-label small" for="dq-nulls">Drop Rows with Nulls</label>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="dq-invalid">
                        <label class="form-check-label small" for="dq-invalid">Drop Invalid Records</label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Incremental Tab (Placeholder -> Active) -->
                <div class="tab-pane fade" id="tab-target" role="tabpanel">
                  <p class="text-muted mb-3 small fst-italic">
                    Configure write mode and incremental strategy.
                  </p>

                  <div class="mb-4">
                    <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Write
                      Mode</label>
                    <select class="form-select form-select-sm" id="createMode"
                      onchange="toggleIncrementalOptions(); generateSQL()">
                      <option value="INSERT INTO">Append (Incremental)</option>
                      <option value="MERGE INTO">Merge (Upsert)</option>
                      <option value="CREATE OR REPLACE">Overwrite (Full)</option>
                      <option value="INSERT OVERWRITE">Partition Overwrite</option>
                    </select>
                    <div class="form-text mt-1" style="font-size: 0.65rem;">
                      Strategies for writing to the target table.
                    </div>
                  </div>

                  <!-- Incremental / Merge Options Container -->
                  <div id="incrementalOptions" style="display: none;">
                    <div class="mb-3">
                      <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Merge Keys
                        <span class="text-danger">*</span></label>
                      <input type="text" class="form-control form-control-sm" id="mergeKeys"
                        placeholder="id, code (comma separated)" onkeyup="generateSQL()">
                      <div class="form-text" style="font-size: 0.65rem;">Columns to match source and target records.
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Watermark /
                        Audit Column</label>
                      <input type="text" class="form-control form-control-sm" id="watermarkCol" placeholder="updated_at"
                        onkeyup="generateSQL()">
                      <div class="form-text" style="font-size: 0.65rem;">Column used to identify new/modified rows.
                      </div>
                    </div>

                    <!-- Advanced Incremental Options -->
                    <button class="btn btn-sm btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse"
                      data-bs-target="#advIncOptions" aria-expanded="false" aria-controls="advIncOptions">
                      <small><i class="fas fa-chevron-right me-1"></i> More Options</small>
                    </button>
                    <div class="collapse mt-2" id="advIncOptions">
                      <div class="mb-2">
                        <label class="form-label text-uppercase text-muted fw-bold"
                          style="font-size: 0.7rem;">Pre-SQL</label>
                        <textarea class="form-control form-control-sm" id="preSql" rows="2"
                          placeholder="SQL to run before execution"></textarea>
                      </div>
                      <div class="mb-2">
                        <label class="form-label text-uppercase text-muted fw-bold"
                          style="font-size: 0.7rem;">Post-SQL</label>
                        <textarea class="form-control form-control-sm" id="postSql" rows="2"
                          placeholder="SQL to run after execution"></textarea>
                      </div>
                    </div>

                  </div>
                </div>

                <!-- SCD Tab (Active) -->
                <div class="tab-pane fade" id="tab-sql" role="tabpanel">
                  <div class="mb-3">
                    <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">SCD
                      Strategy</label>
                    <select class="form-select form-select-sm" id="scdType"
                      onchange="toggleSCDOptions(); generateSQL()">
                      <option value="TYPE1" selected>Type 1 (Overwrite/Upsert)</option>
                      <option value="TYPE2">Type 2 (History / Versioning)</option>
                    </select>
                    <div class="form-text mt-1" style="font-size: 0.65rem;">
                      Define how history is preserved.
                    </div>
                  </div>

                  <!-- Common Key -->
                  <div class="mb-3">
                    <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Business Keys
                      <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm" id="scdKeys" placeholder="id, code"
                      onkeyup="generateSQL()">
                    <div class="form-text" style="font-size: 0.65rem;">Natural keys to identify unique records.</div>
                  </div>

                  <!-- Type 2 Options -->
                  <div id="scdType2Options" style="display: none;">
                    <div class="mb-3">
                      <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Active Flag
                        Column</label>
                      <input type="text" class="form-control form-control-sm" id="scdActiveCol" value="is_active"
                        onkeyup="generateSQL()">
                    </div>
                    <div class="row g-2 mb-3">
                      <div class="col-6">
                        <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Start
                          Date Col</label>
                        <input type="text" class="form-control form-control-sm" id="scdStartCol" value="valid_from"
                          onkeyup="generateSQL()">
                      </div>
                      <div class="col-6">
                        <label class="form-label text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">End Date
                          Col</label>
                        <input type="text" class="form-control form-control-sm" id="scdEndCol" value="valid_to"
                          onkeyup="generateSQL()">
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>


          <div class="transform-section">
            <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-cogs"></i> Transformation Options</h6>

            <!-- Modern Button Layout -->
            <div class="transformation-buttons-container">
              <button class="transformation-btn" onclick="openComputedColumnModal()" data-bs-toggle="tooltip"
                title="Create calculated columns using SQL expressions">
                <i class="fas fa-calculator"></i>
                <span>Add Computed Column</span>
              </button>

              <div class="flow-arrow"><i class="fas fa-chevron-right"></i></div>

              <button class="transformation-btn" onclick="openLookupModal()" data-bs-toggle="tooltip"
                title="Join lookup/dimension tables to enrich your data">
                <i class="fas fa-link"></i>
                <span>Add Lookup</span>
              </button>

              <div class="flow-arrow"><i class="fas fa-chevron-right"></i></div>

              <button class="transformation-btn" onclick="openFilterModal()" data-bs-toggle="tooltip"
                title="Add WHERE conditions to filter your data">
                <i class="fas fa-filter"></i>
                <span>Add WHERE Filter</span>
              </button>

              <div class="flow-arrow"><i class="fas fa-chevron-right"></i></div>

              <button class="transformation-btn" onclick="openAggregationModal()" data-bs-toggle="tooltip"
                title="Configure Aggregations and Group By">
                <i class="fas fa-layer-group"></i>
                <span>Aggregate & Group</span>
              </button>
            </div>

            <!-- Lists for added transformations -->
            <div id="dimensionLookupList" class="d-none">
              <!-- Dimension lookups will be added here dynamically -->
            </div>


            <div id="computedColumnsList" class="d-none">
              <!-- Computed columns will be added here -->
            </div>

            <div id="filtersList" class="d-none">
              <!-- Filters will be added here -->
            </div>

            <div id="aggregationsList" class="d-none">
              <!-- Aggregation summary will be added here -->
            </div>
          </div>



          <!-- Validation & Verification Section -->
          <div class="mb-3 position-relative">
            <div class="card border-0 shadow-sm"
              style="background: linear-gradient(145deg, #ffffff, #f8f9fa); border-radius: 16px; overflow: hidden;">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-0">
                  <div>
                    <h5 class="text-success fw-bold mb-0" style="font-size: 1rem;"><i
                        class="fas fa-flask me-2"></i>Validation Station - Dry Run
                    </h5>
                    <p class="text-muted small mb-0" style="font-size: 0.75rem;">Run a dry run to verify your
                      transformation logic before saving.
                    </p>
                  </div>
                  <button class="btn btn-sm btn-success rounded-pill px-3 py-1 shadow-sm" onclick="runDryRun(this)"
                    style="transition: all 0.3s ease;">
                    <i class="fas fa-play me-2"></i> Run Validation
                  </button>
                </div>

                <!-- Dry Run Results -->
                <div id="dryRunResults" class="mt-3" style="display: none;">
                  <div class="card border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                    <div
                      class="card-header bg-success text-white py-2 px-3 d-flex align-items-center justify-content-between">
                      <span class="small text-uppercase fw-bold"><i class="fas fa-check-circle me-2"></i> Sample
                        Output</span>
                      <span class="badge bg-white text-success rounded-pill" style="font-size: 0.7rem;">Preview</span>
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-hover mb-0" id="dryRunTable" style="font-size: 0.9rem;">
                          <thead class="bg-light sticky-top text-muted text-uppercase"
                            style="font-size: 0.75rem; letter-spacing: 0.5px;"></thead>
                          <tbody></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Primary Action Bar -->
          <div class="d-flex align-items-center justify-content-between p-2 bg-white rounded-3 shadow-lg border mt-2"
            style="border-color: rgba(0,0,0,0.05) !important;">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-sm btn-outline-secondary px-3 rounded-pill" onclick="clearDesigner()">
                <i class="fas fa-undo me-2"></i> Reset
              </button>
              <div class="vr mx-2 text-muted opacity-25"></div>
              <button class="btn btn-sm btn-soft-purple px-3 rounded-pill text-purple me-2"
                onclick="openImportConfigModal()">
                <i class="fas fa-file-import me-2"></i> Import Config
              </button>
              <button class="btn btn-sm btn-soft-primary px-3 rounded-pill"
                onclick="showTransformConfigurationSummary()">
                <i class="fas fa-code me-2"></i> View Config
              </button>

            </div>

            <button class="btn btn-sm btn-primary px-4 rounded-pill shadow-primary" onclick="saveTransformation()"
              style="min-width: 150px;">
              <i class="fas fa-save me-2"></i> Save Changes
            </button>
          </div>
          <div class="mb-3"></div> <!-- Spacer -->
        </div>

        <!-- Step 4: Version Control -->
        <div class="step-pane" id="step-vcs">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fab fa-github text-primary"></i> Version Control Integration</h4>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="activateStep('transform')"><i
                  class="fas fa-arrow-left"></i> Previous</button>
              <button class="btn btn-primary" onclick="activateStep('execute')">Next Step <i
                  class="fas fa-arrow-right"></i></button>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Repository:</strong> <code>company/data-pipelines</code></p>
              <p><strong>Branch:</strong> <code>feature/sales-dm</code></p>
              <p><strong>File Path:</strong> <code>/partners/12345/dm/sales_summary.sql</code></p>
            </div>
            <div class="col-md-6">
              <p><strong>Commit Strategy:</strong> Auto-commit</p>
              <p><strong>Last Commit:</strong> 2 hours ago</p>
              <p><strong>Committer:</strong> partner_admin</p>
            </div>
          </div>
          <div class="form-group mt-3">
            <label><strong>Commit Message:</strong></label>
            <input type="text" class="form-control" value="Add sales_summary data mart transformation" id="commitMsg">
          </div>
          <div class="text-center mt-4">
            <button class="btn btn-success">
              <i class="fab fa-github"></i> Push to GitHub
            </button>
          </div>
        </div>

        <!-- Step 5: Execute -->
        <div class="step-pane" id="step-execute">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-play-circle text-primary"></i> Databricks Job Execution</h4>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="activateStep('vcs')"><i
                  class="fas fa-arrow-left"></i> Previous</button>

            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Job ID:</strong> <code>job_987654321</code></p>
              <p><strong>API Endpoint:</strong> <code>POST /api/2.1/jobs/run-now</code></p>
              <p><strong>Cluster Type:</strong> Job Cluster (auto-terminate)</p>
            </div>
            <div class="col-md-6">
              <p><strong>Instance Type:</strong> i3.xlarge</p>
              <p><strong>Workers:</strong> 2-8 (auto-scale)</p>
              <p><strong>DBR Version:</strong> 13.3 LTS</p>
            </div>
          </div>
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> <strong>Job Configuration Ready</strong>
            <p class="mb-0 mt-1 small">Your job is configured and ready to run</p>
          </div>
          <div class="d-flex align-items-center position-relative mt-4" style="min-height: 40px;">
            <!-- Centered Group: Execute & Schedule -->
            <div class="position-absolute start-50 translate-middle-x">
              <div class="btn-group">
                <button class="btn btn-success" onclick="executeJob()">
                  <i class="fas fa-rocket"></i> Execute Job
                </button>
                <button class="btn btn-outline-secondary" onclick="showScheduleModal()">
                  <i class="fas fa-clock"></i> Schedule Job
                </button>
              </div>
            </div>

            <!-- Right Aligned Group: Export & Save -->
            <div class="ms-auto">
              <button class="btn btn-outline-secondary btn-sm" onclick="showWorkflowSummary()">
                <i class="fas fa-download"></i> Export Workflow Configuration
              </button>
              <button class="btn btn-outline-secondary btn-sm ms-2">
                <i class="fas fa-save"></i> Save as Template
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>






    <!-- Jobs Tab -->
    <div class="tab-pane fade" id="jobs" role="tabpanel">
      <h3 class="mb-2"><i class="fas fa-tasks"></i> Job Execution Dashboard</h3>

      <div class="row mb-2">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h2 class="text-success">24</h2>
              <p class="mb-0">Active Jobs</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h2 class="text-primary">142</h2>
              <p class="mb-0">Total Runs Today</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h2 class="text-warning">3</h2>
              <p class="mb-0">Queued</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h2 class="text-danger">2</h2>
              <p class="mb-0">Failed</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Created Jobs List -->
      <div class="card mb-4">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="fas fa-briefcase"></i> My Created Jobs</span>
            <div class="d-flex gap-2">
              <input type="text" class="form-control form-control-sm" style="width: 200px;" placeholder="Search jobs..."
                id="createdJobsSearch">
              <button class="btn btn-primary btn-sm" onclick="createNewJob()">
                <i class="fas fa-plus"></i> Create New Job
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="createdJobsTable">
              <thead>
                <tr>
                  <th>Job Name</th>
                  <th>Target Table</th>
                  <th>Schedule</th>
                  <th>Status</th>
                  <th>Last Run</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="createdJobsBody">
                <tr>
                  <td><strong>sales_summary_dm</strong></td>
                  <td><code>main.dm.sales_summary</code></td>
                  <td>
                    <span class="badge bg-info">
                      <i class="fas fa-clock"></i> Daily at 2:00 AM
                    </span>
                  </td>
                  <td><span class="badge bg-success">Active</span></td>
                  <td>2025-11-03 19:45</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editJob('sales_summary_dm')"
                      title="Edit Job">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails('sales_summary_dm')"
                      title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="runJobNow('sales_summary_dm')"
                      title="Run Now">
                      <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('sales_summary_dm')"
                      title="Delete Job">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr>
                  <td><strong>customer_360_view</strong></td>
                  <td><code>main.dm.customer_360</code></td>
                  <td>
                    <span class="badge bg-info">
                      <i class="fas fa-clock"></i> Every 6 hours
                    </span>
                  </td>
                  <td><span class="badge bg-success">Active</span></td>
                  <td>2025-11-03 20:15</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editJob('customer_360_view')"
                      title="Edit Job">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails('customer_360_view')"
                      title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="runJobNow('customer_360_view')"
                      title="Run Now">
                      <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('customer_360_view')"
                      title="Delete Job">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr>
                  <td><strong>product_analytics</strong></td>
                  <td><code>main.dm.product_metrics</code></td>
                  <td>
                    <span class="badge bg-secondary">
                      <i class="fas fa-hand-paper"></i> Manual Only
                    </span>
                  </td>
                  <td><span class="badge bg-warning">Paused</span></td>
                  <td>2025-11-03 19:30</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editJob('product_analytics')"
                      title="Edit Job">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails('product_analytics')"
                      title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="runJobNow('product_analytics')"
                      title="Run Now">
                      <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('product_analytics')"
                      title="Delete Job">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="text-muted small mt-2">
            <i class="fas fa-info-circle"></i> Click on a job name or use the actions to edit, view details, or
            manage
            the job.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list"></i> Recent Job Runs</span>
            <div class="d-flex gap-2">
              <input type="text" class="form-control form-control-sm" style="width: 200px;" placeholder="Search runs..."
                id="recentRunsSearch">
              <button class="btn btn-outline-secondary btn-sm" onclick="refreshJobRuns()">
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <table class="table table-striped" id="recentRunsTable">
            <thead>
              <tr>
                <th>Job Name</th>
                <th>Run ID</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Started At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>sales_summary_dm</strong></td>
                <td><code>run_12345</code></td>
                <td><span class="badge bg-success">Success</span></td>
                <td>12m 34s</td>
                <td>2025-11-03 19:45</td>
                <td>
                  <button class="btn btn-sm btn-outline-info"><i class="fas fa-eye"></i> Logs</button>
                </td>
              </tr>
              <tr>
                <td><strong>customer_360_view</strong></td>
                <td><code>run_12344</code></td>
                <td><span class="badge bg-primary">Running</span></td>
                <td>5m 12s</td>
                <td>2025-11-03 20:15</td>
                <td>
                  <button class="btn btn-sm btn-outline-warning"><i class="fas fa-stop"></i> Cancel</button>
                </td>
              </tr>
              <tr>
                <td><strong>product_analytics</strong></td>
                <td><code>run_12343</code></td>
                <td><span class="badge bg-danger">Failed</span></td>
                <td>2m 45s</td>
                <td>2025-11-03 19:30</td>
                <td>
                  <button class="btn btn-sm btn-outline-danger"><i class="fas fa-redo"></i> Retry</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lineage Tab -->
    <div class="tab-pane fade" id="lineage" role="tabpanel">
      <h3 class="mb-4"><i class="fas fa-code-branch"></i> Data Lineage Visualization</h3>

      <div class="row">
        <!-- Left Panel: Job List -->
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-header bg-light">
              <i class="fas fa-list"></i> Select Job
            </div>
            <div class="list-group list-group-flush" id="lineageJobList">
              <button type="button" class="list-group-item list-group-item-action active"
                onclick="renderLineage('sales_summary_dm')">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">sales_summary_dm</h6>
                </div>
                <small>Target: main.dm.sales_summary</small>
              </button>
              <button type="button" class="list-group-item list-group-item-action"
                onclick="renderLineage('customer_360_view')">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">customer_360_view</h6>
                </div>
                <small>Target: main.dm.customer_360</small>
              </button>
              <button type="button" class="list-group-item list-group-item-action"
                onclick="renderLineage('product_analytics')">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">product_analytics</h6>
                </div>
                <small>Target: main.dm.product_metrics</small>
              </button>
            </div>
          </div>
        </div>

        <!-- Right Panel: Visualization -->
        <div class="col-md-9">
          <div class="card h-100">
            <div class="card-header" id="lineageHeader">
              <i class="fas fa-project-diagram"></i> Lineage Graph
            </div>
            <div class="card-body" id="lineageCanvas">
              <!-- Dynamic Content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Monitoring Tab -->
    <div class="tab-pane fade" id="monitoring" role="tabpanel">
      <h3 class="mb-4"><i class="fas fa-chart-line"></i> Pipeline Monitoring & Analytics</h3>

      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body text-center">
              <div style="font-size: 48px; color: var(--success-color);">98.5%</div>
              <h6>Success Rate (30 days)</h6>
              <small class="text-muted">432 successful / 439 total runs</small>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body text-center">
              <div style="font-size: 48px; color: var(--primary-color);">14m 23s</div>
              <h6>Avg Execution Time</h6>
              <small class="text-muted">Across all pipelines</small>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body text-center">
              <div style="font-size: 48px; color: var(--secondary-color);">12.4 GB</div>
              <h6>Data Processed Today</h6>
              <small class="text-muted">142 job executions</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <div class="card mb-4">
            <div class="card-header">
              <i class="fas fa-chart-area"></i> Job Execution Trends (Last 7 Days)
            </div>
            <div class="card-body">
              <canvas id="jobTrendsChart" style="height: 300px;"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header">
              <i class="fas fa-chart-pie"></i> Resource Usage
            </div>
            <div class="card-body">
              <canvas id="resourceChart" style="height: 300px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-exclamation-triangle"></i> Recent Alerts & Issues
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            <strong><i class="fas fa-clock"></i> Performance Warning:</strong> Job <code>product_analytics</code>
            took
            45m (avg: 15m)
            <div class="mt-2"><small>Triggered at: 2025-11-03 18:45 IST</small></div>
          </div>
          <div class="alert alert-danger">
            <strong><i class="fas fa-times-circle"></i> Job Failed:</strong> <code>inventory_sync</code> failed with
            error: "Table not found"
            <div class="mt-2"><small>Triggered at: 2025-11-03 17:30 IST</small></div>
            <button class="btn btn-sm btn-danger mt-2"><i class="fas fa-bug"></i> Debug</button>
          </div>
          <div class="alert alert-info">
            <strong><i class="fas fa-info-circle"></i> Schema Change Detected:</strong> New column
            <code>customer_tier</code> added to <code>dw.customers</code>
            <div class="mt-2"><small>Detected at: 2025-11-03 16:20 IST</small></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Configured Connections Tab (Full Page) -->
  <div class="tab-pane fade" id="connections" role="tabpanel">
    <h3 class="mb-4"><i class="fas fa-network-wired"></i> Configured Connections</h3>
    <div class="row">
      <div class="row g-0">
        <!-- Left Sidebar -->
        <div class="col-md-3 border-end bg-light">
          <div class="list-group list-group-flush pt-4 px-3" id="connectionSidebar">
            <div class="small fw-bold text-uppercase text-secondary mb-3 ps-2">Active Connections</div>

            <button
              class="list-group-item list-group-item-action py-3 border-0 d-flex align-items-center connection-nav-item active-source"
              id="link-source" onclick="showConnectionDetail('source', this)">
              <div class="icon-box me-3 rounded-circle p-2 bg-white text-primary shadow-sm"
                style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                <i class="fas fa-database"></i>
              </div>
              <div>
                <div class="fw-bold text-dark">Source Connection</div>
                <div class="small text-muted" style="font-size: 0.75rem;">Main Data Ingestion</div>
              </div>
            </button>
            <button
              class="list-group-item list-group-item-action py-3 border-0 d-flex align-items-center connection-nav-item text-muted"
              id="link-target" onclick="showConnectionDetail('target', this)">
              <div class="icon-box me-3 rounded-circle p-2 bg-white text-secondary shadow-sm"
                style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                <i class="fas fa-bullseye"></i>
              </div>
              <div>
                <div class="fw-bold">Target Connection</div>
                <div class="small text-muted" style="font-size: 0.75rem;">Destination Warehouse</div>
              </div>
            </button>

          </div>
        </div>

        <!-- Right Content Area -->
        <div class="col-md-9 bg-light-subtle">
          <div class="p-5 h-100">

            <!-- Source Detail View -->
            <div id="connDetail-source">
              <div class="glass-card shadow-sm border-0 h-100">
                <div class="card-body p-0" id="pageSourceBody">
                  <!-- Populated by JS -->
                  <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <div>Loading Connection Details...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Target Detail View -->
            <div id="connDetail-target" style="display: none;">
              <div class="glass-card shadow-sm border-0 h-100">
                <div class="card-body p-0" id="pageTargetBody">
                  <!-- Populated by JS -->
                  <div class="text-center text-muted py-5">
                    <div class="spinner-border text-warning mb-3" role="status"></div>
                    <div>Loading Target Configuration...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Workspace / Platform Setup Tab (Full Page) -->
  <div class="tab-pane fade" id="workspace" role="tabpanel">
    <h3 class="mb-4"><i class="fas fa-layer-group"></i> Workspace / Platform Setup</h3>

    <div class="row g-0">
      <!-- Left Sidebar -->
      <div class="col-md-2 border-end bg-light">
        <div class="list-group list-group-flush pt-3 workspace-tree" id="workspaceSidebar">
          <div class="mb-3 px-4 fw-bold text-secondary text-uppercase"
            style="font-size: 0.75rem; letter-spacing: 0.5px;">
            Workspace Setup
          </div>
          <button class="list-group-item list-group-item-action px-4 active"
            onclick="showWorkspaceSection('lake', this)">
            <span class="tree-node"></span>
            Lake <span class="fw-bold text-primary ms-1">Storage</span>
          </button>
          <button class="list-group-item list-group-item-action px-4" onclick="showWorkspaceSection('staging', this)">
            <span class="tree-node"></span>
            Staging <span class="fw-bold text-primary ms-1">Database</span>
          </button>
          <button class="list-group-item list-group-item-action px-4" onclick="showWorkspaceSection('schedule', this)">
            <span class="tree-node"></span>
            Metadata <span class="fw-bold text-primary ms-1">Database</span>
          </button>
          <button class="list-group-item list-group-item-action px-4" onclick="showWorkspaceSection('compute', this)">
            <span class="tree-node"></span>
            Compute <span class="fw-bold text-primary ms-1">Configuration</span>
          </button>
          <button class="list-group-item list-group-item-action px-4" onclick="showWorkspaceSection('security', this)">
            <span class="tree-node"></span>
            Security <span class="fw-bold text-primary ms-1">& Access</span>
          </button>
          <button class="list-group-item list-group-item-action px-4" onclick="showWorkspaceSection('naming', this)">
            <span class="tree-node"></span>
            Naming <span class="fw-bold text-primary ms-1">Standards</span>
          </button>
        </div>
      </div>

      <!-- Right Content Area -->
      <div class="col-md-10 bg-white">
        <div class="p-4">

          <!-- Lake Configuration Section (Default) -->
          <div id="ws-lake" class="workspace-section">
            <h4 class="mb-4 text-secondary"><i class="fas fa-water me-2"></i> Lake Connection Configuration</h4>
            <p class="text-muted mb-4">Select the cloud storage provider for your Data Lake.</p>

            <div class="row g-4 mb-4">
              <!-- AWS S3 -->
              <div class="col-md-6 col-lg-3">
                <div class="lake-card p-3 text-center" data-storage-type="s3">
                  <i class="fab fa-aws fa-2x text-warning mb-3"></i>
                  <h6 class="fw-bold mb-0">AWS S3</h6>
                </div>
              </div>
              <!-- Azure Blob -->
              <div class="col-md-6 col-lg-3">
                <div class="lake-card p-3 text-center" data-storage-type="azure">
                  <i class="fab fa-microsoft fa-2x text-primary mb-3"></i>
                  <h6 class="fw-bold mb-0">Azure Blob</h6>
                </div>
              </div>
              <!-- GCS -->
              <div class="col-md-6 col-lg-3">
                <div class="lake-card p-3 text-center" data-storage-type="gcs">
                  <i class="fab fa-google fa-2x text-danger mb-3"></i>
                  <h6 class="fw-bold mb-0">Google GCS</h6>
                </div>
              </div>
              <!-- SFTP -->
              <div class="col-md-6 col-lg-3">
                <div class="lake-card p-3 text-center" data-storage-type="sftp">
                  <i class="fas fa-network-wired fa-2x text-info mb-3"></i>
                  <h6 class="fw-bold mb-0">SFTP / FTP</h6>
                </div>
              </div>
            </div>

            <!-- Lake Configuration Forms Container -->
            <div id="lake-config-forms" style="display: none;">

              <!-- S3 Form -->
              <div id="form-s3" class="lake-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fab fa-aws text-warning me-2"></i> Configure AWS S3
                    </h6>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Bucket Name</label>
                        <input type="text" class="form-control" placeholder="e.g. my-datalake-bucket">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Region</label>
                        <select class="form-select">
                          <option>us-east-1</option>
                          <option>us-west-2</option>
                          <option>eu-central-1</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Access Key ID</label>
                        <input type="text" class="form-control" placeholder="AKIA...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Secret Access Key</label>
                        <input type="password" class="form-control" placeholder="Secret Key">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Azure Form -->
              <div id="form-azure" class="lake-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fab fa-microsoft text-primary me-2"></i> Configure
                      Azure Blob Storage</h6>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Storage Account Name</label>
                        <input type="text" class="form-control" placeholder="e.g. mystorageaccount">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Container Name</label>
                        <input type="text" class="form-control" placeholder="e.g. data-container">
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-bold">Connection String / SAS Token</label>
                        <input type="password" class="form-control"
                          placeholder="DefaultEndpointsProtocol=https;AccountName=...">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- GCS Form -->
              <div id="form-gcs" class="lake-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fab fa-google text-danger me-2"></i> Configure Google
                      Cloud Storage</h6>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Bucket Name</label>
                        <input type="text" class="form-control" placeholder="e.g. my-gcs-bucket">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Project ID</label>
                        <input type="text" class="form-control" placeholder="e.g. my-gcp-project">
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-bold">Service Account JSON</label>
                        <textarea class="form-control" rows="3"
                          placeholder="{ 'type': 'service_account', ... }"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- SFTP Form -->
              <div id="form-sftp" class="lake-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fas fa-network-wired text-info me-2"></i> Configure
                      SFTP / FTP</h6>
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label class="form-label small fw-bold">Host URL</label>
                        <input type="text" class="form-control" placeholder="sftp.example.com">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold">Port</label>
                        <input type="text" class="form-control" placeholder="22">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Username</label>
                        <input type="text" class="form-control" placeholder="user">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Password / SSH Key</label>
                        <input type="password" class="form-control" placeholder="Password">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3 text-end">
                <button class="btn btn-primary" onclick="saveLakeConfiguration(this)"><i class="fas fa-save me-2"></i>
                  Save Configuration</button>
              </div>
            </div>

            <!-- Lake Configuration Summary Grid -->
            <div id="lake-config-summary" style="display: none;">
              <div class="card glass-card border-0">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Configuration Saved</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editLakeConfiguration()"><i
                        class="fas fa-edit me-2"></i> Edit</button>
                  </div>
                </div>
                <div class="card-body px-4 pb-4">
                  <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                      <tbody id="lake-summary-body">
                        <!-- Populated by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Staging Source Section -->
          <div id="ws-staging" class="workspace-section" style="display: none;">
            <h4 class="mb-4 text-secondary"><i class="fas fa-database me-2"></i> Staging Source Configuration</h4>
            <p class="text-muted mb-4">Select the database system for your staging records.</p>

            <div class="row g-4 mb-4">
              <div class="col-md-6">
                <div class="lake-card p-3 text-center cursor-pointer" data-db-type="mysql"
                  onclick="selectWorkspaceOption(this)">
                  <i class="fas fa-database fa-2x text-info mb-3"></i>
                  <h6 class="fw-bold mb-0">MySQL</h6>
                </div>
              </div>
              <div class="col-md-6">
                <div class="lake-card p-3 text-center cursor-pointer" data-db-type="postgres"
                  onclick="selectWorkspaceOption(this)">
                  <i class="fas fa-server fa-2x text-primary mb-3"></i>
                  <h6 class="fw-bold mb-0">PostgreSQL</h6>
                </div>
              </div>
            </div>

            <!-- Staging Configuration Forms -->
            <div id="staging-config-forms" style="display: none;">
              <!-- MySQL Form -->
              <div id="staging-form-mysql" class="generic-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fas fa-database text-info me-2"></i> Configure MySQL
                      Staging</h6>
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label class="form-label small fw-bold">Host / URL</label>
                        <input type="text" class="form-control" placeholder="mysql.example.com">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold">Port</label>
                        <input type="text" class="form-control" value="3306">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Database Name</label>
                        <input type="text" class="form-control" placeholder="staging_db">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Username</label>
                        <input type="text" class="form-control" placeholder="admin">
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-bold">Password</label>
                        <input type="password" class="form-control" placeholder="********">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Postgres Form -->
              <div id="staging-form-postgres" class="generic-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fas fa-server text-primary me-2"></i> Configure
                      PostgreSQL Staging</h6>
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label class="form-label small fw-bold">Host / URL</label>
                        <input type="text" class="form-control" placeholder="postgres.example.com">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold">Port</label>
                        <input type="text" class="form-control" value="5432">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Database Name</label>
                        <input type="text" class="form-control" placeholder="staging_db">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Username</label>
                        <input type="text" class="form-control" placeholder="postgres">
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-bold">Password</label>
                        <input type="password" class="form-control" placeholder="********">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3 text-end">
                <button class="btn btn-primary" onclick="saveGenericConfig('staging', this)">
                  <i class="fas fa-save me-2"></i> Save Configuration
                </button>
              </div>
            </div>

            <!-- Staging Summary -->
            <div id="staging-config-summary" style="display: none;">
              <div class="card glass-card border-0">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Configuration Saved</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editGenericConfig('staging')">
                      <i class="fas fa-edit me-2"></i> Edit
                    </button>
                  </div>
                </div>
                <div class="card-body px-4 pb-4">
                  <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                      <tbody id="staging-summary-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Schedule Source Section -->
          <div id="ws-schedule" class="workspace-section" style="display: none;">
            <h4 class="mb-4 text-secondary"><i class="fas fa-calendar-alt me-2"></i> Schedule Source Configuration</h4>
            <p class="text-muted mb-4">Select the database system for your schedule metadata.</p>

            <div class="row g-4 mb-4">
              <div class="col-md-6">
                <div class="lake-card p-3 text-center cursor-pointer" data-db-type="mysql"
                  onclick="selectWorkspaceOption(this)">
                  <i class="fas fa-database fa-2x text-info mb-3"></i>
                  <h6 class="fw-bold mb-0">MySQL</h6>
                </div>
              </div>
              <div class="col-md-6">
                <div class="lake-card p-3 text-center cursor-pointer" data-db-type="postgres"
                  onclick="selectWorkspaceOption(this)">
                  <i class="fas fa-server fa-2x text-primary mb-3"></i>
                  <h6 class="fw-bold mb-0">PostgreSQL</h6>
                </div>
              </div>
            </div>

            <!-- Schedule Configuration Forms -->
            <div id="schedule-config-forms" style="display: none;">
              <!-- MySQL Form -->
              <div id="schedule-form-mysql" class="generic-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fas fa-database text-info me-2"></i> Configure MySQL
                      Schedule DB</h6>
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label class="form-label small fw-bold">Host / URL</label>
                        <input type="text" class="form-control" placeholder="mysql-schedule.example.com">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold">Port</label>
                        <input type="text" class="form-control" value="3306">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Database Name</label>
                        <input type="text" class="form-control" placeholder="schedule_db">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Username</label>
                        <input type="text" class="form-control" placeholder="scheduler">
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-bold">Password</label>
                        <input type="password" class="form-control" placeholder="********">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Postgres Form -->
              <div id="schedule-form-postgres" class="generic-form" style="display: none;">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3 text-dark"><i class="fas fa-server text-primary me-2"></i> Configure
                      PostgreSQL Schedule DB</h6>
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label class="form-label small fw-bold">Host / URL</label>
                        <input type="text" class="form-control" placeholder="postgres-schedule.example.com">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold">Port</label>
                        <input type="text" class="form-control" value="5432">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Database Name</label>
                        <input type="text" class="form-control" placeholder="schedule_db">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold">Username</label>
                        <input type="text" class="form-control" placeholder="scheduler">
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-bold">Password</label>
                        <input type="password" class="form-control" placeholder="********">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3 text-end">
                <button class="btn btn-primary" onclick="saveGenericConfig('schedule', this)">
                  <i class="fas fa-save me-2"></i> Save Configuration
                </button>
              </div>
            </div>

            <!-- Schedule Summary -->
            <div id="schedule-config-summary" style="display: none;">
              <div class="card glass-card border-0">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Configuration Saved</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editGenericConfig('schedule')">
                      <i class="fas fa-edit me-2"></i> Edit
                    </button>
                  </div>
                </div>
                <div class="card-body px-4 pb-4">
                  <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                      <tbody id="schedule-summary-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Compute Defaults Section -->
          <div id="ws-compute" class="workspace-section" style="display: none;">
            <h4 class="mb-4 text-secondary"><i class="fas fa-microchip me-2"></i> Compute Defaults</h4>
            <p class="text-muted mb-4">Set default cluster configurations for new pipelines.</p>

            <div id="compute-config-forms">
              <div id="compute-form-main" class="generic-form">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label fw-bold small">Cluster Mode</label>
                        <select class="form-select">
                          <option>Standard</option>
                          <option>Single Node</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold small">Runtime Version</label>
                        <select class="form-select">
                          <option>13.3 LTS (Scala 2.12, Spark 3.4.1)</option>
                          <option>14.3 LTS (Scala 2.12, Spark 3.5.0)</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold small">Node Type</label>
                        <select class="form-select">
                          <option>Standard_DS3_v2 (14GB Memory, 4 Cores)</option>
                          <option>Standard_DS4_v2 (28GB Memory, 8 Cores)</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold small">Autoscaling Workers</label>
                        <div class="input-group">
                          <span class="input-group-text">Min</span>
                          <input type="number" class="form-control" value="2">
                          <span class="input-group-text">Max</span>
                          <input type="number" class="form-control" value="8">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-3 text-end">
                  <button class="btn btn-primary" onclick="saveGenericConfig('compute', this)">
                    <i class="fas fa-save me-2"></i> Save Configuration
                  </button>
                </div>
              </div>
            </div>

            <!-- Compute Summary -->
            <div id="compute-config-summary" style="display: none;">
              <div class="card glass-card border-0">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Configuration Saved</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editGenericConfig('compute')">
                      <i class="fas fa-edit me-2"></i> Edit
                    </button>
                  </div>
                </div>
                <div class="card-body px-4 pb-4">
                  <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                      <tbody id="compute-summary-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Security & Governance Section -->
          <div id="ws-security" class="workspace-section" style="display: none;">
            <h4 class="mb-4 text-secondary"><i class="fas fa-shield-alt me-2"></i> Security & Governance</h4>
            <p class="text-muted mb-4">Configure access controls and audit logging.</p>

            <div id="security-config-forms">
              <div id="security-form-main" class="generic-form">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <div class="card p-3 border mb-3">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="unityCatalogCheck" checked>
                        <label class="form-check-label fw-bold" for="unityCatalogCheck">Enable Unity Catalog
                          Integration</label>
                      </div>
                      <div class="form-text ms-4">Automatically register tables in Unity Catalog metastore.</div>
                    </div>

                    <div class="card p-3 border mb-3">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="aclCheck" checked>
                        <label class="form-check-label fw-bold" for="aclCheck">Enforce Table ACLs</label>
                      </div>
                      <div class="form-text ms-4">Require explicit permissions for table access.</div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-bold small">Audit Log Storage Path</label>
                      <input type="text" class="form-control" placeholder="s3://bucket/audit-logs/">
                    </div>
                  </div>
                </div>
                <div class="mt-3 text-end">
                  <button class="btn btn-primary" onclick="saveGenericConfig('security', this)">
                    <i class="fas fa-save me-2"></i> Save Configuration
                  </button>
                </div>
              </div>
            </div>

            <!-- Security Summary -->
            <div id="security-config-summary" style="display: none;">
              <div class="card glass-card border-0">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Configuration Saved</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editGenericConfig('security')">
                      <i class="fas fa-edit me-2"></i> Edit
                    </button>
                  </div>
                </div>
                <div class="card-body px-4 pb-4">
                  <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                      <tbody id="security-summary-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Naming & Standards Section -->
          <div id="ws-naming" class="workspace-section" style="display: none;">
            <h4 class="mb-4 text-secondary"><i class="fas fa-font me-2"></i> Naming & Standards</h4>
            <p class="text-muted mb-4">Define naming conventions for automated asset creation.</p>

            <div id="naming-config-forms">
              <div id="naming-form-main" class="generic-form">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label fw-bold small">Environment Prefixes</label>
                        <div class="input-group mb-2">
                          <span class="input-group-text">Dev</span>
                          <input type="text" class="form-control" value="dev_">
                        </div>
                        <div class="input-group mb-2">
                          <span class="input-group-text">QA</span>
                          <input type="text" class="form-control" value="qa_">
                        </div>
                        <div class="input-group">
                          <span class="input-group-text">Prod</span>
                          <input type="text" class="form-control" value="">
                        </div>
                        <div class="form-text">Prefixes applied to table/view names based on environment.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold small">Medallion Architecture Suffixes</label>
                        <div class="input-group mb-2">
                          <span class="input-group-text">Bronze</span>
                          <input type="text" class="form-control" value="_bronze">
                        </div>
                        <div class="input-group mb-2">
                          <span class="input-group-text">Silver</span>
                          <input type="text" class="form-control" value="_silver">
                        </div>
                        <div class="input-group">
                          <span class="input-group-text">Gold</span>
                          <input type="text" class="form-control" value="_gold">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-3 text-end">
                  <button class="btn btn-primary" onclick="saveGenericConfig('naming', this)">
                    <i class="fas fa-save me-2"></i> Save Configuration
                  </button>
                </div>
              </div>
            </div>

            <!-- Naming Summary -->
            <div id="naming-config-summary" style="display: none;">
              <div class="card glass-card border-0">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i> Configuration Saved</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editGenericConfig('naming')">
                      <i class="fas fa-edit me-2"></i> Edit
                    </button>
                  </div>
                </div>
                <div class="card-body px-4 pb-4">
                  <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                      <tbody id="naming-summary-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom Navigation -->
          <div class="d-flex justify-content-end mt-5 pt-3 border-top">
            <button class="btn btn-primary btn-lg shadow-sm" onclick="document.getElementById('workflow-tab').click()">
              Next: Design Pipeline <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
  </div>

  </div> <!-- Close tab-content -->
  </div> <!-- Close main-container -->

  <!-- Footer -->
  <footer class="text-center py-4 mt-5" style="border-top: 1px solid #e0e0e0; color: #6c757d;">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <p class="mb-1">&copy; 2025 AnvizGnt. All rights reserved.</p>
          <small>Databricks ELT Platform v2.0.1 | <a href="#" class="text-decoration-none">Privacy Policy</a> | <a
              href="#" class="text-decoration-none">Terms of Service</a></small>
        </div>
      </div>
    </div>
  </footer>

  <!-- Data Preview Modal -->
  <div class="modal fade" id="dataPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-table text-primary"></i> <span id="previewModalTitle">Table
              Preview</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="previewModalBody">
          <!-- Table content will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Target Configuration Modal -->
  <div class="modal fade" id="targetConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-bullseye text-primary"></i> Configure Target Database
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Info Alert -->
          <div class="alert alert-info py-2">
            <i class="fas fa-info-circle"></i>
            <strong>Target Connection</strong><br>
            Define where the transformed data should be written. You can use the same connection as the source,
            select
            an existing one, or configure a new connection.
          </div>

          <!-- Target Connection Selection -->
          <div class="mb-4">
            <label class="form-label"><strong>Target Connection Mode</strong></label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="targetConnectionMode" id="targetConnSame" value="same" checked
                onchange="updateTargetConnectionUI()">
              <label class="btn btn-outline-primary" for="targetConnSame">
                <i class="fas fa-sync"></i> Same as Source
              </label>

              <input type="radio" class="btn-check" name="targetConnectionMode" id="targetConnExisting" value="existing"
                onchange="updateTargetConnectionUI()">
              <label class="btn btn-outline-primary" for="targetConnExisting">
                <i class="fas fa-list"></i> Existing
              </label>

              <input type="radio" class="btn-check" name="targetConnectionMode" id="targetConnNew" value="new"
                onchange="updateTargetConnectionUI()">
              <label class="btn btn-outline-primary" for="targetConnNew">
                <i class="fas fa-plus-circle"></i> New
              </label>
            </div>
          </div>

          <!-- Connection Details Section -->
          <div class="card bg-light mb-4">
            <div class="card-body p-3">
              <!-- Same as Source / Existing View -->
              <div id="targetConnSelectGroup">
                <label class="form-label"><strong>Connection</strong></label>
                <select class="form-select" id="targetConnectionSelect" disabled>
                  <option value="current" selected>Current: demo-workspace.cloud.databricks.com</option>
                  <option value="conn1">Production Workspace (adb-prod-123)</option>
                  <option value="conn2">Development Workspace (adb-dev-456)</option>
                  <option value="conn3">Staging Workspace (adb-stg-789)</option>
                </select>
                <small class="text-muted mt-1 d-block" id="targetConnHelp">Using the same connection defined in the
                  Connect step.</small>
              </div>

              <!-- New Connection View -->
              <div id="targetConnNewGroup" style="display: none;">
                <div class="mb-2">
                  <label class="form-label small">Workspace URL / Host</label>
                  <input type="text" class="form-control form-control-sm" id="targetNewHost"
                    placeholder="https://adb-xxxxxxxx.xx.azuredatabricks.net">
                </div>
                <div class="mb-0">
                  <label class="form-label small">Access Token</label>
                  <input type="password" class="form-control form-control-sm" id="targetNewToken" placeholder="dapi...">
                </div>
              </div>
            </div>
          </div>

          <!-- Configuration Form -->
          <div class="row g-3">
            <!-- Target Catalog -->
            <div class="col-md-6">
              <label class="form-label">
                <strong><i class="fas fa-database"></i> Target Catalog</strong>
              </label>
              <select class="form-select" id="targetCatalog" onchange="updateTargetSchemaOptions()">
                <option value="main" selected>main</option>
                <option value="analytics">analytics</option>
                <option value="sandbox">sandbox</option>
              </select>
              <small class="text-muted">Unity Catalog to write data</small>
            </div>

            <!-- Target Schema -->
            <div class="col-md-6">
              <label class="form-label">
                <strong><i class="fas fa-folder"></i> Target Schema</strong>
              </label>
              <select class="form-select" id="targetSchema" onchange="updateFullTargetPath()">
                <option value="dw">dw</option>
                <option value="dm" selected>dm</option>
                <option value="staging">staging</option>
              </select>
              <small class="text-muted">Schema within the catalog</small>
            </div>
          </div>

          <!-- Full Target Path Display -->
          <div class="mt-4 p-3 bg-light border rounded">
            <div class="d-flex justify-content-between align-items-center">
              <div class="flex-grow-1">
                <small class="text-muted d-block mb-1">Target Location:</small>
                <h5 class="mb-0">
                  <code id="fullTargetPath" class="text-primary">main.dm.[table_from_design]</code>
                </h5>
              </div>
              <div id="targetModeIndicator" class="badge bg-success">
                <i class="fas fa-check"></i> Ready
              </div>
            </div>
          </div>

          <!-- Validation Messages -->
          <div id="targetValidation" class="mt-3" style="display: none;"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveTargetConfig()">
            <i class="fas fa-check"></i> Save Target Configuration
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*
    ============================================================================
       SECTION 2: DATA & METADATA CONFIGURATION
       - Static metadata (columns, types)
       - Initial schema definitions
    ============================================================================
    */
    // ===== Visual Transformation Designer - Data & State =====
    const tableMetadata = {
      // --- Source Systems (Raw) ---
      'crm.users': {
        columns: [
          { name: 'user_id', type: 'INT', isPK: true },
          { name: 'username', type: 'STRING' },
          { name: 'email', type: 'STRING' },
          { name: 'registration_date', type: 'DATE' },
          { name: 'country_code', type: 'STRING' }
        ]
      },
      'crm.customers': {
        columns: [
          { name: 'customer_id', type: 'INT', isPK: true },
          { name: 'first_name', type: 'STRING' },
          { name: 'last_name', type: 'STRING' },
          { name: 'phone', type: 'STRING' },
          { name: 'address_line1', type: 'STRING' },
          { name: 'city', type: 'STRING' }
        ]
      },
      'crm.sales_orders': {
        columns: [
          { name: 'order_id', type: 'INT', isPK: true },
          { name: 'customer_id', type: 'INT', isFK: true },
          { name: 'amount', type: 'DECIMAL' },
          { name: 'order_date', type: 'DATE' },
          { name: 'status', type: 'STRING' },
          { name: 'discount', type: 'DECIMAL' }
        ]
      },
      'finance.transactions': {
        columns: [
          { name: 'transaction_id', type: 'INT', isPK: true },
          { name: 'order_id', type: 'INT', isFK: true },
          { name: 'product_id', type: 'INT', isFK: true },
          { name: 'quantity', type: 'INT' },
          { name: 'total_amount', type: 'DECIMAL' },
          { name: 'transaction_date', type: 'DATE' }
        ]
      },
      'erp.products': {
        columns: [
          { name: 'product_id', type: 'INT', isPK: true },
          { name: 'product_name', type: 'STRING' },
          { name: 'category', type: 'STRING' },
          { name: 'price', type: 'DECIMAL' },
          { name: 'stock_quantity', type: 'INT' }
        ]
      },
      'erp.inventory': {
        columns: [
          { name: 'inventory_id', type: 'INT', isPK: true },
          { name: 'product_id', type: 'INT', isFK: true },
          { name: 'warehouse_id', type: 'INT' },
          { name: 'quantity_on_hand', type: 'INT' },
          { name: 'reorder_level', type: 'INT' }
        ]
      },
      'clickstream.web_logs': {
        columns: [
          { name: 'log_id', type: 'BIGINT', isPK: true },
          { name: 'user_id', type: 'INT', isFK: true },
          { name: 'url', type: 'STRING' },
          { name: 'timestamp', type: 'TIMESTAMP' }
        ]
      },
      'erp.orders': {
        columns: [
          { name: 'order_id', type: 'INT', isPK: true },
          { name: 'customer_id', type: 'INT', isFK: true },
          { name: 'order_date', type: 'TIMESTAMP' },
          { name: 'total_amount', type: 'DECIMAL' },
          { name: 'status', type: 'STRING' }
        ]
      },
      'erp.order_items': {
        columns: [
          { name: 'item_id', type: 'INT', isPK: true },
          { name: 'order_id', type: 'INT', isFK: true },
          { name: 'product_id', type: 'INT', isFK: true },
          { name: 'quantity', type: 'INT' },
          { name: 'unit_price', type: 'DECIMAL' }
        ]
      },

      // --- Data Warehouse (Dimensions & Facts) ---
      'dw.dim_customer': {
        columns: [
          { name: 'customer_key', type: 'BIGINT', isPK: true },
          { name: 'customer_id', type: 'INT' },
          { name: 'full_name', type: 'STRING' },
          { name: 'email', type: 'STRING' },
          { name: 'current_flag', type: 'BOOLEAN' }
        ]
      },
      'dw.dim_product': {
        columns: [
          { name: 'product_key', type: 'BIGINT', isPK: true },
          { name: 'product_id', type: 'INT' },
          { name: 'product_name', type: 'STRING' },
          { name: 'category_name', type: 'STRING' }
        ]
      },
      'dw.fact_sales': {
        columns: [
          { name: 'sales_key', type: 'BIGINT', isPK: true },
          { name: 'customer_key', type: 'BIGINT', isFK: true },
          { name: 'product_key', type: 'BIGINT', isFK: true },
          { name: 'sales_amount', type: 'DECIMAL' },
          { name: 'quantity', type: 'INT' },
          { name: 'transaction_date', type: 'DATE' }
        ]
      },
      'dw.fact_orders': {
        columns: [
          { name: 'order_key', type: 'BIGINT', isPK: true },
          { name: 'customer_key', type: 'INT', isFK: true },
          { name: 'product_key', type: 'INT', isFK: true },
          { name: 'date_key', type: 'INT', isFK: true },
          { name: 'amount', type: 'DECIMAL' },
          { name: 'quantity', type: 'INT' }
        ]
      },
      'dw.bridge_account': {
        columns: [
          { name: 'link_id', type: 'INT', isPK: true },
          { name: 'account_id', type: 'INT', isFK: true },
          { name: 'contact_id', type: 'INT', isFK: true },
          { name: 'role', type: 'STRING' }
        ]
      },
      'dw.customers': {
        columns: [
          { name: 'customer_id', type: 'INT', isPK: true },
          { name: 'customer_name', type: 'STRING' },
          { name: 'region', type: 'STRING' },
          { name: 'customer_segment', type: 'STRING' },
          { name: 'email', type: 'STRING' },
          { name: 'created_date', type: 'DATE' }
        ]
      },
      'dw.fact_sales': {
        columns: [
          { name: 'order_id', type: 'INT', isPK: true },
          { name: 'customer_id', type: 'INT', isFK: true },
          { name: 'amount', type: 'DECIMAL' },
          { name: 'order_date', type: 'DATE' },
          { name: 'status', type: 'STRING' },
          { name: 'discount', type: 'DECIMAL' }
        ]
      },
      'dw.products': {
        columns: [
          { name: 'product_id', type: 'INT', isPK: true },
          { name: 'product_name', type: 'STRING' },
          { name: 'category', type: 'STRING' },
          { name: 'price', type: 'DECIMAL' },
          { name: 'stock_quantity', type: 'INT' }
        ]
      },
      'dw.fact_orders': {
        columns: [
          { name: 'transaction_id', type: 'INT', isPK: true },
          { name: 'order_id', type: 'INT', isFK: true },
          { name: 'product_id', type: 'INT', isFK: true },
          { name: 'quantity', type: 'INT' },
          { name: 'total_amount', type: 'DECIMAL' },
          { name: 'transaction_date', type: 'DATE' }
        ]
      },
      'dw.customer_addresses': {
        columns: [
          { name: 'address_id', type: 'INT', isPK: true },
          { name: 'customer_id', type: 'INT', isFK: true },
          { name: 'street', type: 'STRING' },
          { name: 'city', type: 'STRING' },
          { name: 'state', type: 'STRING' },
          { name: 'postal_code', type: 'STRING' },
          { name: 'country', type: 'STRING' }
        ]
      },
      'dw.order_line_items': {
        columns: [
          { name: 'line_item_id', type: 'INT', isPK: true },
          { name: 'order_id', type: 'INT', isFK: true },
          { name: 'product_id', type: 'INT', isFK: true },
          { name: 'quantity', type: 'INT' },
          { name: 'unit_price', type: 'DECIMAL' },
          { name: 'line_total', type: 'DECIMAL' }
        ]
      },
      'dw.product_categories': {
        columns: [
          { name: 'category_id', type: 'INT', isPK: true },
          { name: 'category_name', type: 'STRING' },
          { name: 'parent_category_id', type: 'INT' },
          { name: 'description', type: 'STRING' }
        ]
      }/*,
      'dw.payment_transactions_history': {
        columns: [
          { name: 'payment_id', type: 'INT', isPK: true },
          { name: 'order_id', type: 'INT', isFK: true },
          { name: 'payment_method', type: 'STRING' },
          { name: 'amount', type: 'DECIMAL' },
          { name: 'payment_date', type: 'TIMESTAMP' },
          { name: 'status', type: 'STRING' }
        ]
      },
      'dw.customer_interaction_events_log': {
        columns: [
          { name: 'event_id', type: 'BIGINT', isPK: true },
          { name: 'customer_id', type: 'INT', isFK: true },
          { name: 'event_type', type: 'STRING' },
          { name: 'event_timestamp', type: 'TIMESTAMP' },
          { name: 'event_details', type: 'STRING' },
          { name: 'channel', type: 'STRING' }
        ]
      },
      'dw.inventory_warehouse_stock_levels': {
        columns: [
          { name: 'stock_id', type: 'INT', isPK: true },
          { name: 'product_id', type: 'INT', isFK: true },
          { name: 'warehouse_id', type: 'INT' },
          { name: 'quantity_on_hand', type: 'INT' },
          { name: 'reorder_point', type: 'INT' },
          { name: 'last_updated', type: 'TIMESTAMP' }
        ]
      },
      'dw.shipping_tracking_details': {
        columns: [
          { name: 'tracking_id', type: 'STRING', isPK: true },
          { name: 'order_id', type: 'INT', isFK: true },
          { name: 'carrier', type: 'STRING' },
          { name: 'status', type: 'STRING' },
          { name: 'shipped_date', type: 'DATE' },
          { name: 'delivery_date', type: 'DATE' }
        ]
      },
      'dw.employee_performance_metrics': {
        columns: [
          { name: 'metric_id', type: 'INT', isPK: true },
          { name: 'employee_id', type: 'INT', isFK: true },
          { name: 'period', type: 'STRING' },
          { name: 'sales_target', type: 'DECIMAL' },
          { name: 'sales_actual', type: 'DECIMAL' },
          { name: 'performance_score', type: 'DECIMAL' }
        ]
      }*/
    };

    /*
    ============================================================================
       SECTION 1: GLOBAL STATE & CONFIGURATION
       - Main application state variables
       - Metadata definitions
       - Design mode flags
    ============================================================================
    */
    let selectedTables = [];
    let selectedColumns = {};
    let columnSchema = {}; // NEW: Store column schema with editable properties
    let tableTypes = {}; // Track table type (lookup/driving) for each table
    let currentDesignMode = 'dw'; // Track current design mode: 'dw' (Data Warehouse) or 'dm' (Data Mart)
    let joinConditions = [];
    let computedColumns = [];
    let computedColumnCounter = 0;
    let filters = [];
    let filterCounter = 0;
    let dimensionLookupCounter = 0;

    // Aggregation State (Table-Level)
    let aggregationConfig = {};

    // Data type options for Databricks
    const dataTypes = [
      'STRING', 'VARCHAR', 'INT', 'BIGINT', 'SMALLINT', 'TINYINT',
      'DECIMAL', 'DOUBLE', 'FLOAT', 'DATE', 'TIMESTAMP',
      'BOOLEAN', 'BINARY', 'ARRAY', 'MAP', 'STRUCT'
    ];

    // Default table roles for demo tables (used in DM mode sidebar)
    const defaultTableRoles = {
      'dw.fact_sales': 'fact',      // Driving/Fact table
      'dw.fact_orders': 'fact',      // Driving/Fact table
      'dw.customers': 'dimension',    // Dimension table
      'dw.products': 'dimension'      // Dimension table
    };

    /*
    ============================================================================
       SECTION 3: UI INTERACTION & NAVIGATION
       - Stepper logic
       - Theme management
       - Notification system
    ============================================================================
    */
    // Horizontal Stepper Logic
    function activateStep(stepId) {
      // Update Stepper Header
      document.querySelectorAll('.stepper-step').forEach(step => {
        step.classList.remove('active');
        // Mark previous steps as completed
        // This is a simple implementation, you might want more complex logic based on actual completion
      });

      // Find the clicked step and activate it
      const clickedStep = Array.from(document.querySelectorAll('.stepper-step')).find(step =>
        step.getAttribute('onclick').includes(`'${stepId}'`)
      );
      if (clickedStep) {
        clickedStep.classList.add('active');
      }

      // Show Content Pane
      document.querySelectorAll('.step-pane').forEach(pane => {
        pane.classList.remove('active');
      });
      const activePane = document.getElementById(`step-${stepId}`);
      activePane.classList.add('active');

      // Scroll to the work area (step content) instead of header
      // Wait a moment for the pane to become visible
      setTimeout(() => {
        const stepContent = document.getElementById(`step-${stepId}`);
        if (stepContent) {
          // Scroll to position the work area in view, not the header
          const yOffset = -20; // Small offset from top
          const y = stepContent.getBoundingClientRect().top + window.pageYOffset + yOffset;
          window.scrollTo({ top: y, behavior: 'smooth' });
        }
      }, 100);
    }

    function toggleConnectionMode(mode) {
      if (mode === 'api') {
        document.getElementById('api-fields').style.display = 'block';
        document.getElementById('jdbc-fields').style.display = 'none';
      } else {
        document.getElementById('api-fields').style.display = 'none';
        document.getElementById('jdbc-fields').style.display = 'block';
      }
    }

    // Update design type (DW/DM)
    function updateDesignType(type) {
      // Case 1: Canvas has content (User Action) -> Confirm & Load
      if (selectedTables.length > 0) {
        if (!confirm("Switching design modes will RESET your current canvas and configuration. Are you sure you want to proceed?")) {
          const otherType = type === 'dw' ? 'dm' : 'dw';
          const otherRadio = document.getElementById(otherType === 'dw' ? 'designTypeDW' : 'designTypeDM');
          if (otherRadio) otherRadio.checked = true;
          return;
        }
        const loaderHtml = `
            <div id="modeSwitchLoader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
              <h5 class="mt-3 text-primary">Switching Mode...</h5>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', loaderHtml);
        setTimeout(() => {
          performModeSwitch(type);
          document.getElementById('modeSwitchLoader').remove();
          showNotification('Switched Mode', 'info');
        }, 800);
      }
      // Case 2: Init/Empty (System Action) -> Instant
      else {
        performModeSwitch(type);
      }
    }

    // Worker Function
    function performModeSwitch(type) {
      // Logic handled in wrapper

      // Loader handled in wrapper
      // 1. Reset Canvas
      resetCanvas();

      // 2. Default Logic (Existing)
      currentDesignMode = type;

      const catalogSelect = document.getElementById('dmCatalog');
      const tableNameInput = document.getElementById('dmTableName');
      const designTypeBadge = document.getElementById('designTypeBadge');
      const targetConfigTitle = document.getElementById('targetConfigTitle');

      if (type === 'dw') {
        // Data Warehouse options
        catalogSelect.innerHTML = `
            <option value="main.dw" selected>main.dw</option>
            <option value="main.staging">main.staging</option>
            <option value="main.raw">main.raw</option>
            <option value="analytics.dw">analytics.dw</option>
          `;
        tableNameInput.placeholder = 'e.g., fact_sales, dim_customer, bridge_account';
        tableNameInput.value = 'dim_customer';

        designTypeBadge.innerHTML = 'ðŸ¢ Building: <strong>Data Warehouse</strong>';
        designTypeBadge.className = 'badge badge-silver';

        targetConfigTitle.innerHTML = 'Target Data Warehouse Configuration';
        targetConfigTitle.parentElement.className = 'mb-0 theme-silver';
        targetConfigTitle.parentElement.querySelector('i').className = 'fas fa-warehouse me-2';

        // Switch Available Tables to Source Systems
        toggleAvailableTablesSource('source');
      } else {
        // Data Mart options
        catalogSelect.innerHTML = `
            <option value="main.dm" selected>main.dm</option>
            <option value="main.staging">main.staging</option>
            <option value="analytics.dm">analytics.dm</option>
          `;
        tableNameInput.placeholder = 'e.g., sales_summary, customer_360';
        tableNameInput.value = 'sales_summary';

        designTypeBadge.innerHTML = 'ðŸ“Š Building: <strong>Data Mart</strong>';
        designTypeBadge.className = 'badge badge-gold';

        targetConfigTitle.innerHTML = 'Target Data Mart Configuration';
        targetConfigTitle.parentElement.className = 'mb-0 theme-gold';
        targetConfigTitle.parentElement.querySelector('i').className = 'fas fa-bullseye me-2';

        // Switch Available Tables to Data Warehouse Tables via toggleAvailableTablesSource
        toggleAvailableTablesSource('dw');
      }

      // Trigger SQL regeneration
      if (typeof generateSQL === 'function') generateSQL();
    }

    // NEW: Reset Canvas State
    function resetCanvas() {
      console.log("Resetting Canvas...");

      // 1. Clear State Variables (Safely)
      try {
        if (typeof selectedTables !== 'undefined') selectedTables = [];
        if (typeof selectedColumns !== 'undefined') selectedColumns = {};
        if (typeof activeTableContext !== 'undefined') activeTableContext = null;
        if (typeof joinConditions !== 'undefined') joinConditions = [];
        if (typeof filters !== 'undefined') filters = [];
        if (typeof computedColumns !== 'undefined') computedColumns = [];
        if (typeof aggregationConfig !== 'undefined') aggregationConfig = {};

        // Reset Counters
        if (typeof filterCounter !== 'undefined') filterCounter = 0;
        if (typeof filterRowCount !== 'undefined') filterRowCount = 0;
        if (typeof computedColumnCounter !== 'undefined') computedColumnCounter = 0;
        if (typeof dimensionLookupCounter !== 'undefined') dimensionLookupCounter = 0;
      } catch (e) {
        console.error("Error resetting state variables:", e);
      }

      // 2. Clear Visual Elements (DOM)
      try {
        // Clear Visual Lists
        ['filtersList', 'computedColumnsList', 'aggregationsList', 'dimensionLookupList'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.innerHTML = '';
            el.classList.add('d-none');
            el.classList.remove('mt-3');
          }
        });

        // Clear Selected Tables (Canvas)
        const selectedTablesContainer = document.getElementById('selectedTables');
        if (selectedTablesContainer) selectedTablesContainer.innerHTML = '';

        // Show Empty Message
        const emptyMsg = document.getElementById('emptyMessage');
        if (emptyMsg) {
          emptyMsg.style.display = 'block';
        }

        // Deselect Left Panel Items
        document.querySelectorAll('.table-item.selected').forEach(el => el.classList.remove('selected'));

        // Clear Lineage Graph (if it exists)
        const graphContainer = document.getElementById('lineageGraph');
        if (graphContainer) graphContainer.innerHTML = '';

      } catch (e) {
        console.error("Error clearing UI elements:", e);
      }
    }

    /*
    ============================================================================
       SECTION 4: SIDEBAR & DRAG-DROP SYSTEM
       - Sidebar table rendering
       - Drag & Drop event handlers
       - Table sorting/filtering
    ============================================================================
    */
    // NEW: Toggle Available Tables Source
    function toggleAvailableTablesSource(sourceType) {
      const listContainer = document.getElementById('tableList'); // Assuming the UL has this ID
      if (!listContainer) return;

      listContainer.innerHTML = ''; // Clear current

      let tablesToShow = [];

      if (sourceType === 'source') {
        // Show Source Systems (Raw Layers)
        // IDs must match tableMetadata keys (e.g., crm.users)
        tablesToShow = [
          { id: 'crm.sales_orders', name: 'sales_orders', type: 'crm', icon: 'fa-shopping-cart' },
          { id: 'crm.customers', name: 'customers', type: 'crm', icon: 'fa-users' },
          { id: 'erp.products', name: 'products', type: 'erp', icon: 'fa-box' },
          { id: 'finance.transactions', name: 'transactions', type: 'finance', icon: 'fa-credit-card' },
          { id: 'erp.inventory', name: 'inventory', type: 'erp', icon: 'fa-warehouse' },
          { id: 'clickstream.web_logs', name: 'web_logs', type: 'clickstream', icon: 'fa-mouse-pointer' }
        ];
      } else {
        // Show Data Warehouse Tables (dw.*)
        // IDs must match tableMetadata keys
        tablesToShow = [
          { id: 'dw.dim_customer', name: 'dim_customer', type: 'dw', icon: 'fa-user-tag' },
          { id: 'dw.dim_product', name: 'dim_product', type: 'dw', icon: 'fa-tag' },
          { id: 'dw.fact_sales', name: 'fact_sales', type: 'dw', icon: 'fa-chart-line' },
          { id: 'dw.fact_orders', name: 'fact_orders', type: 'dw', icon: 'fa-receipt' },
          { id: 'dw.bridge_account', name: 'bridge_account', type: 'dw', icon: 'fa-link' }
        ];
      }

      // Render List
      tablesToShow.forEach(t => {
        const li = document.createElement('div');
        li.className = 'table-item';
        li.draggable = true;
        li.setAttribute('ondragstart', `drag(event, '${t.id}')`);

        // Add click functionality (consistent with existing)
        li.onclick = () => addTableToCanvas(t.id);

        // Set data-table attribute for role badge logic
        li.setAttribute('data-table', t.id);

        li.innerHTML = `
          <div>
            <span class="badge ${sourceType === 'source' ? 'bg-primary' : 'bg-secondary'} me-2">
               ${sourceType === 'source' ? 'SRC' : 'DW'}
            </span>
            <i class="fas ${t.icon} me-2 text-muted"></i>
            <strong>${t.name}</strong>
          </div>
          <small class="text-muted" style="display:block; margin-top:2px;">${sourceType === 'source' ? t.type + '.' + t.name : 'dw.' + t.name}</small>
        `;
        listContainer.appendChild(li);
      });

      // Update Sidebar Header if it exists
      const sidebarHeader = document.querySelector('.table-selector h6');
      if (sidebarHeader) sidebarHeader.innerHTML = `<i class="fas fa-database me-2"></i>Available Tables (${sourceType === 'source' ? 'Raw Layers' : 'Data Warehouse'})`;

      // Update sidebar role badges if in DM mode
      if (typeof updateSidebarRoleBadges === 'function') {
        updateSidebarRoleBadges();
      }
    }

    // Update DW table type (Dimension/Transaction)
    function updateDWTableType(type) {
      const tableNameInput = document.getElementById('dmTableName');
      const dimensionLookupSection = document.getElementById('dimensionLookupSection');
      const designTypeBadge = document.getElementById('designTypeBadge');

      if (type === 'dimension') {
        tableNameInput.placeholder = 'e.g., dim_customer, dim_product, dim_location';
        tableNameInput.value = 'dim_customer';
        designTypeBadge.innerHTML = 'ðŸ¢ Building: <strong>Data Warehouse (Dimension Table)</strong>';
        dimensionLookupSection.style.display = 'none';
      } else {
        tableNameInput.placeholder = 'e.g., fact_sales, fact_orders, bridge_account_contact';
        tableNameInput.value = 'fact_sales';
        designTypeBadge.innerHTML = 'ðŸ¢ Building: <strong>Data Warehouse (Fact Table)</strong>';
        dimensionLookupSection.style.display = 'block';
      }

      // Trigger SQL regeneration
      if (typeof generateSQL === 'function') {
        generateSQL();
      }
    }

    // Active Table Context for Modals (Fix for Table-Specific Actions)
    let activeTableContext = null;

    // Get columns from selected source tables
    function getSourceTableColumns() {
      const columns = [];

      // Get columns from all selected tables
      selectedTables.forEach(tableName => {
        if (tableMetadata[tableName]) {
          tableMetadata[tableName].columns.forEach(col => {
            const tableAlias = tableName.split('.')[1];
            // Include all columns, but prioritize FK columns
            const displayName = `${tableAlias}.${col.name}`;
            const columnInfo = {
              value: col.name,
              label: displayName,
              sourceTable: tableName, // Added for strict filtering
              isFK: col.isFK || false,
              isPK: col.isPK || false
            };
            columns.push(columnInfo);
          });
        }
      });

      // If no tables selected, return empty array
      if (columns.length === 0) {
        return [];
      }

      // Sort to show FK columns first
      columns.sort((a, b) => {
        if (a.isFK && !b.isFK) return -1;
        if (!a.isFK && b.isFK) return 1;
        return a.label.localeCompare(b.label);
      });

      return columns;
    }

    // Get available dimension tables from schema
    function getDimensionTables() {
      // Return dimension tables for all scenarios (DM and DW)
      // In production, this would fetch from the actual catalog/schema
      return [
        { value: 'main.dw.dim_customer', label: 'dim_customer' },
        { value: 'main.dw.dim_product', label: 'dim_product' },
        { value: 'main.dw.dim_location', label: 'dim_location' },
        { value: 'main.dw.dim_date', label: 'dim_date' },
        { value: 'main.dw.dim_employee', label: 'dim_employee' },
        { value: 'main.dw.dim_account', label: 'dim_account' }
      ];
    }

    /*
    ============================================================================
       SECTION 5: TRANSFORMATION MODALS (LOOKUPS, FILTERS)
       - Lookup configuration
       - Filter builders
       - Computed columns
    ============================================================================
    */
    // Add dimension lookup
    function addDimensionLookup() {
      dimensionLookupCounter++;
      const id = `dimLookup-${dimensionLookupCounter}`;

      // Get available columns and dimension tables
      const sourceColumns = getSourceTableColumns();
      const dimensionTables = getDimensionTables();

      // Check if we have the necessary data
      if (sourceColumns.length === 0) {
        showNotification('Please add source tables first before creating dimension lookups', 'warning');
        return;
      }

      if (dimensionTables.length === 0) {
        showNotification('No dimension tables available. Make sure you are in Data Warehouse mode with Fact table selected.', 'warning');
        return;
      }

      // Build column options with FK indication
      const columnOptions = sourceColumns.map(col => {
        const fkIndicator = col.isFK ? ' ðŸ”‘' : '';
        return `<option value="${col.value}">${col.label}${fkIndicator}</option>`;
      }).join('');

      // Build dimension table options
      const dimTableOptions = dimensionTables.map(dim =>
        `<option value="${dim.value}">${dim.label}</option>`
      ).join('');

      const html = `
        <div class="alert alert-light border mb-2" id="${id}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong><i class="fas fa-link me-1"></i>Lookup #${dimensionLookupCounter}</strong>
            <button class="btn btn-sm btn-outline-danger" onclick="removeDimensionLookup('${id}')"
                    title="Remove this lookup">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label small mb-1">
                <strong>1. Foreign Key</strong>
                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip"
                   title="Select the column in your fact table that references the dimension"></i>
              </label>
              <select class="form-select form-select-sm" id="${id}-fk" onchange="generateSQL()">
                <option value="">Choose fact column...</option>
                ${columnOptions}
              </select>
              <small class="text-muted" style="font-size: 0.7rem;">
                <i class="fas fa-table me-1"></i>From fact table (ðŸ”‘ = FK)
              </small>
            </div>
            <div class="col-md-3">
              <label class="form-label small mb-1">
                <strong>2. Dimension Table</strong>
                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip"
                   title="Select which dimension table to join"></i>
              </label>
              <select class="form-select form-select-sm" id="${id}-dim" onchange="updateDimensionColumns('${id}'); generateSQL()">
                <option value="">Choose dimension...</option>
                ${dimTableOptions}
              </select>
              <small class="text-muted" style="font-size: 0.7rem;">
                <i class="fas fa-database me-1"></i>Target dimension
              </small>
            </div>
            <div class="col-md-3">
              <label class="form-label small mb-1">
                <strong>3. Join Key</strong>
                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip"
                   title="Select the primary key column in the dimension table"></i>
              </label>
              <select class="form-select form-select-sm" id="${id}-dimkey" onchange="generateSQL()">
                <option value="">Choose key column...</option>
              </select>
              <small class="text-muted" style="font-size: 0.7rem;">
                <i class="fas fa-key me-1"></i>Dimension PK
              </small>
            </div>
            <div class="col-md-3">
              <label class="form-label small mb-1">
                <strong>4. Join Type</strong>
                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip"
                   title="INNER: Only matching rows | LEFT: All fact rows | RIGHT: All dimension rows"></i>
              </label>
              <select class="form-select form-select-sm" id="${id}-join" onchange="generateSQL()">
                <option value="INNER" selected>INNER (matching only)</option>
                <option value="LEFT">LEFT (all fact rows)</option>
                <option value="RIGHT">RIGHT (all dim rows)</option>
              </select>
              <small class="text-muted" style="font-size: 0.7rem;">
                <i class="fas fa-code-branch me-1"></i>Join strategy
              </small>
            </div>
          </div>
          <div class="mt-2 p-2 bg-light rounded" style="font-size: 0.75rem;">
            <i class="fas fa-info-circle text-primary me-1"></i>
            <strong>Result:</strong> <code>fact_table.${id}-fk</code> = <code>dimension_table.${id}-dimkey</code>
          </div>
        </div>
      `;

      const container = document.getElementById('dimensionLookupList');
      container.classList.remove('d-none');
      container.classList.add('mt-3');
      container.insertAdjacentHTML('beforeend', html);

      // Initialize Bootstrap tooltips for the new lookup
      const tooltips = document.querySelectorAll(`#${id} [data-bs-toggle="tooltip"]`);
      tooltips.forEach(el => new bootstrap.Tooltip(el));
    }

    // Update dimension columns when dimension table is selected
    function updateDimensionColumns(lookupId) {
      const dimTable = document.getElementById(`${lookupId}-dim`).value;
      const dimKeySelect = document.getElementById(`${lookupId}-dimkey`);

      // In production, fetch actual columns from the selected dimension table
      // For now, use mock data based on table name
      let columns = [];

      if (dimTable.includes('dim_customer')) {
        columns = ['customer_id', 'customer_key', 'customer_sk'];
      } else if (dimTable.includes('dim_product')) {
        columns = ['product_id', 'product_key', 'product_sk'];
      } else if (dimTable.includes('dim_location')) {
        columns = ['location_id', 'location_key', 'location_sk'];
      } else if (dimTable.includes('dim_date')) {
        columns = ['date_id', 'date_key', 'date_sk'];
      } else {
        columns = ['id', 'key', 'surrogate_key'];
      }

      // Update dimension key dropdown
      dimKeySelect.innerHTML = '<option value="">Select key...</option>' +
        columns.map(col => `<option value="${col}">${col}</option>`).join('');
    }

    // Remove dimension lookup
    function removeDimensionLookup(id) {
      document.getElementById(id).remove();
      if (typeof generateSQL === 'function') {
        generateSQL();
      }
    }

    // --- Enhanced Lookup Modal Functions ---
    // [LEGACY] Duplicate openLookupModal and related functions removed. 
    // See lines 10252+ for active implementation.

    // --- Enhanced Computed Column Functions ---
    function openComputedColumnModal() {
      document.getElementById('computedColName').value = '';
      document.getElementById('computedColExpr').value = '';

      // Populate Available Columns Helper
      const container = document.getElementById('computedAvailableCols');
      container.innerHTML = '';

      const cols = getSourceTableColumns();
      cols.forEach(col => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-secondary text-start w-100 mb-1';
        btn.style.fontSize = '0.8rem';
        btn.innerHTML = `<i class="fas fa-columns text-muted me-2"></i> ${col.label}`;
        btn.onclick = () => insertAtCursor(document.getElementById('computedColExpr'), col.label);
        container.appendChild(btn);
      });

      new bootstrap.Modal(document.getElementById('computedColumnModal')).show();
    }

    // Helper to insert text at cursor position
    function insertAtCursor(myField, myValue) {
      if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
      } else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        myField.value = myField.value.substring(0, startPos)
          + myValue
          + myField.value.substring(endPos, myField.value.length);
      } else {
        myField.value += myValue;
      }
    }

    // [LEGACY] Duplicate saveComputedColumnFromModal and removeComputedColumn removed.
    // See lines 10438+ for active implementation.

    // --- Enhanced Filter Functions ---
    let filterRowCount = 0;

    function openFilterModal(tableName = null) {
      // Set Active Context
      activeTableContext = tableName;

      // Reset
      document.getElementById('filterCondition').value = '';
      document.getElementById('filterBuilderPreview').innerText = '...';
      document.getElementById('filterRowsContainer').innerHTML = ''; // Clear rows

      // Update Modal Title
      const modalTitle = document.querySelector('#filterModal .modal-title');
      if (tableName) {
        modalTitle.innerHTML = `<i class="fas fa-filter text-primary"></i> Filter Table: ${tableName}`;
      } else {
        modalTitle.innerHTML = `<i class="fas fa-filter text-primary"></i> Add WHERE Filter`;
      }

      // Initialize with one empty row, passing table name context
      addFilterRow(tableName);

      new bootstrap.Modal(document.getElementById('filterModal')).show();
    }

    function addFilterRow(tableName = null) {
      // Use global context if argument is null (e.g. "Add Condition" button)
      const targetTable = tableName || activeTableContext;

      filterRowCount++;
      const rowId = `filter-row-${filterRowCount}`;
      const isFirst = document.getElementById('filterRowsContainer').children.length === 0;

      let cols = getSourceTableColumns();

      // STRICT FILTERING: If a specific table context exists, show ONLY columns from that table
      if (targetTable) {
        cols = cols.filter(c => c.sourceTable === targetTable);
      }

      const colOptions = cols.map(c => `<option value="${c.label}">${c.label}</option>`).join('');


      const html = `
            <div class="row g-2 align-items-center mb-2 filter-row" id="${rowId}">
                ${!isFirst ? `
                <div class="col-md-2">
                    <select class="form-select form-select-sm filter-logic h-100" onchange="updateFilterPreview()">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                </div>
                ` : `<div class="col-md-2 text-end text-muted small">Where</div>`}
                
                <div class="col-md-3">
                <select class="form-select form-select-sm filter-col" onchange="updateFilterPreview()">
                    ${colOptions}
                </select>
            </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm filter-op" onchange="updateFilterPreview()">
                        <option value="=">=</option>
                        <option value="!=">!=</option>
                        <option value=">">></option>
                        <option value="<"><</option>
                        <option value=">=">>=</option>
                        <option value="<="><=</option>
                        <option value="LIKE">LIKE</option>
                        <option value="IS NULL">IS NULL</option>
                        <option value="IS NOT NULL">IS NOT NULL</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm filter-val" 
                           placeholder="Value" onkeyup="updateFilterPreview()">
                </div>
                 <div class="col-md-1">
                    ${!isFirst ? `
                    <button class="btn btn-sm btn-link text-danger" onclick="removeFilterRow('${rowId}')">
                        <i class="fas fa-times"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
      document.getElementById('filterRowsContainer').insertAdjacentHTML('beforeend', html);
      updateFilterPreview();
    }

    function removeFilterRow(id) {
      document.getElementById(id).remove();
      updateFilterPreview();
    }

    function updateFilterPreview() {
      const rows = document.querySelectorAll('.filter-row');
      let sql = '';

      rows.forEach((row, index) => {
        const col = row.querySelector('.filter-col').value;
        const op = row.querySelector('.filter-op').value;
        const val = row.querySelector('.filter-val').value;

        let part = '';
        if (op === 'IS NULL' || op === 'IS NOT NULL') {
          part = `${col} ${op}`;
        } else {
          const valFormatted = isNaN(val) ? `'${val}'` : val;
          part = `${col} ${op} ${valFormatted}`;
        }

        if (index === 0) {
          sql = part;
        } else {
          const logic = row.querySelector('.filter-logic').value;
          sql += ` ${logic} ${part}`;
        }
      });

      document.getElementById('filterBuilderPreview').innerText = sql || '...';
    }

    function saveFilterFromModal() {
      // Check which tab is active
      const isBasic = document.getElementById('simple-filter-tab').classList.contains('active');
      let condition = '';

      if (isBasic) {
        condition = document.getElementById('filterBuilderPreview').innerText;
        if (condition === '...') condition = '';
      } else {
        condition = document.getElementById('filterCondition').value;
      }

      if (!condition) {
        showNotification('Please enter a condition', 'warning');
        return;
      }

      filterCounter++;
      const id = `filter-${filterCounter}`;
      const tableName = activeTableContext;

      filters.push({ id: id, condition: condition, table: tableName });

      const tableBadge = tableName ? `<span class="badge bg-info text-dark me-2" title="Applied to ${tableName}">${tableName}</span>` : '';

      const html = `
          <div class="transformation-item" id="${id}">
            <div class="d-flex justify-content-between align-items-center">
               <div>
                  ${tableBadge}
                  <span class="badge bg-warning text-dark me-2">WHERE</span>
                  <code>${condition}</code>
               </div>
               <button class="btn btn-sm btn-outline-danger" onclick="removeFilter('${id}')">
                  <i class="fas fa-trash-alt"></i>
               </button>
             </div>
          </div>
        `;

      const container = document.getElementById('filtersList');
      container.classList.remove('d-none');
      container.classList.add('mt-3');
      container.insertAdjacentHTML('beforeend', html);
      bootstrap.Modal.getInstance(document.getElementById('filterModal')).hide();
      generateSQL();
    }

    function removeFilter(id) {
      filters = filters.filter(f => f.id !== id);
      document.getElementById(id).remove();
      generateSQL();
    }

    // --- Manual Join Functions DELETED ---

    // --- Enhanced Aggregation Functions ---
    function openAggregationModal(tableName = null) {
      // Set Context
      activeTableContext = tableName;

      // 1. Load existing SQL text for THIS table
      const config = aggregationConfig[tableName || 'global'] || {};
      document.getElementById('aggExpressions').value = config.expressions || '';

      // Update Modal Title
      const modalTitle = document.querySelector('#aggregationModal .modal-title');
      if (tableName) {
        modalTitle.innerHTML = `<i class="fas fa-calculator text-primary"></i> Aggregations: ${tableName}`;
      } else {
        modalTitle.innerHTML = `<i class="fas fa-calculator text-primary"></i> Configure Aggregations`;
      }

      // 2. Populate Builders with STRICT FILTERING
      let sourceCols = getSourceTableColumns();
      if (tableName) {
        // Use sourceTable property for reliable filtering
        sourceCols = sourceCols.filter(c => c.sourceTable === tableName);
      }

      // Group By List
      const gbList = document.getElementById('aggGroupByList');
      const currentGB = (config.groupBy || '').split(',').map(s => s.trim());

      gbList.innerHTML = sourceCols.map(col => {
        const isChecked = currentGB.includes(col.label) ? 'checked' : '';
        return `
            <div class="form-check">
               <input class="form-check-input agg-gb-check" type="checkbox" value="${col.label}" id="gb_${col.value}" ${isChecked}>
               <label class="form-check-label small" for="gb_${col.value}">${col.label}</label>
            </div>
          `;
      }).join('');

      // Func Col
      const funcCol = document.getElementById('aggFuncCol');
      funcCol.innerHTML = '<option value="">Select column...</option>' +
        sourceCols.map(c => `<option value="${c.label}">${c.label}</option>`).join('');

      // Expression List (Mock for now, as we don't parse back the SQL fully)
      document.getElementById('aggExpressionList').innerHTML = ''; // Clear

      new bootstrap.Modal(document.getElementById('aggregationModal')).show();
    }

    function addAggExpression() {
      const col = document.getElementById('aggFuncCol').value;
      const type = document.getElementById('aggFuncType').value;

      if (!col) return;

      const expr = `${type}(${col}) AS ${type.toLowerCase()}_${col.split('.').pop()}`;

      // Add to manual override textarea
      const textArea = document.getElementById('aggExpressions');
      const currentVal = textArea.value.trim();
      textArea.value = currentVal ? `${currentVal}, ${expr}` : expr;

      // Add to visual list
      const html = `<div class="badge bg-light text-dark border me-1 mb-1">${expr}</div>`;
      document.getElementById('aggExpressionList').insertAdjacentHTML('beforeend', html);
    }

    function saveAggregationFromModal() {
      // 1. Get Group By from Checkboxes
      const gbCols = [];
      document.querySelectorAll('.agg-gb-check:checked').forEach(cb => gbCols.push(cb.value));
      const groupBy = gbCols.join(', ');

      // 2. Get Expressions from Textarea
      const expressions = document.getElementById('aggExpressions').value.trim();

      if (!expressions && !groupBy) {
        // If clearing everything
        removeAggregation(activeTableContext);
        bootstrap.Modal.getInstance(document.getElementById('aggregationModal')).hide();
        return;
      }

      if (!expressions) {
        showNotification('Please specify at least one aggregation expression.', 'warning');
        return;
      }

      // Store by Table Context
      const targetTable = activeTableContext || 'global';
      aggregationConfig[targetTable] = {
        expressions: expressions,
        groupBy: groupBy
      };

      // Update UI Summary (Render All)
      renderAggregationsList();

      bootstrap.Modal.getInstance(document.getElementById('aggregationModal')).hide();
      generateSQL();
      showNotification('Aggregations applied', 'success');
    }

    function renderAggregationsList() {
      const container = document.getElementById('aggregationsList');
      container.innerHTML = '';

      const keys = Object.keys(aggregationConfig);
      if (keys.length > 0) {
        container.classList.remove('d-none');
        container.classList.add('mt-3');
      } else {
        container.classList.add('d-none');
        container.classList.remove('mt-3');
      }

      Object.keys(aggregationConfig).forEach(tbl => {
        const cfg = aggregationConfig[tbl];
        const tblBadge = tbl !== 'global' ? `<span class="badge bg-info text-dark me-2">${tbl}</span>` : '';

        container.innerHTML += `
            <div class="transformation-item">
               <div class="d-flex justify-content-between align-items-center">
                 <div>
                    <span class="badge bg-secondary me-2">AGG</span>
                    ${tblBadge}
                    <small class="text-muted">Group By: <strong>${cfg.groupBy || 'None'}</strong></small>
                    <div class="small text-muted mt-1"><code>${cfg.expressions}</code></div>
                 </div>
                 <button class="btn btn-sm btn-outline-danger" onclick="removeAggregation('${tbl}')">
                    <i class="fas fa-trash-alt"></i>
                 </button>
               </div>
            </div>
          `;
      });
    }

    function removeAggregation(tableName = null) {
      if (tableName && aggregationConfig[tableName]) {
        delete aggregationConfig[tableName];
      } else if (!tableName) {
        // Legacy/Global clear catch-all
        if (activeTableContext) {
          delete aggregationConfig[activeTableContext];
        } else {
          aggregationConfig = {};
        }
      }

      renderAggregationsList();
      generateSQL();
      showNotification('Aggregations removed', 'info');
    }

    function updateMetadataConnection() {
      const selector = document.getElementById('metaConnectionSelect');
      const selectedConnection = selector.value;

      console.log('Metadata connection changed to:', selectedConnection);

      if (selectedConnection === 'new') {
        // Navigate to connection setup only for new connection
        activateStep('connect');
        // Reset the selector after navigation
        setTimeout(() => {
          selector.value = 'current';
        }, 100);
        return;
      }

      // For existing connections, just switch without navigation
      const connectionNames = {
        'current': 'demo-workspace',
        'conn1': 'Production Workspace',
        'conn2': 'Development Workspace',
        'conn3': 'Staging Workspace'
      };

      const connectionName = connectionNames[selectedConnection] || selectedConnection;
      showNotification(`Switched to connection: ${connectionName}`, 'info');

      // Update the design screen selector to match
      const designSelector = document.getElementById('designConnectionSelect');
      if (designSelector) {
        designSelector.value = selectedConnection;
      }
    }

    function updateDesignConnection() {
      const selector = document.getElementById('designConnectionSelect');
      const selectedConnection = selector.value;

      console.log('Design connection changed to:', selectedConnection);

      if (selectedConnection === 'new') {
        // Navigate to connection setup only for new connection
        activateStep('connect');
        // Reset the selector after navigation
        setTimeout(() => {
          selector.value = 'current';
        }, 100);
        return;
      }

      // For existing connections, just switch without navigation
      const connectionNames = {
        'current': 'demo-workspace.cloud.databricks.com',
        'conn1': 'Production Workspace',
        'conn2': 'Development Workspace',
        'conn3': 'Staging Workspace'
      };

      const connectionName = connectionNames[selectedConnection] || selectedConnection;
      showNotification(`Switched to connection: ${connectionName}`, 'info');

      // Update the metadata screen selector to match
      const metaSelector = document.getElementById('metaConnectionSelect');
      if (metaSelector) {
        metaSelector.value = selectedConnection;
      }

      // Regenerate SQL with new connection context
      if (typeof generateSQL === 'function') {
        generateSQL();
      }
    }

    // Existing Functions (kept for compatibility)
    function toggleDetails(btn) {
      // No longer needed in horizontal mode, but kept to prevent errors if called
      console.log('Toggle details deprecated in horizontal mode');
    }

    function testConnection() {
      const btn = document.getElementById('btnTestConnection');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
      btn.disabled = true;

      return new Promise((resolve) => {
        setTimeout(() => {
          document.getElementById('connectionStatus').className = 'connection-status connected';
          document.getElementById('connectionText').innerText = 'Connected to demo-workspace';
          document.getElementById('connectionText').classList.add('text-success', 'fw-bold');



          btn.innerHTML = '<i class="fas fa-check"></i> Connection Verified';
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');

          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
            btn.disabled = false;
            resolve(true);
          }, 2000);
        }, 1500);
      });
    }

    async function saveAndLoadMetadata() {
      const btn = document.getElementById('btnSaveLoad');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      btn.disabled = true;

      // First verify connection if not already done (simplified check)
      if (!document.getElementById('connectionStatus').classList.contains('connected')) {
        await testConnection();
      }

      btn.innerHTML = '<i class="fas fa-check"></i> Saved';

      // Mark step as completed in header
      document.querySelector('.stepper-step[onclick*="connect"]').classList.add('completed');

      // Logic to handle "Use for Target" preference
      if (document.getElementById('useSourceForTarget').checked) {
        window.useSourceForTargetPreference = true;
        // Pre-select 'same' mode for target to ensure consistency
        const targetSameRadio = document.getElementById('targetConnSame');
        if (targetSameRadio) targetSameRadio.checked = true;
      } else {
        window.useSourceForTargetPreference = false;
      }

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        activateStep('metadata');
      }, 1000);
    }

    function connectToDatabricks() {
      // Deprecated, redirected to saveAndLoadMetadata for backward compatibility if called
      saveAndLoadMetadata();
    }

    function updateSchemaOptions() {
      const catalog = document.getElementById('metaCatalogSelect').value;
      const schemaSelect = document.getElementById('metaSchemaSelect');

      // Clear existing options
      schemaSelect.innerHTML = '<option value="all" selected>All Schemas</option>';

      // Add schemas based on selected catalog
      if (catalog === 'main') {
        schemaSelect.innerHTML += '<option value="dw">dw</option>';
        schemaSelect.innerHTML += '<option value="dm">dm</option>';
        schemaSelect.innerHTML += '<option value="staging">staging</option>';
      } else if (catalog === 'analytics') {
        schemaSelect.innerHTML += '<option value="reports">reports</option>';
        schemaSelect.innerHTML += '<option value="dashboards">dashboards</option>';
      } else if (catalog === 'sandbox') {
        schemaSelect.innerHTML += '<option value="dev">dev</option>';
        schemaSelect.innerHTML += '<option value="test">test</option>';
      }
    }

    function loadMetadata() {
      // Get selected catalog and schema
      const selectedCatalog = document.getElementById('metaCatalogSelect').value;
      const selectedSchema = document.getElementById('metaSchemaSelect').value;

      // Find the button relative to the function call or by ID if possible, 
      // but here we can just target the specific button we added
      const btn = document.querySelector('#step-metadata button[onclick="loadMetadata()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';

      setTimeout(() => {
        // Update UI with selected catalog info
        document.getElementById('metaCatalog').innerText = selectedCatalog;

        // Simulate different data based on catalog and schema
        let schemaCount = '3';
        let tableCount = '47';

        if (selectedCatalog === 'analytics') {
          schemaCount = selectedSchema === 'all' ? '2' : '1';
          tableCount = selectedSchema === 'all' ? '24' : '12';
        } else if (selectedSchema !== 'all') {
          schemaCount = '1';
          tableCount = selectedSchema === 'dw' ? '47' : (selectedSchema === 'dm' ? '23' : '15');
        }

        document.getElementById('schemaCount').innerText = schemaCount;
        document.getElementById('tableCount').innerText = tableCount;

        btn.innerHTML = '<i class="fas fa-check"></i> Metadata Refreshed';

        // Show Success Alert
        const alertBox = document.getElementById('metadataSuccessAlert');
        if (alertBox) alertBox.style.display = 'block';

        // Show Metadata Explorer Button
        const explorerBtn = document.getElementById('btnViewMetadataExplorer');
        if (explorerBtn) explorerBtn.style.display = 'inline-block';

        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 2000);

        // Mark step as completed
        document.querySelector('.stepper-step[onclick*="metadata"]').classList.add('completed');
      }, 1500);
    }

    function executeJob() {
      const btn = event.target;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check"></i> Job Started Successfully';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        document.querySelector('.stepper-step[onclick*="execute"]').classList.add('completed');
        // Removed auto-advance to monitor step as it was removed
      }, 1500);
    }

    // File Drop Functionality
    let fileSourceCounter = 0;
    const fileSources = [];

    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      const canvas = document.getElementById('designerCanvas');
      const overlay = document.getElementById('fileDropOverlay');
      canvas.classList.add('drag-over');
      overlay.classList.add('active');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      // Only remove if leaving the canvas entirely
      if (e.target.id === 'designerCanvas') {
        const canvas = document.getElementById('designerCanvas');
        const overlay = document.getElementById('fileDropOverlay');
        canvas.classList.remove('drag-over');
        overlay.classList.remove('active');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();

      const canvas = document.getElementById('designerCanvas');
      const overlay = document.getElementById('fileDropOverlay');
      canvas.classList.remove('drag-over');
      overlay.classList.remove('active');

      const files = e.dataTransfer.files;
      if (files.length === 0) return;

      // Process each dropped file
      Array.from(files).forEach(file => {
        const fileName = file.name;
        const fileExt = fileName.split('.').pop().toLowerCase();

        if (['csv', 'xlsx', 'xls'].includes(fileExt)) {
          parseFile(file);
        } else {
          alert(`Unsupported file type: ${fileExt}. Please upload CSV or Excel files.`);
        }
      });
    }

    function parseFile(file) {
      const reader = new FileReader();
      const fileName = file.name;
      const fileExt = fileName.split('.').pop().toLowerCase();

      reader.onload = function (e) {
        const content = e.target.result;

        if (fileExt === 'csv') {
          parseCSV(content, fileName);
        } else {
          // For Excel files, show a simplified version
          // In production, you'd use a library like SheetJS
          alert('Excel parsing requires additional library. Please use CSV for now.');
        }
      };

      reader.readAsText(file);
    }

    function parseCSV(content, fileName) {
      const lines = content.split('\n').filter(line => line.trim());
      if (lines.length === 0) {
        alert('File is empty');
        return;
      }

      // Parse header row
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

      // Parse data rows (first 5 for preview)
      const dataRows = [];
      for (let i = 1; i < Math.min(6, lines.length); i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        dataRows.push(values);
      }

      // Infer data types from first data row
      const columns = headers.map((header, index) => {
        const sampleValue = dataRows[0]?.[index] || '';
        let dataType = 'STRING';

        if (!isNaN(sampleValue) && sampleValue !== '') {
          dataType = sampleValue.includes('.') ? 'DOUBLE' : 'BIGINT';
        } else if (sampleValue.match(/^\d{4}-\d{2}-\d{2}/)) {
          dataType = 'DATE';
        }

        return {
          name: header || `column_${index + 1}`,
          type: dataType,
          nullable: true
        };
      });

      // Create file source object
      const fileSource = {
        id: `file_${++fileSourceCounter}`,
        fileName: fileName,
        tableName: fileName.replace(/\.[^/.]+$/, '').replace(/[^a-zA-Z0-9_]/g, '_'),
        columns: columns,
        preview: dataRows,
        rowCount: lines.length - 1
      };

      // Initialize column schema for file source
      if (!columnSchema[fileSource.id]) columnSchema[fileSource.id] = {};
      columns.forEach(col => {
        columnSchema[fileSource.id][col.name] = {
          originalName: col.name,
          name: col.name,
          dataType: col.type.toUpperCase(),
          length: null,
          precision: null,
          scale: null,
          nullable: col.nullable,
          isPK: false
        };
      });

      fileSources.push(fileSource);
      addFileToCanvas(fileSource);
    }

    function addFileToCanvas(fileSource) {
      const selectedTables = document.getElementById('selectedTables');
      const emptyMessage = document.getElementById('emptyMessage');

      // Hide empty message
      if (emptyMessage) {
        emptyMessage.style.display = 'none';
      }

      const tableCard = document.createElement('div');
      tableCard.className = 'table-card file-source';
      tableCard.id = fileSource.id;
      tableCard.innerHTML = `
        <div class="table-card-header">
          <div>
            <i class="fas fa-file text-warning"></i>
            <span class="table-card-title">${fileSource.tableName}</span>
            <small class="text-muted ms-2"><i class="fas fa-file-csv"></i> ${fileSource.fileName} â€¢ ${fileSource.rowCount} rows</small>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="showFilePreview('${fileSource.id}')" title="Preview Data">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFileSource('${fileSource.id}')" title="Remove File">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="mb-2">
          <button class="btn btn-sm btn-outline-primary" onclick="selectAllFileColumns('${fileSource.id}')">
            Select All
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllFileColumns('${fileSource.id}')">
            Deselect All
          </button>
        </div>
        <div class="column-list">
          ${fileSource.columns.map((col, index) => `
            <div class="column-schema-row border-bottom" data-table="${fileSource.id}" data-column="${col.name}">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <input type="checkbox" class="column-checkbox me-2" 
                         id="${fileSource.id}_col_${index}"
                         data-table="${fileSource.id}" 
                         data-column="${col.name}" 
                         checked>
                  <span class="col-name-text fw-bold text-dark" style="font-size: 0.85rem;">${col.name}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted col-type-text" style="font-size: 0.75rem;">${col.type}</small>
                  <button class="btn btn-sm btn-link text-primary p-0" 
                          onclick="openFileColumnEditor('${fileSource.id}', '${col.name}')" 
                          title="Edit Column Configuration">
                    <i class="fas fa-pencil-alt"></i>
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      selectedTables.appendChild(tableCard);
    }

    function removeFileSource(fileId) {
      const index = fileSources.findIndex(f => f.id === fileId);
      if (index > -1) {
        fileSources.splice(index, 1);
      }

      const card = document.getElementById(fileId);
      if (card) {
        card.remove();
      }

      // Show empty message if no tables
      const selectedTables = document.getElementById('selectedTables');
      const emptyMessage = document.getElementById('emptyMessage');
      if (selectedTables.children.length === 0 && emptyMessage) {
        emptyMessage.style.display = 'block';
      }
    }

    // Show file preview in modal
    function showFilePreview(fileId) {
      const fileSource = fileSources.find(f => f.id === fileId);
      if (!fileSource) {
        alert('File source not found');
        return;
      }

      let previewHeader = '<thead><tr>';
      fileSource.columns.forEach(col => {
        previewHeader += `<th>${col.name}</th>`;
      });
      previewHeader += '</tr></thead>';

      let previewBody = '<tbody>';
      fileSource.preview.forEach(row => {
        previewBody += '<tr>';
        row.forEach(cell => {
          previewBody += `<td>${cell || ''}</td>`;
        });
        previewBody += '</tr>';
      });
      previewBody += '</tbody>';

      const tableHtml = `
        <div class="preview-table-container" style="max-height: 400px; margin-top: 0;">
          <table class="table table-sm table-bordered table-hover table-striped">
            ${previewHeader}
            ${previewBody}
          </table>
        </div>
      `;

      $('#previewModalTitle').text(`Data Preview: ${fileSource.fileName}`);
      $('#previewModalBody').html(tableHtml);

      const modal = new bootstrap.Modal(document.getElementById('dataPreviewModal'));
      modal.show();
    }

    // Select all columns for a file
    function selectAllFileColumns(fileId) {
      $(`input[data-table="${fileId}"]`).prop('checked', true);
    }

    // Deselect all columns for a file
    function deselectAllFileColumns(fileId) {
      $(`input[data-table="${fileId}"]`).prop('checked', false);
    }

    // Open column editor for file columns
    function openFileColumnEditor(fileId, columnName) {
      currentEditTable = fileId;
      currentEditColumn = columnName;
      const schema = columnSchema[fileId][columnName];

      $('#editTableName').val(fileId);
      $('#editOriginalName').val(columnName);
      $('#editColumnName').val(schema.name);

      // Populate Data Types
      const typeSelect = $('#editColumnType');
      typeSelect.empty();
      dataTypes.forEach(dt => {
        typeSelect.append(new Option(dt, dt));
      });
      typeSelect.val(schema.dataType);

      $('#editColumnLength').val(schema.length || '');
      $('#editColumnPrecision').val(schema.precision || '');
      $('#editColumnScale').val(schema.scale || '');
      $('#editColumnNullable').prop('checked', schema.nullable);

      toggleEditTypeFields();

      const modal = new bootstrap.Modal(document.getElementById('columnEditModal'));
      modal.show();
    }

    // ===== Target Configuration Functions =====

    function openTargetConfigModal() {
      // Initialize with current values or defaults
      // Use dmTableName from the main design section
      const currentTableName = document.getElementById('dmTableName').value;

      if (!currentTableName && selectedTables.length > 0) {
        autoGenerateTableName();
      }

      // Initialize UI state
      updateTargetConnectionUI();
      updateFullTargetPath();

      const modal = new bootstrap.Modal(document.getElementById('targetConfigModal'));
      modal.show();
    }

    function updateTargetConnectionUI() {
      const mode = document.querySelector('input[name="targetConnectionMode"]:checked').value;
      const selectGroup = document.getElementById('targetConnSelectGroup');
      const newGroup = document.getElementById('targetConnNewGroup');
      const connSelect = document.getElementById('targetConnectionSelect');
      const helpText = document.getElementById('targetConnHelp');

      if (mode === 'same') {
        selectGroup.style.display = 'block';
        newGroup.style.display = 'none';
        connSelect.disabled = true;
        connSelect.value = 'current';
        helpText.textContent = 'Using the same connection defined in the Connect step.';
      } else if (mode === 'existing') {
        selectGroup.style.display = 'block';
        newGroup.style.display = 'none';
        connSelect.disabled = false;
        helpText.textContent = 'Select a pre-configured connection from the list.';
      } else if (mode === 'new') {
        selectGroup.style.display = 'none';
        newGroup.style.display = 'block';
      }
    }

    function updateTargetSchemaOptions() {
      const catalog = document.getElementById('targetCatalog').value;
      const schemaSelect = document.getElementById('targetSchema');

      // Clear existing options
      schemaSelect.innerHTML = '';

      // Add schemas based on selected catalog
      if (catalog === 'main') {
        schemaSelect.innerHTML = `
          <option value="dw">dw</option>
          <option value="dm" selected>dm</option>
          <option value="staging">staging</option>
        `;
      } else if (catalog === 'analytics') {
        schemaSelect.innerHTML = `
          <option value="reports">reports</option>
          <option value="dashboards">dashboards</option>
        `;
      } else if (catalog === 'sandbox') {
        schemaSelect.innerHTML = `
          <option value="dev">dev</option>
          <option value="test">test</option>
        `;
      }

      updateFullTargetPath();
    }

    function updateFullTargetPath() {
      const catalog = document.getElementById('targetCatalog')?.value || 'main';
      const schema = document.getElementById('targetSchema')?.value || 'dm';
      // Use dmTableName from the main design section
      const tableName = document.getElementById('dmTableName')?.value || 'table_name';

      const fullPath = `${catalog}.${schema}.${tableName}`;
      document.getElementById('fullTargetPath').textContent = fullPath;

      // Also update compact display
      if (document.getElementById('compactTargetPath')) {
        document.getElementById('compactTargetPath').textContent = fullPath;
      }
    }

    function autoGenerateTableName() {
      if (selectedTables.length === 0) {
        alert('Please add at least one source table first');
        return;
      }

      // Generate table name based on selected source tables
      const baseName = selectedTables[0].split('.').pop(); // Get table name without schema
      const suggestedName = `${baseName}_transformed`;

      // Update the main design section input
      document.getElementById('dmTableName').value = suggestedName;
      updateFullTargetPath();
    }

    function saveTargetConfig() {
      // Use dmTableName from the main design section
      const tableName = document.getElementById('dmTableName').value.trim();

      // Validation
      if (!tableName) {
        document.getElementById('targetValidation').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Please enter a table name in the Design section
          </div>
        `;
        document.getElementById('targetValidation').style.display = 'block';
        return;
      }

      // Validate table name (alphanumeric and underscores only)
      if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(tableName)) {
        document.getElementById('targetValidation').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Table name must start with a letter or underscore and contain only letters, numbers, and underscores
          </div>
        `;
        document.getElementById('targetValidation').style.display = 'block';
        return;
      }

      // Update button label to show configured state
      const fullPath = document.getElementById('fullTargetPath').textContent;
      document.getElementById('targetConfigLabel').innerHTML = `<i class="fas fa-check-circle text-success"></i> ${fullPath}`;

      // Show compact display
      document.getElementById('targetPathDisplay').style.display = 'block';

      // Hide validation
      document.getElementById('targetValidation').style.display = 'none';

      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('targetConfigModal'));
      modal.hide();

      // Regenerate SQL with new target
      generateSQL();
    }

    // ... (Keep other existing functions like generateSQL, addTableToCanvas etc.) ...

    /*
    ============================================================================
       SECTION 6: CANVAS MANAGEMENT & VISUALIZATION
       - Adding/Removing tables
       - Canvas rendering helpers
       - Table preview logic
    ============================================================================
    */
    // Mock functions for the designer (simplified from original)
    function filterTables(query) {
      const tables = document.querySelectorAll('.table-item');
      tables.forEach(table => {
        const text = table.innerText.toLowerCase();
        if (text.includes(query.toLowerCase())) {
          table.style.display = 'block';
        } else {
          table.style.display = 'none';
        }
      });
    }

    // Add table to canvas
    function generateMockData(tableName, columns) {
      const mockData = [];
      for (let i = 0; i < 5; i++) {
        const row = {};
        columns.forEach(col => {
          if (col.name.includes('id')) row[col.name] = Math.floor(Math.random() * 1000) + 1;
          else if (col.name.includes('name')) row[col.name] = ['Alice', 'Bob', 'Charlie', 'David', 'Eve'][i];
          else if (col.name.includes('date')) row[col.name] = '2023-01-0' + (i + 1);
          else if (col.name.includes('amount') || col.name.includes('price')) row[col.name] = (Math.random() * 1000).toFixed(2);
          else if (col.type === 'int' || col.type === 'bigint') row[col.name] = Math.floor(Math.random() * 100);
          else row[col.name] = 'Sample ' + (i + 1);
        });
        mockData.push(row);
      }
      return mockData;
    }

    function showTablePreview(tableName) {
      const metadata = tableMetadata[tableName];
      const mockData = generateMockData(tableName, metadata.columns);

      let previewHeader = '<thead><tr>';
      metadata.columns.forEach(col => {
        previewHeader += `<th>${col.name}</th>`;
      });
      previewHeader += '</tr></thead>';

      let previewBody = '<tbody>';
      mockData.forEach(row => {
        previewBody += '<tr>';
        metadata.columns.forEach(col => {
          previewBody += `<td>${row[col.name]}</td>`;
        });
        previewBody += '</tr>';
      });
      previewBody += '</tbody>';

      const tableHtml = `
          <div class="preview-table-container" style="max-height: 400px; margin-top: 0;">
            <table class="table table-sm table-bordered table-hover table-striped">
              ${previewHeader}
              ${previewBody}
            </table>
          </div>
        `;

      $('#previewModalTitle').text(`Data Preview: ${tableName}`);
      $('#previewModalBody').html(tableHtml);

      const modal = new bootstrap.Modal(document.getElementById('dataPreviewModal'));
      modal.show();
    }

    function addTableToCanvas(tableName) {
      // Data Warehouse Restriction: Only allow 1 table
      const isDW = document.getElementById('designTypeDW').checked;
      if (isDW && selectedTables.length >= 1) {
        showNotification('Data Warehouse mode allows only one source table. Switch to Data Mart for multiple tables.', 'warning');
        return;
      }
      if (selectedTables.includes(tableName)) {
        showNotification('Table already added!', 'warning');
        return;
      }

      // DM Mode Constraint: Only ONE Fact table allowed
      if (currentDesignMode === 'dm') {
        const tableRole = defaultTableRoles[tableName] || 'dimension';

        if (tableRole === 'fact') {
          // Check if there's already a fact table on canvas
          const existingFactTable = selectedTables.find(t => {
            const role = tableTypes[t] || defaultTableRoles[t];
            return role === 'fact' || role === 'driving';
          });

          if (existingFactTable) {
            showNotification(`âŒ Only ONE Fact table allowed in Data Mart design. Remove "${existingFactTable}" first.`, 'error');
            return;
          }
        }
      }

      selectedTables.push(tableName);
      selectedColumns[tableName] = [];

      // Mark as selected in left panel
      $(`.table-item[data-table="${tableName}"]`).addClass('selected');

      // Hide empty message
      $('#emptyMessage').hide();

      // Create table card
      const metadata = tableMetadata[tableName];
      const tableAlias = tableName.split('.')[1].charAt(0);

      let columnsHTML = '';
      // Ensure schema is initialized for this table
      if (!columnSchema[tableName]) columnSchema[tableName] = {};

      // --- INJECT DEFAULT SK COLUMN ---
      const simpleName = tableName.split('.').pop(); // e.g., 'customers' from 'dw.customers'
      const skName = `${simpleName}_sk`;

      // Initialize if not present
      if (!columnSchema[tableName][skName]) {
        columnSchema[tableName][skName] = {
          originalName: skName,
          name: skName,
          dataType: 'BIGINT',
          nullable: false,
          isPK: true,
          isComputed: true, // Mark as computed so it's handled correctly
          isModelKey: true, // Explicitly mark as Model Key for config export
          expression: 'MONOTONICALLY_INCREASING_ID()',
          readOnly: true // Custom flag for UI
        };
      }

      const skSchema = columnSchema[tableName][skName];

      // Ensure it is selected by default
      if (selectedColumns[tableName] && !selectedColumns[tableName].includes(skName)) {
        selectedColumns[tableName].push(skName);
      }

      columnsHTML += `
      <div class="column-schema-row border-bottom bg-light" data-table="${tableName}" data-column="${skName}">
        <div class="d-flex align-items-center">
            <!-- 1. Checkbox & Name -->
            <div style="flex: 0 0 45%; max-width: 45%;" class="d-flex align-items-center">
                <input type="checkbox" class="column-checkbox me-2" checked disabled title="Default SK (Required)">
                <span class="col-name-text fw-bold text-primary" title="Surrogate Key">${skName}</span>
                <span class="badge bg-primary ms-2" style="font-size: 0.6rem;">SK</span>
                <span class="badge bg-info text-dark ms-1" style="font-size: 0.6rem;" title="Auto-Generated">AUTO</span>
            </div>
            <!-- 2. Alias Input (Read-Only) -->
            <div style="flex: 0 0 35%; max-width: 35%; padding-right: 5px;">
                 <input type="text" class="form-control form-control-sm border-0 bg-transparent text-muted fst-italic" 
                        value="${skSchema.name}" readonly title="Read-only SK Column">
            </div>
            <!-- 3. Type (Read-Only) -->
             <div style="flex: 0 0 20%; max-width: 20%;" class="d-flex align-items-center justify-content-end gap-1">
                <small class="text-muted" style="font-size: 0.7rem;">BIGINT</small>
                <i class="fas fa-lock text-muted ms-1" style="font-size: 0.6rem;" title="Locked"></i>
             </div>
        </div>
      </div>
    `;

      metadata.columns.forEach(col => {
        // Initialize if not present
        if (!columnSchema[tableName][col.name]) {
          columnSchema[tableName][col.name] = {
            originalName: col.name,
            name: col.name,
            dataType: col.type.toUpperCase(),
            length: null,
            precision: null,
            scale: null,
            nullable: !col.isPK,
            isPK: col.isPK || false
          };
        }
        const schema = columnSchema[tableName][col.name];
        const badge = col.isPK ? '<span class="badge bg-primary ms-1" style="font-size: 0.6rem;">PK</span>' : '';

        columnsHTML += `
      <div class="column-schema-row border-bottom" data-table="${tableName}" data-column="${col.name}">
        <div class="d-flex align-items-center">
          <!-- 1. Checkbox & Original Name (40%) -->
          <div style="flex: 0 0 45%; max-width: 45%;" class="d-flex align-items-center text-truncate">
            <input type="checkbox" class="column-checkbox me-2" 
                   data-table="${tableName}" 
                   data-column="${col.name}" 
                   onchange="toggleColumn('${tableName}', '${col.name}', this.checked)">
            <span class="col-name-text fw-bold text-dark text-truncate" title="${col.name}" style="font-size: 0.85rem;">${col.name}</span>
            ${badge}
          </div>

          <!-- 2. Alias Input (35%) -->
          <div style="flex: 0 0 35%; max-width: 35%; padding-right: 5px;">
            <input type="text" class="form-control form-control-sm py-0 px-1 border-0 bg-transparent text-primary" 
                   style="font-size: 0.85rem; height: 24px;"
                   value="${schema.name}" 
                   placeholder="Alias"
                   title="Rename column as..."
                   onchange="updateColumnAlias('${tableName}', '${col.name}', this.value)">
          </div>

          <!-- 3. Type & Edit (20%) -->
          <div style="flex: 0 0 20%; max-width: 20%;" class="d-flex align-items-center justify-content-end gap-1">
            <small class="text-muted col-type-text text-truncate" style="font-size: 0.7rem;">${col.type.toUpperCase()}</small>
            <button class="btn btn-sm btn-link text-secondary p-0" 
                    onclick="openColumnEditor('${tableName}', '${col.name}')" 
                    title="Edit Column Configuration">
              <i class="fas fa-pencil-alt" style="font-size: 0.7rem;"></i>
            </button>
          </div>
        </div>
      </div>
    `;
      });

      const tableCard = `
    <div class="table-card" id="table-${tableName.replace('.', '-')}" data-table="${tableName}" data-table-type="lookup">
      <div class="table-card-header">
        <div class="d-flex align-items-center">
          <i class="fas fa-table text-primary"></i>
          <span class="table-card-title">${tableName}</span>
          <small class="text-muted ms-2">alias: ${tableAlias}</small>
          
          <!-- Target Role Section -->
          ${currentDesignMode === 'dw' ? `
          <!-- DW Mode: Interactive Role Toggle -->
          <div class="target-role-toggle ms-3">
            <button class="role-btn lookup active" onclick="setTargetRole('${tableName}', 'lookup')" title="Lookup/Reference Table">
              <i class="fas fa-search"></i> Lookup
            </button>
            <button class="role-btn dimension" onclick="setTargetRole('${tableName}', 'dimension')" title="Dimension Table">
              <i class="fas fa-cube"></i> Dimension
            </button>
            <button class="role-btn fact" onclick="setTargetRole('${tableName}', 'fact')" title="Fact Table">
              <i class="fas fa-chart-line"></i> Fact / Transaction
            </button>
          </div>
          ` : `
          <!-- DM Mode: Role Badge (Non-Interactive) -->
          <span class="badge ${(defaultTableRoles[tableName] === 'fact') ? 'bg-success' : 'bg-info'} ms-3 dm-role-badge" style="font-size: 0.7rem; padding: 4px 8px;" data-table="${tableName}">
            ${(defaultTableRoles[tableName] === 'fact')
          ? '<i class="fas fa-chart-line me-1"></i> Fact / Driving'
          : '<i class="fas fa-cube me-1"></i> Dimension'}
          </span>
          `}
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="openFilterModal('${tableName}')" title="Filter this table">
            <i class="fas fa-filter"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="openAggregationModal('${tableName}')" title="Aggregate this table">
            <i class="fas fa-layer-group"></i>
          </button>
          <button class="btn btn-sm btn-outline-primary me-1" onclick="showTablePreview('${tableName}')" title="Preview Data">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeTable('${tableName}')" title="Remove Table">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="mb-2">
        <button class="btn btn-sm btn-outline-primary" onclick="selectAllColumns('${tableName}')">
          Select All
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllColumns('${tableName}')">
          Deselect All
        </button>
      </div>
      <div class="column-list">
        <!-- Header Row -->
        <div class="d-flex px-1 py-1 bg-light border-bottom small fw-bold text-muted">
           <div style="flex: 0 0 45%;">Source Column</div>
           <div style="flex: 0 0 35%;">Alias / Name</div>
           <div style="flex: 0 0 20%; text-align: right;">Type</div>
        </div>
        ${columnsHTML}
      </div>
    </div>
  `;

      $('#selectedTables').append(tableCard);

      // Initialize table type based on design mode
      // DW mode: default to 'lookup', DM mode: use defaultTableRoles or 'dimension'
      if (currentDesignMode === 'dm') {
        tableTypes[tableName] = defaultTableRoles[tableName] || 'dimension';
      } else {
        tableTypes[tableName] = 'lookup';
      }

      // Update DM role badge if in DM mode
      if (currentDesignMode === 'dm') {
        updateDMRoleBadge(tableName, tableTypes[tableName]);
      }

      // Add join if there's more than one table
      // Add join if there's more than one table, BUT NOT during import
      // (Import will rehydrate its own joins explicitly)
      if (selectedTables.length > 1 && !window.isImporting) {
        addJoinSection(selectedTables[selectedTables.length - 2], tableName);
      }

      generateSQL();
      showNotification(`Table ${tableName} added to designer`, 'success');

      // Update sidebar role badges
      updateSidebarRoleBadges();
    }

    // Remove table from canvas
    function removeTable(tableName) {
      selectedTables = selectedTables.filter(t => t !== tableName);
      delete selectedColumns[tableName];
      delete tableTypes[tableName];

      $(`.table-item[data-table="${tableName}"]`).removeClass('selected');
      $(`#table-${tableName.replace('.', '-')}`).remove();
      $(`.join-connector[data-tables*="${tableName}"]`).remove();

      if (selectedTables.length === 0) {
        $('#emptyMessage').show();
      }

      generateSQL();
      showNotification(`Table ${tableName} removed`, 'info');

      // Update sidebar role badges
      updateSidebarRoleBadges();
    }

    // Toggle table type between lookup and driving
    function toggleTableType(tableName, type) {
      // VALIDATION: Only ONE table can be "Driving" at a time
      if (type === 'driving') {
        // Check if another table is already marked as driving
        const currentDrivingTable = Object.keys(tableTypes).find(
          table => table !== tableName && tableTypes[table] === 'driving'
        );

        if (currentDrivingTable) {
          showNotification(
            `Only ONE table can be marked as "Driving". Table "${currentDrivingTable}" is already the Driving table. Please change it to "Lookup" first.`,
            'warning'
          );
          return; // Prevent the change
        }
      }

      // Store the table type
      tableTypes[tableName] = type;

      // Update the table card's data attribute
      const tableCard = $(`#table-${tableName.replace('.', '-')}`);
      tableCard.attr('data-table-type', type);

      // Update button states
      const lookupBtn = tableCard.find('.table-type-btn.lookup');
      const drivingBtn = tableCard.find('.table-type-btn.driving');

      if (type === 'lookup') {
        lookupBtn.addClass('active');
        drivingBtn.removeClass('active');
        showNotification(`${tableName} marked as Lookup/Dimension table`, 'info');
      } else {
        drivingBtn.addClass('active');
        lookupBtn.removeClass('active');
        showNotification(`${tableName} marked as Driving/Fact table âœ“`, 'success');
      }

      // Regenerate SQL to reflect table type
      generateSQL();
    }

    // Set the target table role (lookup/dimension/driving/fact)
    function setTargetRole(tableName, role) {
      const normalizedRole = role.toLowerCase();

      // DM Mode Constraint: Prevent changing to fact if another fact table exists
      if (currentDesignMode === 'dm' && (normalizedRole === 'fact' || normalizedRole === 'driving')) {
        // Check if there's already a different fact table on canvas
        const existingFactTable = selectedTables.find(t => {
          if (t === tableName) return false; // Skip the current table
          const tableRole = tableTypes[t] || defaultTableRoles[t];
          return tableRole === 'fact' || tableRole === 'driving';
        });

        if (existingFactTable) {
          showNotification(`âŒ Only ONE Fact table allowed in Data Mart design. "${existingFactTable}" is already a Fact table.`, 'error');
          return;
        }
      }

      // Normalize 'driving' to 'fact' internally (they're the same, just different labels)
      // The `role.toLowerCase()` above already handles this for the check, but we need to ensure
      // the stored `normalizedRole` is 'fact' if the input was 'driving'.
      const finalNormalizedRole = role === 'driving' ? 'fact' : normalizedRole;

      // VALIDATION: Only ONE table can be "Fact/Driving" at a time
      if (finalNormalizedRole === 'fact') {
        // Check if another table is already marked as fact
        const currentFactTable = Object.keys(tableTypes).find(
          table => table !== tableName && (tableTypes[table] === 'fact' || tableTypes[table] === 'driving')
        );

        if (currentFactTable) {
          const label = currentDesignMode === 'dm' ? 'Driving' : 'Fact';
          showNotification(
            `Only ONE table can be marked as "${label}". Table "${currentFactTable}" is already the ${label} table. Please change it first.`,
            'warning'
          );
          return; // Prevent the change
        }
      }

      // Store the table role (use normalized role internally)
      tableTypes[tableName] = normalizedRole;

      // Update the table card's data attribute
      const tableCard = $(`#table-${tableName.replace('.', '-')}`);
      tableCard.attr('data-table-type', normalizedRole);

      // Update button states
      const lookupBtn = tableCard.find('.role-btn.lookup');
      const dimensionBtn = tableCard.find('.role-btn.dimension');
      const factBtn = tableCard.find('.role-btn.fact');

      // Remove active class from all buttons
      lookupBtn.removeClass('active');
      dimensionBtn.removeClass('active');
      factBtn.removeClass('active');

      // Add active class to the selected button
      if (normalizedRole === 'lookup') {
        lookupBtn.addClass('active');
        showNotification(`${tableName} marked as Lookup table`, 'info');
      } else if (normalizedRole === 'dimension') {
        dimensionBtn.addClass('active');
        showNotification(`${tableName} marked as Dimension table`, 'info');
      } else if (normalizedRole === 'fact') {
        factBtn.addClass('active');
        const label = currentDesignMode === 'dm' ? 'Driving' : 'Fact';
        showNotification(`${tableName} marked as ${label} table âœ“`, 'success');
      }

      // Update DM badge if in DM mode
      if (currentDesignMode === 'dm') {
        updateDMRoleBadge(tableName, normalizedRole);
      }

      // Regenerate SQL to reflect table role
      generateSQL();

      // Update sidebar role badges
      updateSidebarRoleBadges();
    }

    // Update role toggle buttons on existing table cards when design mode changes
    function updateRoleTogglesForMode() {
      // Iterate through all table cards on the canvas
      $('#selectedTables .table-card').each(function () {
        const tableCard = $(this);
        const tableName = tableCard.data('table');
        const currentRole = tableTypes[tableName];

        // Find the parent div that contains the role section
        const headerDiv = tableCard.find('.table-card-header > div').first();

        // Remove existing role section (toggle or badge)
        headerDiv.find('.target-role-toggle').remove();
        headerDiv.find('.badge.bg-secondary').remove();

        if (currentDesignMode === 'dm') {
          // Data Mart mode: Show simple label only, no role assignment
          const dmBadge = `
            <span class="badge bg-secondary ms-3 dm-role-badge" style="font-size: 0.7rem; padding: 4px 8px;">
              <i class="fas fa-table me-1"></i> Data Mart Table
            </span>
          `;
          headerDiv.append(dmBadge);

          // Update badge to show actual role
          updateDMRoleBadge(tableName, currentRole);

          // Convert any lookup roles to dimension (cleanup)
          if (currentRole === 'lookup') {
            tableTypes[tableName] = 'dimension';
          }
        } else {
          // Data Warehouse mode: Show interactive role toggle
          const dwToggle = `
            <div class="target-role-toggle ms-3">
              <button class="role-btn lookup ${currentRole === 'lookup' ? 'active' : ''}" 
                      onclick="setTargetRole('${tableName}', 'lookup')" 
                      title="Lookup/Reference Table">
                <i class="fas fa-search"></i> Lookup
              </button>
              <button class="role-btn dimension ${currentRole === 'dimension' ? 'active' : ''}" 
                      onclick="setTargetRole('${tableName}', 'dimension')" 
                      title="Dimension Table">
                <i class="fas fa-cube"></i> Dimension
              </button>
              <button class="role-btn fact ${currentRole === 'fact' ? 'active' : ''}" 
                      onclick="setTargetRole('${tableName}', 'fact')" 
                      title="Fact Table">
                <i class="fas fa-chart-line"></i> Fact
              </button>
            </div>
          `;
          headerDiv.append(dwToggle);
        }
      });

      // Update sidebar badges after mode switch
      updateSidebarRoleBadges();
    }

    // Update DM role badge to show actual role (Dimension or Driving)
    function updateDMRoleBadge(tableName, role) {
      const tableCard = $(`#table-${tableName.replace('.', '-')}`);
      const badge = tableCard.find('.dm-role-badge');

      if (badge.length > 0) {
        // Update badge based on role
        if (role === 'dimension') {
          badge.removeClass('bg-success').addClass('bg-info');
          badge.html('<i class="fas fa-cube me-1"></i> Dimension');
        } else if (role === 'fact' || role === 'driving') {
          badge.removeClass('bg-info').addClass('bg-success');
          badge.html('<i class="fas fa-chart-line me-1"></i> Fact / Driving');
        }
      }
    }

    // Update sidebar table list to show role badges in DM mode
    function updateSidebarRoleBadges() {
      $('#tableList .table-item').each(function () {
        const item = $(this);
        const tableName = item.data('table');

        // Remove existing badges
        item.find('.sidebar-role-badge').remove();

        if (currentDesignMode === 'dm') {
          // In DM mode, show badges for ALL tables
          let role, badgeHtml;

          if (selectedTables.includes(tableName)) {
            // Table is on canvas - use its actual role
            role = tableTypes[tableName];
          } else {
            // Table not on canvas yet - use default role from mapping
            role = defaultTableRoles[tableName] || 'dimension';
          }

          // Create badge HTML based on role
          if (role === 'dimension') {
            badgeHtml = '<span class="badge bg-info sidebar-role-badge ms-2" style="font-size: 0.6rem;">Dimension</span>';
          } else if (role === 'fact' || role === 'driving') {
            badgeHtml = '<span class="badge bg-success sidebar-role-badge ms-2" style="font-size: 0.6rem;">Fact</span>';
          }

          // Add badge after the table name
          if (badgeHtml) {
            item.find('div:first').append(badgeHtml);
          }
        }
      });
    }



    // Column schema update functions
    function updateColumnName(tableName, originalName, newName) {
      if (columnSchema[tableName] && columnSchema[tableName][originalName]) {
        columnSchema[tableName][originalName].name = newName;
        generateSQL();
      }
    }

    function updateColumnType(tableName, columnName, dataType) {
      if (columnSchema[tableName] && columnSchema[tableName][columnName]) {
        columnSchema[tableName][columnName].dataType = dataType;
        generateSQL();
      }
    }

    function updateColumnLength(tableName, columnName, length) {
      if (columnSchema[tableName] && columnSchema[tableName][columnName]) {
        columnSchema[tableName][columnName].length = length ? parseInt(length) : null;
        generateSQL();
      }
    }

    function updateColumnPrecision(tableName, columnName, precision) {
      if (columnSchema[tableName] && columnSchema[tableName][columnName]) {
        columnSchema[tableName][columnName].precision = precision ? parseInt(precision) : null;
        generateSQL();
      }
    }

    function updateColumnScale(tableName, columnName, scale) {
      if (columnSchema[tableName] && columnSchema[tableName][columnName]) {
        columnSchema[tableName][columnName].scale = scale ? parseInt(scale) : null;
        generateSQL();
      }
    }

    function updateColumnNullable(tableName, columnName, nullable) {
      if (columnSchema[tableName] && columnSchema[tableName][columnName]) {
        columnSchema[tableName][columnName].nullable = nullable;
        generateSQL();
      }
    }

    // --- Column Edit Modal Functions ---
    let currentEditTable = '';
    let currentEditColumn = '';

    function openColumnEditor(tableName, columnName) {
      currentEditTable = tableName;
      currentEditColumn = columnName;
      const schema = columnSchema[tableName][columnName];

      $('#editTableName').val(tableName);
      $('#editOriginalName').val(columnName);
      $('#editColumnName').val(schema.name);
      // Initialize Expression
      $('#editColumnExpression').val(schema.expression || schema.name); // Default to just column name if no expr

      // Populate Data Types
      const typeSelect = $('#editColumnType');
      typeSelect.empty();
      dataTypes.forEach(dt => {
        typeSelect.append(new Option(dt, dt));
      });
      typeSelect.val(schema.dataType);

      $('#editColumnLength').val(schema.length || '');
      $('#editColumnPrecision').val(schema.precision || '');
      $('#editColumnScale').val(schema.scale || '');
      $('#editColumnSensitivity').val(schema.sensitivity || 'None');
      $('#editColumnNullable').prop('checked', schema.nullable);

      toggleEditTypeFields();

      const modal = new bootstrap.Modal(document.getElementById('columnEditModal'));
      modal.show();
    }

    function toggleEditTypeFields() {
      const type = $('#editColumnType').val();
      const isLengthType = ['VARCHAR', 'CHAR', 'STRING', 'BINARY', 'ARRAY'].includes(type);
      const isDecimal = type === 'DECIMAL';

      if (isLengthType) {
        $('#editLengthGroup').show();
        $('#editPrecisionGroup').hide();
        $('#editScaleGroup').hide();
        // Auto-select String tab (or close match)
        const tabTrigger = new bootstrap.Tab(document.querySelector('#transformTabs button[data-bs-target="#tabString"]'));
        tabTrigger.show();
      } else if (isDecimal) {
        $('#editLengthGroup').hide();
        $('#editPrecisionGroup').show();
        $('#editScaleGroup').show();
        // Auto-select Numeric tab
        const tabTrigger = new bootstrap.Tab(document.querySelector('#transformTabs button[data-bs-target="#tabNumeric"]'));
        tabTrigger.show();
      } else if (['INT', 'BIGINT', 'DOUBLE', 'FLOAT', 'SMALLINT', 'TINYINT'].includes(type)) {
        $('#editLengthGroup').hide();
        $('#editPrecisionGroup').hide();
        $('#editScaleGroup').hide();
        // Auto-select Numeric tab
        const tabTrigger = new bootstrap.Tab(document.querySelector('#transformTabs button[data-bs-target="#tabNumeric"]'));
        tabTrigger.show();
      } else if (['DATE', 'TIMESTAMP'].includes(type)) {
        $('#editLengthGroup').hide();
        $('#editPrecisionGroup').hide();
        $('#editScaleGroup').hide();
        // Auto-select Date tab
        const tabTrigger = new bootstrap.Tab(document.querySelector('#transformTabs button[data-bs-target="#tabDate"]'));
        tabTrigger.show();
      } else {
        $('#editLengthGroup').hide();
        $('#editPrecisionGroup').hide();
        $('#editScaleGroup').hide();
      }
    }

    function saveColumnChanges() {
      const tableName = currentEditTable;
      const originalName = currentEditColumn;
      const newName = $('#editColumnName').val();

      if (!newName) {
        alert('Column name cannot be empty');
        return;
      }

      // Update Schema
      const schema = columnSchema[tableName][originalName];
      schema.name = newName;
      schema.dataType = $('#editColumnType').val();

      const length = $('#editColumnLength').val();
      schema.length = length ? parseInt(length) : null;

      const precision = $('#editColumnPrecision').val();
      schema.precision = precision ? parseInt(precision) : null;

      const scale = $('#editColumnScale').val();
      schema.scale = scale ? parseInt(scale) : null;

      schema.sensitivity = $('#editColumnSensitivity').val();
      schema.nullable = $('#editColumnNullable').is(':checked');

      // Save Expression
      const expression = $('#editColumnExpression').val();
      if (expression && expression.trim() !== '') {
        schema.expression = expression.trim();
      } else {
        schema.expression = null; // Revert to standard behavior
      }

      // Close Modal
      const modalEl = document.getElementById('columnEditModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      // Refresh UI
      // We need to re-render the table card to show updated name/type
      // For now, we'll just update the specific row text if possible, or re-render the whole table list
      // Since we don't have a granular re-render, we might need to update the DOM directly or trigger a refresh

      // Update the display in the list
      const row = $(`.column-schema-row[data-table="${tableName}"][data-column="${originalName}"]`);
      // Update the alias input value, NOT the source column text
      row.find('input[type="text"]').val(newName);
      row.find('.col-type-text').text(schema.dataType);

      generateSQL();
      showNotification('Column updated successfully', 'success');
    }

    // Helper to insert SQL functions into the expression editor
    function insertFunction(funcName, template) {
      const exprField = document.getElementById('editColumnExpression');
      const start = exprField.selectionStart;
      const end = exprField.selectionEnd;
      const text = exprField.value;
      const selectedText = text.substring(start, end);

      let replacement = template;
      if (selectedText && selectedText.trim() !== '') {
        // If text is selected, use it as the @col argument
        // Remove @col placeholder and wrap selected text
        // Actually, simpler to just replace @col with selected text in the template
        replacement = template.replace('@col', selectedText);
      } else {
        // If nothing selected, try to use the current column name?
        // Or just leave a placeholder
        const currentName = $('#editOriginalName').val();
        replacement = template.replace('@col', currentName || 'column');
      }

      const newVal = text.substring(0, start) + replacement + text.substring(end);
      exprField.value = newVal;

      // Restore focus
      exprField.focus();
    }
    // Update Column Alias
    function updateColumnAlias(tableName, colName, newAlias) {
      if (!columnSchema[tableName] || !columnSchema[tableName][colName]) return;

      columnSchema[tableName][colName].name = newAlias || colName; // Revert to original if empty
      generateSQL();
    }

    // Toggle column selection
    function toggleColumn(tableName, columnName, isChecked) {
      if (isChecked) {
        if (!selectedColumns[tableName].includes(columnName)) {
          selectedColumns[tableName].push(columnName);

          // Auto-resolve duplicate aliases
          if (typeof autoResolveColumnAlias === 'function') {
            autoResolveColumnAlias(tableName, columnName);
          }
        }
      } else {
        selectedColumns[tableName] = selectedColumns[tableName].filter(c => c !== columnName);
      }
      generateSQL();
    }

    function autoResolveColumnAlias(currentTable, currentColumn) {
      if (!columnSchema[currentTable] || !columnSchema[currentTable][currentColumn]) return;

      let proposedName = columnSchema[currentTable][currentColumn].name;
      let isUnique = false;
      let counter = 1;
      const originalProposed = proposedName;

      // Gather all OTHER selected column aliases
      const existingAliases = new Set();
      selectedTables.forEach(t => {
        if (selectedColumns[t]) {
          selectedColumns[t].forEach(col => {
            // Skip self (current column being added)
            if (t === currentTable && col === currentColumn) return;

            const alias = columnSchema[t][col]?.name || col;
            existingAliases.add(alias.toLowerCase());
          });
        }
      });

      // Check collision
      while (!isUnique) {
        if (existingAliases.has(proposedName.toLowerCase())) {
          proposedName = `${originalProposed}_${counter}`;
          counter++;
        } else {
          isUnique = true;
        }
      }

      // Apply if changed
      if (proposedName !== columnSchema[currentTable][currentColumn].name) {
        columnSchema[currentTable][currentColumn].name = proposedName;

        // Update UI using data attributes
        const rows = document.querySelectorAll('.column-schema-row');
        let targetRow = null;
        for (let r of rows) {
          if (r.getAttribute('data-table') === currentTable && r.getAttribute('data-column') === currentColumn) {
            targetRow = r;
            break;
          }
        }

        if (targetRow) {
          const aliasInput = targetRow.querySelector('input[placeholder="Alias"]');
          if (aliasInput) {
            aliasInput.value = proposedName;
            aliasInput.classList.add('text-success', 'fw-bold');
            setTimeout(() => aliasInput.classList.remove('text-success', 'fw-bold'), 2000);
          }
        }

        showNotification(`Auto-aliased column to "${proposedName}" to avoid ambiguity`, 'info');
      }
    }

    // Select all columns for a table
    function selectAllColumns(tableName) {
      $(`input[data-table="${tableName}"]`).prop('checked', true);
      selectedColumns[tableName] = [];

      tableMetadata[tableName].columns.forEach(c => {
        selectedColumns[tableName].push(c.name);
        // Apply auto-resolution for each
        if (typeof autoResolveColumnAlias === 'function') {
          autoResolveColumnAlias(tableName, c.name);
        }
      });
      generateSQL();
    }

    // Deselect all columns for a table
    function deselectAllColumns(tableName) {
      $(`input[data-table="${tableName}"]`).prop('checked', false);
      selectedColumns[tableName] = [];
      generateSQL();
    }

    /*
    ============================================================================
       SECTION 7: JOIN LOGIC & MANAGEMENT
       - Join construction (clauses, types)
       - Auto-join detection
       - Join UI rendering
    ============================================================================
    */
    // Add join section between tables
    function addJoinSection(leftTable, rightTable, forcedCondition = null, forcedType = 'INNER') {
      const leftAlias = leftTable.split('.')[1].charAt(0);
      const rightAlias = rightTable.split('.')[1].charAt(0);
      // Unique ID to allow multiple join blocks between same tables
      const containerId = `join-${leftTable.replace(/\./g, '-')}-${rightTable.replace(/\./g, '-')}-${Date.now()}`;

      // Initialize with one condition
      const initialCondition = forcedCondition || findAutoJoinCondition(leftTable, rightTable);

      const joinHTML = `
    <div class="join-connector" data-tables="${leftTable},${rightTable}" id="${containerId}">
      <div class="join-config p-2 border rounded shadow-sm bg-white d-flex flex-column gap-2">
        <div class="d-flex align-items-center justify-content-between border-bottom pb-1 w-100">
           <div class="d-flex align-items-center gap-2">
               <span class="badge bg-secondary" style="font-size: 0.75rem;color:white;">JOIN</span>
               <select class="form-select form-select-sm fw-bold border-primary py-0 px-2" style="width: auto; min-width: 120px; height: 24px; font-size: 0.8rem;" 
                       onchange="updateJoinType('${leftTable}', '${rightTable}', this.value)">
                  <option value="INNER" ${forcedType === 'INNER' ? 'selected' : ''}>INNER JOIN</option>
                  <option value="LEFT" ${forcedType === 'LEFT' ? 'selected' : ''}>LEFT JOIN</option>
                  <option value="RIGHT" ${forcedType === 'RIGHT' ? 'selected' : ''}>RIGHT JOIN</option>
                  <option value="FULL" ${forcedType === 'FULL' ? 'selected' : ''}>FULL JOIN</option>
               </select>
           </div>
           
           <div class="d-flex align-items-center gap-1">
               <button class="btn btn-sm btn-link p-0 text-decoration-none me-2" style="font-size: 0.8rem;"
                       onclick="addJoinSection('${leftTable}', '${rightTable}')"
                       title="Replicate: Add another join block for these tables">
                  <i class="fas fa-plus"></i> Replicate
               </button>
               <button class="btn btn-sm btn-link p-0 text-decoration-none" style="font-size: 0.8rem;"
                       onclick="addJoinRow('${containerId}', '${leftTable}', '${rightTable}')"
                       title="Add another join condition">
                  <i class="fas fa-plus"></i> Add Condition
               </button>
               <button class="btn btn-sm btn-link p-0 text-danger ms-2" style="font-size: 0.8rem;"
                       onclick="removeJoinBlock('${containerId}')"
                       title="Remove this join block">
                  <i class="fas fa-trash"></i>
               </button>
           </div>
        </div>
        
        <!-- Header Row for Alignment -->
        <div class="d-flex align-items-center gap-2 px-1 text-muted fw-bold text-uppercase small w-100" style="font-size: 0.7rem;">
            <div style="width: 100px;" class="text-center">Logic</div>
            <div class="flex-grow-1 text-truncate text-center" title="${leftTable.split('.')[1]}">${leftTable.split('.')[1]}</div>
            <div style="width: 20px;" class="text-center"></div>
            <div class="flex-grow-1 text-truncate text-center" title="${rightTable.split('.')[1]}">${rightTable.split('.')[1]}</div>
            <div style="width: 24px;"></div>
        </div>

        <div class="join-rows-container d-flex flex-column gap-1 w-100">
           <!-- Rows injected here -->
        </div>
      </div>
    </div>
  `;

      $(`#table-${rightTable.replace(/\./g, '-')}`).before(joinHTML);

      // Store join structure
      joinConditions.push({
        id: containerId, // Track by ID
        leftTable: leftTable,
        rightTable: rightTable,
        joinType: forcedType,
        clauses: [
          { leftColumn: initialCondition.left, rightColumn: initialCondition.right, logic: 'AND' }
        ]
      });

      // Render the first row
      addJoinRow(containerId, leftTable, rightTable, true, initialCondition.left, initialCondition.right);
      generateSQL();
    }

    // Remove entire join block
    function removeJoinBlock(containerId) {
      $(`#${containerId}`).remove();
      joinConditions = joinConditions.filter(j => j.id !== containerId);
      generateSQL();
    }

    function findAutoJoinCondition(leftTable, rightTable) {
      const leftCols = tableMetadata[leftTable].columns;
      const rightCols = tableMetadata[rightTable].columns;
      let left = '', right = '';

      // Try to match FK/PK or same name
      leftCols.some(lc => {
        return rightCols.some(rc => {
          if (lc.name === rc.name && (lc.isPK || rc.isPK || lc.isFK || rc.isFK)) {
            left = lc.name;
            right = rc.name;
            return true;
          }
          return false;
        });
      });

      // Fallback to first columns if no match
      if (!left) { left = leftCols[0].name; right = rightCols[0].name; }
      return { left, right };
    }

    function addJoinRow(containerId, leftTable, rightTable, isFirst = false, forcedLeft = null, forcedRight = null) {
      const leftAlias = leftTable.split('.')[1].charAt(0);
      const rightAlias = rightTable.split('.')[1].charAt(0);

      // Default selection for new rows (or use auto-detect for first)
      let defaultLeft = '', defaultRight = '';
      if (forcedLeft && forcedRight) {
        defaultLeft = forcedLeft;
        defaultRight = forcedRight;
      } else if (isFirst) {
        const auto = findAutoJoinCondition(leftTable, rightTable);
        defaultLeft = auto.left;
        defaultRight = auto.right;
      } else {
        defaultLeft = tableMetadata[leftTable].columns[0].name;
        defaultRight = tableMetadata[rightTable].columns[0].name;
      }


      const rowId = `jrow-${Math.random().toString(36).substr(2, 9)}`;

      let logicHtml = '';
      if (isFirst) {
        logicHtml = `<div class="join-logic-container"><span class="join-logic-static">ON</span></div>`;
      } else {
        logicHtml = `
          <div class="join-logic-container">
            <select class="join-logic join-logic-select" onchange="updateJoinClause('${leftTable}', '${rightTable}')">
              <option value="AND">AND</option>
              <option value="OR">OR</option>
            </select>
          </div>
        `;
      }

      const html = `
            <div class="d-flex align-items-center gap-2 join-row" id="${rowId}">
                ${logicHtml}
                
                <select class="form-select form-select-sm join-left flex-grow-1 join-column-select py-0" onchange="updateJoinClause('${leftTable}', '${rightTable}')">
                  ${tableMetadata[leftTable].columns.map(c =>
        `<option value="${c.name}" ${c.name === defaultLeft ? 'selected' : ''}>${leftAlias}.${c.name}</option>`
      ).join('')}
                </select>
                
                <div class="text-center text-muted" style="width: 20px; font-size: 0.8rem;">=</div>
                
                <select class="form-select form-select-sm join-right flex-grow-1 join-column-select py-0" onchange="updateJoinClause('${leftTable}', '${rightTable}')">
                   ${tableMetadata[rightTable].columns.map(c =>
        `<option value="${c.name}" ${c.name === defaultRight ? 'selected' : ''}>${rightAlias}.${c.name}</option>`
      ).join('')}
                </select>

                <div style="width: 24px;" class="text-center d-flex align-items-center justify-content-center">
                    ${!isFirst ? `
                    <button class="btn btn-sm btn-link text-danger p-0" style="font-size: 0.9rem;" onclick="removeJoinRow('${containerId}', '${rowId}', '${leftTable}', '${rightTable}')" title="Remove Condition">
                        <i class="fas fa-times"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
        `;

      $(`#${containerId} .join-rows-container`).append(html);
      if (!isFirst) updateJoinClause(leftTable, rightTable); // Sync state for new row
    }

    function removeJoinRow(containerId, rowId, leftTable, rightTable) {
      $(`#${rowId}`).remove();
      updateJoinClause(leftTable, rightTable);
    }

    function updateJoinClause(leftTable, rightTable) {
      const containerId = `join-${leftTable.replace(/\./g, '-')}-${rightTable.replace(/\./g, '-')}`;
      const container = document.getElementById(containerId);
      if (!container) return;

      const rows = container.querySelectorAll('.join-row');
      const clauses = [];

      rows.forEach((row, index) => {
        const leftCol = row.querySelector('.join-left').value;
        const rightCol = row.querySelector('.join-right').value;
        let logic = 'AND';
        if (index > 0) {
          logic = row.querySelector('.join-logic').value;
        }
        clauses.push({ leftColumn: leftCol, rightColumn: rightCol, logic: logic });
      });

      const joinObj = joinConditions.find(j => j.leftTable === leftTable && j.rightTable === rightTable);
      if (joinObj) {
        joinObj.clauses = clauses;
        generateSQL();
      }
    }

    // Update join type when dropdown changes
    function updateJoinType(leftTable, rightTable, joinType) {
      // Find and update the join condition
      const joinIndex = joinConditions.findIndex(
        j => j.leftTable === leftTable && j.rightTable === rightTable
      );

      if (joinIndex !== -1) {
        joinConditions[joinIndex].joinType = joinType;
        generateSQL();
        showNotification(`Join type updated to ${joinType} JOIN`, 'info');
      }
    }

    // Update join type
    function updateJoinType(leftTable, rightTable, joinType) {
      const join = joinConditions.find(j => j.leftTable === leftTable && j.rightTable === rightTable);
      if (join) {
        join.joinType = joinType;
        generateSQL();
      }
    }

    // Generate SQL
    function toggleIncrementalOptions() {
      const mode = $('#createMode').val();
      const container = $('#incrementalOptions');
      if (mode === 'MERGE INTO' || mode === 'INSERT INTO' || mode === 'INSERT OVERWRITE') {
        container.slideDown(200);
      } else {
        container.slideUp(200);
      }
    }

    function toggleSCDOptions() {
      const type = $('#scdType').val();
      const type2Opts = $('#scdType2Options');
      if (type === 'TYPE2') {
        type2Opts.slideDown(200);
      } else {
        type2Opts.slideUp(200);
      }
    }

    /*
    ============================================================================
       SECTION 8: SQL GENERATION & PREVIEW
       - Delta Lake SQL construction
       - SELECT, CREATE, MERGE generation
       - DDL preview updates
    ============================================================================
    */
    function generateSQL() {
      // Update full table name display
      const catalog = $('#dmCatalog').val() || 'main.dm';
      const tableName = $('#dmTableName').val() || 'output_table';
      const fullName = `${catalog}.${tableName}`;
      $('#fullTableName').text(fullName);

      if (selectedTables.length === 0) {
        const msg = '-- Configure target DM table and select source tables to generate SQL';
        $('#sqlPreviewCreate code').text(msg);
        $('#sqlPreviewSelect code').text(msg);
        $('#configPreviewKeys code').text('-- No configuration available');
        $('#configPreviewValues code').text('-- No configuration available');
        return;
      }

      // --- Build SELECT Query ---
      let selectSql = 'SELECT\n  ';

      // Build column list
      const columns = [];
      selectedTables.forEach(table => {
        const alias = table.split('.')[1].charAt(0);
        if (selectedColumns[table] && selectedColumns[table].length > 0) {
          selectedColumns[table].forEach(col => {
            // Check for alias
            // Check for alias and expression
            const schema = columnSchema[table] && columnSchema[table][col];
            const targetName = schema ? schema.name : col;
            const expression = schema ? schema.expression : null;

            if (expression) {
              // Use custom expression
              columns.push(`${expression} AS ${targetName}`);
            } else if (targetName && targetName !== col) {
              columns.push(`${alias}.${col} AS ${targetName}`);
            } else {
              columns.push(`${alias}.${col}`);
            }
          });
        }
      });

      // Add computed columns
      computedColumns.forEach(col => {
        if (col.name && col.expr) {
          columns.push(`${col.expr} AS ${col.name}`);
        }
      });

      // Aggregations
      Object.values(aggregationConfig).forEach(cfg => {
        if (cfg.expressions) {
          const aggs = cfg.expressions.split(',').map(s => s.trim());
          aggs.forEach(agg => {
            if (agg) columns.push(agg);
          });
        }
      });

      if (columns.length === 0) {
        columns.push('*');
      }

      selectSql += columns.join(',\n  ');

      // FROM clause
      selectSql += '\nFROM ' + selectedTables[0] + ' ' + selectedTables[0].split('.')[1].charAt(0);

      // JOIN clauses
      for (let i = 1; i < selectedTables.length; i++) {
        const rightTable = selectedTables[i];
        const rightAlias = rightTable.split('.')[1].charAt(0);

        // Find join condition for this table (support Star Schema)
        // We look for a condition where this table is the 'rightTable'
        const join = joinConditions.find(j => j.rightTable === rightTable) || {
          leftTable: selectedTables[i - 1], // Default fallback
          joinType: 'INNER',
          leftColumn: 'id',
          rightColumn: 'id'
        };

        const leftTable = join.leftTable;
        const leftAlias = leftTable.split('.')[1].charAt(0);

        // Use columns from state if available, else look for DOM (backwards compat)
        const leftJoinSelector = `#leftJoin-${leftTable.replace('.', '-')}-${rightTable.replace('.', '-')}`;
        const rightJoinSelector = `#rightJoin-${leftTable.replace('.', '-')}-${rightTable.replace('.', '-')}`;

        const leftCol = join.leftColumn || 'id';
        const rightCol = join.rightColumn || 'id';

        let onCondition = '';
        if (join.clauses && join.clauses.length > 0) {
          join.clauses.forEach((clause, idx) => {
            const logic = idx === 0 ? '' : ` ${(clause.logic || 'AND')} `;
            onCondition += `${logic}${leftAlias}.${clause.leftColumn} = ${rightAlias}.${clause.rightColumn}`;
          });
        } else {
          // Fallback
          onCondition = `${leftAlias}.${leftCol} = ${rightAlias}.${rightCol}`;
        }

        selectSql += `\n${join.joinType} JOIN ${rightTable} ${rightAlias}`;
        selectSql += `\n  ON ${onCondition}`;
      }

      // WHERE clause
      const whereConditions = [];
      // Add filters from state
      if (filters && filters.length > 0) {
        filters.forEach(f => {
          if (f.condition) {
            whereConditions.push(f.condition);
          }
        });
      }

      // Add (Conceptual) Watermark Filter if provided for Append/Merge
      // Note: In a real ELT, this might be handled by the framework, but we add it to SQL for visibility
      const watermarkCol = $('#watermarkCol').val();
      if (watermarkCol && ($('#createMode').val() === 'INSERT INTO' || $('#createMode').val() === 'MERGE INTO')) {
        whereConditions.push(`${watermarkCol} > (SELECT MAX(${watermarkCol}) FROM ${fullName})`);
      }

      if (whereConditions.length > 0) {
        selectSql += '\nWHERE ' + whereConditions.join('\n  AND ');
      }

      // GROUP BY
      const groupBys = [];
      Object.values(aggregationConfig).forEach(cfg => {
        if (cfg.groupBy) {
          groupBys.push(cfg.groupBy);
        }
      });

      if (groupBys.length > 0) {
        selectSql += '\nGROUP BY ' + groupBys.join(', ');
      }

      selectSql += ';';

      // --- Build CREATE / MERGE Query ---
      const createMode = $('#createMode').val() || 'CREATE OR REPLACE';
      const description = $('#dmDescription').val();

      let createSql = '';

      // Build column definitions from schema
      let columnDefs = [];
      selectedTables.forEach(table => {
        if (selectedColumns[table] && selectedColumns[table].length > 0 && columnSchema[table]) {
          selectedColumns[table].forEach(col => {
            const schema = columnSchema[table][col];
            if (schema) {
              let colDef = `  ${schema.name} ${schema.dataType}`;

              // Add length/precision if specified
              if (schema.length && ['VARCHAR', 'CHAR', 'DECIMAL'].includes(schema.dataType)) {
                if (schema.dataType === 'DECIMAL' && schema.precision) {
                  colDef += `(${schema.precision}${schema.scale ? `, ${schema.scale}` : ''})`;
                } else {
                  colDef += `(${schema.length})`;
                }
              } else if (schema.dataType === 'DECIMAL' && schema.precision) {
                colDef += `(${schema.precision}${schema.scale ? `, ${schema.scale}` : ''})`;
              }

              // Add NOT NULL constraint
              if (!schema.nullable) {
                colDef += ' NOT NULL';
              }

              columnDefs.push(colDef);
            }
          });
        }
      });

      // Add computed columns to definitions
      computedColumns.forEach(col => {
        if (col.name && col.expr) {
          const type = col.type || 'STRING';
          columnDefs.push(`  ${col.name} ${type}`);
        }
      });

      if (createMode === 'MERGE INTO') {
        // Merge Logic
        const mergeKeys = $('#mergeKeys').val();
        const preSql = $('#preSql').val();
        const postSql = $('#postSql').val();

        createSql = `-- Incremental Merge (Upsert) Pattern\n`;
        if (description) createSql += `-- ${description}\n`;
        if (preSql) createSql += `-- Pre-SQL:\n${preSql};\n\n`;

        createSql += `MERGE INTO ${fullName} AS target\n`;
        createSql += `USING (\n${selectSql.replace(/;$/, '')}\n) AS source\n`;

        if (mergeKeys) {
          const keys = mergeKeys.split(',').map(k => k.trim());
          const onClause = keys.map(k => `target.${k} = source.${k}`).join(' AND ');
          createSql += `ON ${onClause}\n`;
        } else {
          createSql += `ON target.id = source.id -- TODO: Define Merge Keys\n`;
        }

        createSql += `WHEN MATCHED THEN UPDATE SET *\n`;
        createSql += `WHEN NOT MATCHED THEN INSERT *;`;

        if (postSql) createSql += `\n\n-- Post-SQL:\n${postSql};`;

      } else if ($('#scdType').val() === 'TYPE2') {
        // SCD Type 2 Logic (Overrides Standard Create if SCD tab is active/focused? 
        // For now, we generate this if specific logic is implied, but better to check if user explicitly wants SCD)
        // Simplified: If user selected Type 2 in SCD tab, we show that SQL.

        const businessKeys = $('#scdKeys').val() || 'id';
        const activeCol = $('#scdActiveCol').val() || 'is_active';
        const startCol = $('#scdStartCol').val() || 'valid_from';
        const endCol = $('#scdEndCol').val() || 'valid_to';

        createSql = `-- SCD Type 2 Implementation (History)\n`;
        createSql += `-- Business Keys: ${businessKeys}\n`;

        createSql += `MERGE INTO ${fullName} AS target\n`;
        createSql += `USING (\n  SELECT ${selectSql.replace('SELECT\n  ', '').replace(/;$/, '')}\n  FROM source_view\n  UNION ALL\n  SELECT NULL AS mergeKey, source.* FROM source_view source JOIN ${fullName} target ON ... WHERE target.${activeCol} = true AND ...\n) AS source\n`;
        createSql += `-- NOTE: Conceptual SQL. Real Type 2 MERGE is complex and often requires multiple passes or specific Delta features.\n`;
        createSql += `ON target.${businessKeys.split(',')[0]} = source.${businessKeys.split(',')[0]} -- Match on Business Key\n`;
        createSql += `WHEN MATCHED AND target.${activeCol} = true AND source.${activeCol} != target.${activeCol} THEN UPDATE SET ${endCol} = current_date(), ${activeCol} = false\n`;
        createSql += `WHEN NOT MATCHED THEN INSERT *;`;

      } else {
        // Standard Create / Append Logic
        if (columnDefs.length > 0) {
          if (createMode.includes('CREATE')) {
            createSql = `${createMode} TABLE ${fullName} (\n`;
            createSql += columnDefs.join(',\n');
            createSql += '\n)';
            if (description) {
              createSql += `\nCOMMENT '${description}'`;
            }
            createSql += `\nTBLPROPERTIES ('delta.autoOptimize.optimizeWrite' = 'true');\n\n`;
            createSql += `-- Populate table\nINSERT INTO ${fullName}\n${selectSql}`;
          } else {
            // INSERT INTO or INSERT OVERWRITE
            createSql = `-- ${createMode === 'INSERT OVERWRITE' ? 'Partition Overwrite' : 'Append / Insert Mode'}\n`;

            if (createMode === 'INSERT OVERWRITE') {
              createSql += `-- Note: Ensure 'spark.sql.sources.partitionOverwriteMode' = 'dynamic' for dynamic partition overwrite.\n`;
            }
            createSql += `${createMode} ${fullName}\n${selectSql}`;
          }
        } else {
          // Fallback to CTAS if no columns selected (only for CREATE)
          if (createMode.includes('CREATE')) {
            createSql = `${createMode} TABLE ${fullName} AS\n${selectSql}`;
          } else {
            createSql = `${createMode} ${fullName}\n${selectSql}`;
          }
        }
      }

      // --- Build Configuration Object ---

      const config = {
        target: {
          catalog: catalog,
          tableName: tableName,
          fullName: fullName,
          description: description,
          createMode: createMode,
          mergeKeys: $('#mergeKeys').val(),
          watermarkCol: $('#watermarkCol').val(),
          preSql: $('#preSql').val(),
          postSql: $('#postSql').val(),
          scdStrategy: $('#scdType').val(),
          scdKeys: $('#scdKeys').val()
        },
        sources: {
          tables: selectedTables,
          columns: selectedColumns
        },
        transformations: {
          joins: joinConditions,
          calculatedColumns: computedColumns.filter(c => !c.isModelKey),
          modelKeyColumns: computedColumns.filter(c => c.isModelKey),
          filters: filters
        },
        sql: createSql,
        timestamp: new Date().toISOString()
      };

      // Flatten Configuration for Display
      function flattenObject(obj, prefix = '') {
        return Object.keys(obj).reduce((acc, k) => {
          const pre = prefix.length ? prefix + '.' : '';
          if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
            Object.assign(acc, flattenObject(obj[k], pre + k));
          } else {
            acc[pre + k] = obj[k];
          }
          return acc;
        }, {});
      }

      const flatConfig = flattenObject(config);
      const configKeys = Object.keys(flatConfig).join('\n');
      const configValues = Object.values(flatConfig).map(v => JSON.stringify(v)).join('\n');

      // --- Update UI ---
      $('#sqlPreviewCreate code').text(createSql);
      $('#sqlPreviewSelect code').text(selectSql);
      $('#configPreviewKeys code').text(configKeys);
      $('#configPreviewValues code').text(configValues);
    }

    /*
    ============================================================================
       SECTION 9: CONFIGURATION EXPORT & JOB GENERATION
       - JSON/YAML export
       - Executive summary generation
       - Databricks Job Task definitions
    ============================================================================
    */
    // === Shared Configuration Generator ===
    function generateTransformConfig() {
      // 1. Connection Details
      const sourceConn = connections.find(c => c.id === selectedConnectionId) || { name: 'Unknown', type: 'Unknown' };
      const targetMode = document.querySelector('input[name="targetConnectionMode"]:checked')?.value || 'same';
      let targetDetails = {};
      if (targetMode === 'same') {
        targetDetails = { provider: sourceConn.name, type: sourceConn.type };
      } else {
        const targetConn = connections.find(c => c.id === selectedTargetConnectionId) || { name: 'Custom', type: 'Custom' };
        targetDetails = { provider: targetConn.name, type: targetConn.type };
      }
      targetDetails.catalog = document.getElementById('targetCatalog')?.value || 'main';
      targetDetails.schema = document.getElementById('targetSchema')?.value || 'dm';
      targetDetails.table = document.getElementById('dmTableName')?.value || 'output_table';

      const jobName = document.getElementById('scheduleJobName')?.value || "sales_summary_dm";
      const designType = (typeof currentDesignMode !== 'undefined' && currentDesignMode === 'dm') ? "DATA_MART" : "DATA_WAREHOUSE";

      // 2. Build Config Object
      return {
        meta: {
          version: "1.0.0",
          author: "Databricks ELT Generator",
          jobName: jobName,
          step: "Transformation",
          designType: designType,
          generatedAt: new Date().toISOString(),
          description: document.getElementById('dmDescription')?.value || "Automated ELT Pipeline",
          tags: []
        },
        workspaceSetup: (typeof getWorkspaceSetupConfig === 'function') ? getWorkspaceSetupConfig() : {},
        source: {
          id: selectedConnectionId,
          provider: sourceConn.name,
          type: sourceConn.type,
          mode: document.querySelector('input[name="connectionMode"]:checked')?.value || 'api',
          workspaceUrl: document.getElementById('workspaceUrl')?.value || '(masked)'
        },
        target: {
          mode: targetMode,
          ...targetDetails,
          writeMode: document.getElementById('createMode')?.value || 'CREATE OR REPLACE'
        },
        storage: {
          format: "DELTA",
          partitionBy: [],
          clustering: [],
          location: `s3://bucket/${targetDetails.schema}/${targetDetails.table}`
        },
        sources: (typeof selectedTables !== 'undefined') ? selectedTables.map((tableName, index) => {
          const richColumns = (selectedColumns[tableName] || []).map(colName => {
            const schema = columnSchema[tableName] && columnSchema[tableName][colName];
            if (schema) {
              return {
                sourceColumn: colName,
                targetColumn: schema.name,
                dataType: schema.dataType,
                expression: schema.expression || null,
                sensitivity: schema.sensitivity || 'None',
                nullable: schema.nullable,
                isComputed: false
              };
            }
            return { sourceColumn: colName, targetColumn: colName, dataType: 'UNKNOWN' };
          });

          return {
            table: tableName,
            alias: tableName.split('.')[1] ? tableName.split('.')[1].charAt(0) : 't',
            role: (typeof tableTypes !== 'undefined' && tableTypes[tableName]) ? tableTypes[tableName].toUpperCase() : (index === 0 ? 'FACT' : 'DIMENSION'),
            columns: richColumns
          };
        }) : [],
        transformations: {
          processingOptions: {
            addAuditColumns: $('#dq-audit').is(':checked'),
            deduplicateRows: $('#dq-duplicates').is(':checked'),
            dropRowsWithNulls: $('#dq-nulls').is(':checked'),
            dropInvalidRecords: $('#dq-invalid').is(':checked')
          },
          joins: (typeof joinConditions !== 'undefined') ? joinConditions.map(j => ({
            left: j.leftTable,
            right: j.rightTable,
            type: j.joinType,
            conditions: j.clauses || [{ left: j.leftColumn, right: j.rightColumn }]
          })) : [],
          filters: (typeof filters !== 'undefined') ? filters.map(f => f.condition) : [],
          calculatedColumns: (typeof computedColumns !== 'undefined') ? computedColumns.filter(c => !c.isModelKey).map(c => ({
            name: c.name,
            expression: c.expr,
            type: c.type,
            isComputed: c.isComputed
          })) : [],
          modelKeyColumns: (() => {
            if (typeof computedColumns === 'undefined') return [];
            const explicitSKs = computedColumns.filter(c => c.isModelKey).map(c => ({
              name: c.name,
              expression: c.expr,
              type: c.type,
              isComputed: c.isComputed,
              isModelKey: true,
              modelKeyType: c.modelKeyType || 'SURROGATE_KEY'
            }));
            const schemaSKs = [];
            if (typeof selectedTables !== 'undefined') {
              selectedTables.forEach(table => {
                if (columnSchema && columnSchema[table]) {
                  Object.values(columnSchema[table]).forEach(col => {
                    if (col.isModelKey && !explicitSKs.find(sk => sk.name === col.name)) {
                      schemaSKs.push({
                        name: col.name,
                        expression: col.expression || 'MONOTONICALLY_INCREASING_ID()',
                        type: col.dataType,
                        isComputed: true,
                        isModelKey: true,
                        sourceTable: table,
                        modelKeyType: 'SURROGATE_KEY'
                      });
                    }
                  });
                }
              });
            }
            return [...explicitSKs, ...schemaSKs];
          })(),
          aggregations: (typeof aggregationConfig !== 'undefined') ? Object.keys(aggregationConfig).map(tbl => ({
            table: tbl,
            groupBy: aggregationConfig[tbl].groupBy,
            measures: aggregationConfig[tbl].expressions
          })) : [],
          scd: {
            strategy: $('#scdType').val() || 'TYPE1',
            keys: $('#scdKeys').val() ? $('#scdKeys').val().split(',').map(k => k.trim()) : [],
            activeFlagCol: 'is_active',
            startDateCol: 'start_date',
            endDateCol: 'end_date'
          }
        },
        output: {
          catalog: targetDetails.catalog,
          schema: targetDetails.schema,
          table: targetDetails.table,
          mode: document.getElementById('createMode')?.value || 'CREATE OR REPLACE',
          ddlQuery: $('#sqlPreviewCreate code').text()
        }
      };
    }

    // Show Transformation Configuration (Transformation Config ONLY, NO Pipeline Jobs)
    function showTransformConfigurationSummary(initialTab = 'json') {
      const transformConfig = generateTransformConfig();

      // 1. Set Title
      const modalTitle = document.querySelector('#workflowSummaryModal .modal-title');
      if (modalTitle) modalTitle.innerHTML = '<i class="fas fa-cogs text-info"></i> Transformation Configuration';

      // 2. JSON Export
      const jsonString = JSON.stringify(transformConfig, null, 2);
      const jsonEl = document.getElementById('workflowJsonContent');
      if (jsonEl) jsonEl.textContent = jsonString;

      // 3. YAML Export
      let yamlString = "";
      if (typeof jsyaml !== 'undefined') {
        yamlString = jsyaml.dump(transformConfig);
      } else {
        yamlString = "# YAML generator not loaded. See JSON tab.";
      }

      const yamlEl = document.getElementById('workflowYamlContent');
      if (yamlEl) yamlEl.textContent = yamlString;

      // 4. Narrative Export
      const narrativeEl = document.getElementById('workflowNarrativeContent');
      if (narrativeEl) {
        narrativeEl.innerHTML = generateNarrative(transformConfig);
      }

      // 5. Show Modal, then hide Jobs tab AFTER modal is fully rendered
      const modalEl = document.getElementById('workflowSummaryModal');
      if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);

        // Use one-time event listener to activate tab AFTER Bootstrap finishes rendering
        modalEl.addEventListener('shown.bs.modal', function onShown() {
          modalEl.removeEventListener('shown.bs.modal', onShown);

          // Hide Jobs tab (it may have been shown by Workflow modal)
          const jobsTabLi = document.getElementById('jobs-tab-li');
          if (jobsTabLi) jobsTabLi.classList.add('d-none');

          // Activate the correct tab
          let tabId = '#json-tab';
          if (initialTab === 'narrative') tabId = '#narrative-tab';
          else if (initialTab === 'yaml') tabId = '#yaml-tab';
          const tabTrigger = document.querySelector(tabId);
          if (tabTrigger) {
            const tab = new bootstrap.Tab(tabTrigger);
            tab.show();
          }
        });

        modal.show();
      } else {
        console.warn("Workflow Summary Modal not found.");
      }
    }

    function generateNarrative(config) {
      const sources = config.sources || config.inputs || [];
      const transformations = config.transformations || config.logic || {};
      const joins = transformations.joins || [];
      const calcCols = transformations.calculatedColumns || [];
      const filters = transformations.filters || [];
      const modelKeys = transformations.modelKeyColumns || [];
      const designType = config.meta?.designType || 'Unknown';
      const jobName = config.meta?.jobName || 'Untitled';
      const targetTable = config.target?.table || config.targetConnection?.table || 'output';
      const targetCatalog = config.target?.catalog || 'main';
      const targetSchema = config.target?.schema || 'default';
      const writeMode = config.target?.writeMode || 'CREATE';
      const sourceProvider = config.source?.provider || config.sourceConnection?.provider || 'Unknown';
      const sourceType = config.source?.type || config.sourceConnection?.type || 'Unknown';

      let html = `
        <div class="p-2">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
            <div>
              <h5 class="mb-0 text-primary"><i class="fas fa-cogs me-2"></i> ${jobName}</h5>
              <small class="text-muted">Transformation Configuration Summary</small>
            </div>
            <span class="badge bg-primary rounded-pill">${designType}</span>
          </div>

          <!-- Plain English Summary -->
          <div class="mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-book-open me-2 text-secondary"></i> Configuration Summary</h6>
            <div class="bg-light rounded p-3 mb-3">
              <p class="mb-2">This transformation is configured as a <strong>${designType}</strong> pipeline named <strong>"${jobName}"</strong>.</p>
              <p class="mb-2">It reads data from <strong>${sources.length} source table${sources.length !== 1 ? 's' : ''}</strong> on <strong>${sourceProvider}</strong> (${sourceType}) and writes the results to <strong>${targetCatalog}.${targetSchema}.${targetTable}</strong> using <code>${writeMode}</code> mode.</p>
      `;

      // Source tables description
      if (sources.length > 0) {
        html += `<p class="mb-1"><strong>Source Tables:</strong></p><ul class="mb-2">`;
        sources.forEach(input => {
          html += `<li><i class="fas fa-table me-1 text-primary"></i> <strong>${input.table}</strong> â€” ${input.columns.length} column${input.columns.length !== 1 ? 's' : ''} selected</li>`;
        });
        html += `</ul>`;
      }

      html += `</div></div>`;

      // Joins
      if (joins.length > 0) {
        html += `
          <div class="mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-link me-2 text-info"></i> Joins</h6>
            <div class="bg-light rounded p-3">
              <p class="mb-2">The pipeline joins ${joins.length} table pair${joins.length !== 1 ? 's' : ''} together:</p>
              <ul class="mb-0">`;
        joins.forEach((j, i) => {
          const conditions = j.conditions.map(c => `<code>${c.left}</code> = <code>${c.right}</code>`).join(' and ');
          html += `<li class="mb-1"><strong>${j.left}</strong> is joined with <strong>${j.right}</strong> where ${conditions}</li>`;
        });
        html += `</ul></div></div>`;
      }

      // Filters
      if (filters.length > 0) {
        html += `
          <div class="mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-filter me-2 text-warning"></i> Filters</h6>
            <div class="bg-light rounded p-3">
              <p class="mb-2">The following filter${filters.length !== 1 ? 's are' : ' is'} applied to narrow down the data:</p>
              <ul class="mb-0">`;
        filters.forEach(f => html += `<li class="mb-1"><code>${f}</code></li>`);
        html += `</ul></div></div>`;
      }

      // Calculated Columns
      if (calcCols.length > 0) {
        html += `
          <div class="mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-calculator me-2 text-success"></i> Calculated Columns</h6>
            <div class="bg-light rounded p-3">
              <p class="mb-2">${calcCols.length} new column${calcCols.length !== 1 ? 's are' : ' is'} derived from existing data:</p>
              <ul class="mb-0">`;
        calcCols.forEach(c => html += `<li class="mb-1"><strong>${c.name}</strong> â€” defined as <code>${c.expression}</code></li>`);
        html += `</ul></div></div>`;
      }

      // Model Key Columns
      if (modelKeys.length > 0) {
        html += `
          <div class="mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-key me-2 text-danger"></i> Model Key Columns</h6>
            <div class="bg-light rounded p-3">
              <p class="mb-2">The following column${modelKeys.length !== 1 ? 's are' : ' is'} designated as model key${modelKeys.length !== 1 ? 's' : ''}:</p>
              <ul class="mb-0">`;
        modelKeys.forEach(k => html += `<li class="mb-1"><code>${k}</code></li>`);
        html += `</ul></div></div>`;
      }

      // Target
      html += `
          <div class="mb-3">
            <h6 class="fw-bold mb-3"><i class="fas fa-bullseye me-2 text-success"></i> Target Output</h6>
            <div class="bg-light rounded p-3">
              <p class="mb-0">The final result is written to <strong>${targetCatalog}.${targetSchema}.${targetTable}</strong> using <code>${writeMode}</code> write mode.</p>
            </div>
          </div>
        </div>
      `;

      return html;
    }

    // Show Databricks Workflow JAR Configuration (called by Export Workflow Configuration button)
    // Global state to store current generated tasks for filtering
    let currentWorkflowTasks = [];
    let selectedTaskKeys = new Set();

    // Show Databricks Workflow JAR Configuration (called by Export Workflow Configuration button)
    function showWorkflowSummary() {
      // 1. Generate All Possible Tasks based on current config
      const transformConfig = generateTransformConfig();
      currentWorkflowTasks = generateWorkflowTasks(transformConfig);

      // 2. Select All by Default on first load
      selectedTaskKeys.clear();
      currentWorkflowTasks.forEach(t => selectedTaskKeys.add(t.task_key));

      // 3. Render the Job List UI
      renderWorkflowJobList();

      // 4. Generate JSON/YAML based on selection
      updateWorkflowExport(transformConfig);

      // 5. Show Modal and activate Select Jobs Tab
      const modalEl = document.getElementById('workflowSummaryModal');
      if (modalEl) {
        // Set title for Workflow mode
        const modalTitle = document.querySelector('#workflowSummaryModal .modal-title');
        if (modalTitle) modalTitle.innerHTML = '<i class="fas fa-project-diagram text-primary"></i> Workflow Configuration';

        const modal = new bootstrap.Modal(modalEl);

        // Use one-time event to show Jobs tab AFTER Bootstrap finishes rendering
        modalEl.addEventListener('shown.bs.modal', function onShown() {
          modalEl.removeEventListener('shown.bs.modal', onShown);

          // Show the Jobs tab (hidden by default in HTML)
          const jobsTabLi = document.getElementById('jobs-tab-li');
          if (jobsTabLi) jobsTabLi.classList.remove('d-none');
        });

        modal.show();
      }
    }

    // Helper: Generate the full list of tasks (Logic extracted from original showWorkflowSummary)
    function generateWorkflowTasks(transformConfig) {
      const jobName = transformConfig.meta.jobName;
      const safeJobName = jobName.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase();

      // Determine Layer and Job Type
      const isDataMart = (transformConfig.meta.designType === 'DATA_MART' || transformConfig.meta.designType.includes("Mart"));
      const layer = isDataMart ? "DM" : "DW";
      const jobType = jobName.toLowerCase().startsWith('fact') || isDataMart ? "FACT" : "DIMENSION";

      const jobClusterKey = `${layer}_Job_Cluster`;

      const tasks = [];
      const jarLibrary = { jar: "dbfs:/FileStore/jars/etl-pipeline-assembly-1.0.jar" };
      const mainClass = "com.databricks.pipelines.EtlRunner";

      // 1. Ingestion/Extraction Tasks (One per input)
      (transformConfig.sources || transformConfig.inputs).forEach(input => {
        const cleanTableName = input.table.split('.')[1] || input.table;
        const safeTableName = cleanTableName.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase();

        tasks.push({
          task_key: `ingest_${safeTableName}`,
          description: `Ingest ${cleanTableName} data from source into ${layer} Raw layer`,
          job_cluster_key: jobClusterKey,
          spark_jar_task: {
            main_class_name: mainClass,
            parameters: [
              "--layer", layer,
              "--jobType", jobType,
              "--jobName", cleanTableName,
              "--phase", "EXTRACTION",
              "--target", `stg.${layer.toLowerCase()}_${cleanTableName}_raw`
            ]
          },
          libraries: [jarLibrary]
        });
      });

      // 2. Staging Task (Aggregated)
      const extractionDeps = tasks.map(t => ({ task_key: t.task_key }));
      const sources = transformConfig.sources || transformConfig.inputs;
      const primarySource = sources[0] ? (sources[0].table.split('.')[1] || sources[0].table) : "unknown";

      tasks.push({
        task_key: `stage_${safeJobName}`,
        description: `Cleanse, Validate and Stage ${jobName} data`,
        depends_on: extractionDeps, // Initially depends on ALL ingestion tasks
        job_cluster_key: jobClusterKey,
        spark_jar_task: {
          main_class_name: mainClass,
          parameters: [
            "--layer", layer,
            "--jobType", jobType,
            "--jobName", jobName,
            "--phase", "STAGING",
            "--source", `stg.${layer.toLowerCase()}_${primarySource}_raw`,
            "--target", `stg.${layer.toLowerCase()}_${jobName}_stage`
          ]
        },
        libraries: [jarLibrary]
      });

      // 3. Execution Task
      const transformations = transformConfig.transformations || transformConfig.logic;
      tasks.push({
        task_key: `load_${safeJobName}`,
        description: `Load final ${jobName} into ${layer} layer`,
        depends_on: [{ task_key: `stage_${safeJobName}` }],
        job_cluster_key: jobClusterKey,
        spark_jar_task: {
          main_class_name: mainClass,
          parameters: [
            "--layer", layer,
            "--jobType", jobType,
            "--jobName", jobName,
            "--phase", "EXECUTION",
            "--source", `stg.${layer.toLowerCase()}_${jobName}_stage`,
            "--target", `${transformConfig.output.catalog}.${transformConfig.output.schema}.${transformConfig.output.table}`,
            "--config_payload", JSON.stringify(transformations)
          ]
        },
        libraries: [jarLibrary]
      });

      // 4. Optimization Task
      tasks.push({
        task_key: `optimize_${safeJobName}`,
        description: `Optimize and Z-Order ${jobName} table`,
        depends_on: [{ task_key: `load_${safeJobName}` }],
        job_cluster_key: jobClusterKey,
        spark_jar_task: {
          main_class_name: mainClass,
          parameters: [
            "--layer", layer,
            "--module", "optimize",
            "--target", `${transformConfig.output.catalog}.${transformConfig.output.schema}.${transformConfig.output.table}`,
            "--zorder_cols", transformations.modelKeyColumns.map(c => c.name).join(',') || 'id'
          ]
        },
        libraries: [jarLibrary]
      });

      return tasks;
    }

    // Render the list of jobs with checkboxes
    function renderWorkflowJobList() {
      const container = document.getElementById('workflowJobList');
      if (!container) return;
      container.innerHTML = '';

      if (currentWorkflowTasks.length === 0) {
        container.innerHTML = '<div class="text-center p-3">No tasks generated. Configure pipeline first.</div>';
        return;
      }

      currentWorkflowTasks.forEach(task => {
        const isSelected = selectedTaskKeys.has(task.task_key);
        const html = `
          <div class="list-group-item">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="${task.task_key}" id="chk_${task.task_key}" ${isSelected ? 'checked' : ''} onchange="toggleJobSelection('${task.task_key}')">
              <label class="form-check-label w-100" for="chk_${task.task_key}">
                <div class="d-flex justify-content-between">
                   <strong>${task.task_key}</strong>
                   <span class="badge bg-light text-dark border">${task.spark_jar_task ? 'Spark JAR' : 'Task'}</span>
                </div>
                <div class="text-muted small">${task.description}</div>
              </label>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    function toggleJobSelection(taskKey) {
      if (selectedTaskKeys.has(taskKey)) {
        selectedTaskKeys.delete(taskKey);
      } else {
        selectedTaskKeys.add(taskKey);
      }
      // Re-generate JSON
      updateWorkflowExport();
    }

    function toggleAllJobs(selectAll) {
      if (selectAll) {
        currentWorkflowTasks.forEach(t => selectedTaskKeys.add(t.task_key));
      } else {
        selectedTaskKeys.clear();
      }
      renderWorkflowJobList();
      updateWorkflowExport();
    }

    // Filter tasks and generate final JSON/YAML
    function updateWorkflowExport(config = null) {
      const transformConfig = config || generateTransformConfig(); // Use passed config or regen
      const jobName = transformConfig.meta.jobName;
      const isDataMart = (transformConfig.meta.designType === 'DATA_MART' || transformConfig.meta.designType.includes("Mart"));
      const layer = isDataMart ? "DM" : "DW";
      const jobClusterKey = `${layer}_Job_Cluster`;

      // FILTER TASKS
      const filteredTasks = currentWorkflowTasks.filter(t => selectedTaskKeys.has(t.task_key));

      // Cleanup Dependencies: Remove depends_on if the dependency is not selected
      const finalTasks = filteredTasks.map(task => {
        // Deep copy to avoid mutating original
        const t = JSON.parse(JSON.stringify(task));
        if (t.depends_on) {
          t.depends_on = t.depends_on.filter(dep => selectedTaskKeys.has(dep.task_key));
        }
        return t;
      });

      // Construct Standard Databricks Job JSON (API v2.1)
      const databricksJobConfig = {
        name: `${jobName}_${layer.toLowerCase()}_pipeline`,
        email_notifications: {
          on_failure: ["admin@example.com"],
          no_alert_for_skipped_runs: false
        },
        timeout_seconds: 7200,
        max_retries: 1,
        schedule: {
          quartz_cron_expression: "0 0 5 * * ?",
          timezone_id: "UTC",
          pause_status: "PAUSED"
        },
        job_clusters: [
          {
            job_cluster_key: jobClusterKey,
            new_cluster: {
              spark_version: "13.3.x-scala2.12",
              node_type_id: "i3.xlarge",
              num_workers: 2,
              spark_conf: {
                "spark.databricks.delta.preview.enabled": "true"
              }
            }
          }
        ],
        tasks: finalTasks,
        format: "MULTI_TASK"
      };

      // 1. JSON Export
      const jsonString = JSON.stringify(databricksJobConfig, null, 2);
      const jsonEl = document.getElementById('workflowJsonContent');
      if (jsonEl) jsonEl.textContent = jsonString;

      // 2. YAML Export
      const yamlEl = document.getElementById('workflowYamlContent');
      if (yamlEl) {
        if (typeof jsyaml !== 'undefined') {
          yamlEl.textContent = jsyaml.dump(databricksJobConfig);
        } else {
          yamlEl.textContent = "# js-yaml library not loaded. See JSON tab.";
        }
      }
      // 3. Narrative for Workflow (Business Friendly Flow)
      const narrativeEl = document.getElementById('workflowNarrativeContent');
      if (narrativeEl) {
        let narrative = ``;

        // 1. Data Source Section
        const sourceSystem = transformConfig.source?.provider || "External System";
        const sourceTables = transformConfig.sources ? transformConfig.sources.map(s => s.table).join(", ") : "various tables";

        narrative += `<div class="d-flex mb-4">
          <div class="me-3"><div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;"><i class="fas fa-database text-primary fa-lg"></i></div></div>
          <div>
            <h6 class="fw-bold mb-1">Data Source</h6>
            <p class="mb-0 text-muted small">We are ingesting data from <strong>${sourceSystem}</strong>. The pipeline connects to the source system and securely reads data from the following tables: <em>${sourceTables}</em>.</p>
          </div>
        </div>`;

        // 2. Business Logic Section
        const transformations = [];
        if (transformConfig.transformations?.filters?.length > 0) transformations.push("filtering out irrelevant records");
        if (transformConfig.transformations?.joins?.length > 0) transformations.push("combining datasets via joins");
        if (transformConfig.transformations?.aggregations?.length > 0) transformations.push("aggregating metrics");
        if (transformConfig.transformations?.calculatedColumns?.length > 0) transformations.push("calculating new business metrics");

        const transformText = transformations.length > 0
          ? `The data undergoes processing to ensure quality and relevance. This includes <strong>${transformations.join(", ")}</strong> to derive meaningful insights.`
          : "The data undergoes standard normalization and validation processing.";

        narrative += `<div class="d-flex mb-4">
          <div class="me-3"><div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;"><i class="fas fa-cogs text-warning fa-lg"></i></div></div>
          <div>
            <h6 class="fw-bold mb-1">Business Logic & Transformation</h6>
            <p class="mb-0 text-muted small">${transformText}</p>
          </div>
        </div>`;

        // 3. Target Destination Section
        const targetTable = `${transformConfig.target?.catalog || 'main'}.${transformConfig.target?.schema || 'default'}.${transformConfig.target?.table || 'output'}`;
        const writeMode = transformConfig.target?.writeMode || 'MERGE';

        narrative += `<div class="d-flex mb-4">
          <div class="me-3"><div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;"><i class="fas fa-bullseye text-success fa-lg"></i></div></div>
          <div>
            <h6 class="fw-bold mb-1">Target Destination</h6>
            <p class="mb-0 text-muted small">The cleaned and transformed data is finalized and written to the <strong>${targetTable}</strong> table. We use a <em>${writeMode}</em> strategy to ensure the target is kept up-to-date.</p>
          </div>
        </div>`;

        // 4. Schedule Section
        const scheduleText = (databricksJobConfig.schedule && databricksJobConfig.schedule.pause_status !== 'PAUSED')
          ? `Automated to run <strong>${databricksJobConfig.schedule.quartz_cron_expression}</strong>.`
          : `Currently set to <strong>Manual Trigger</strong> only.`;

        narrative += `<div class="d-flex">
          <div class="me-3"><div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;"><i class="fas fa-clock text-info fa-lg"></i></div></div>
          <div>
            <h6 class="fw-bold mb-1">Schedule & Automation</h6>
            <p class="mb-0 text-muted small">This pipeline is fully configured for automation. ${scheduleText}</p>
          </div>
        </div>`;

        narrativeEl.innerHTML = narrative;
      }
    }

    /* Helper Functions */
    function copyToClipboard(elementId) {
      const el = document.getElementById(elementId);
      if (!el) return;
      const text = el.innerText;
      // Find the copy button that triggered this â€” it's the sibling before the pre
      const copyBtn = el.closest('.position-relative')?.querySelector('.btn-outline-primary');
      navigator.clipboard.writeText(text).then(() => {
        showNotification('Copied to clipboard!', 'success');
        // Visual feedback on the copy button
        if (copyBtn) {
          const originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.classList.remove('copied');
          }, 2000);
        }
      }, (err) => {
        console.error('Could not copy text: ', err);
        showNotification('Failed to copy', 'error');
      });
    }

    // Copy the content of the currently active tab in the modal footer
    function copyActiveTabContent() {
      const modal = document.getElementById('workflowSummaryModal');
      if (!modal) return;
      const activePane = modal.querySelector('.tab-pane.show.active');
      if (!activePane) { showNotification('No active tab to copy.', 'warning'); return; }

      let textToCopy = '';
      const pre = activePane.querySelector('pre');
      const narrative = activePane.querySelector('#workflowNarrativeContent');
      if (pre) {
        textToCopy = pre.innerText;
      } else if (narrative) {
        textToCopy = narrative.innerText;
      } else {
        textToCopy = activePane.innerText;
      }

      const footerBtn = modal.querySelector('.modal-footer .btn-outline-primary');
      navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification('Copied to clipboard!', 'success');
        if (footerBtn) {
          const original = footerBtn.innerHTML;
          footerBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
          footerBtn.classList.replace('btn-outline-primary', 'btn-outline-success');
          setTimeout(() => {
            footerBtn.innerHTML = original;
            footerBtn.classList.replace('btn-outline-success', 'btn-outline-primary');
          }, 2000);
        }
      }, () => {
        showNotification('Failed to copy.', 'error');
      });
    }

    function downloadWorkflowConfig() {
      const jsonContent = document.getElementById('workflowJsonContent').textContent;
      const blob = new Blob([jsonContent], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "databricks_workflow_config.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Clear designer
    function clearDesigner() {
      if (!confirm('Are you sure you want to clear all selections?')) {
        return;
      }

      selectedTables = [];
      selectedColumns = {};
      joinConditions = [];
      computedColumns = [];
      filters = [];

      $('.table-item').removeClass('selected');
      $('#selectedTables').empty();
      $('#computedColumns').empty();
      $('#filterList').empty();
      $('#emptyMessage').show();
      $('#enableAggregation').prop('checked', false);
      $('#aggregationOptions').hide();

      generateSQL();
      showNotification('Designer cleared', 'info');
    }

    // Save transformation
    function saveTransformation() {
      const sql = $('#sqlPreview code').text();
      const tableName = $('#dmTableName').val();

      if (!tableName || tableName.trim() === '') {
        showNotification('Please enter a Data Mart table name', 'warning');
        return;
      }

      if (sql.includes('-- Configure target')) {
        showNotification('Please configure your transformation first', 'warning');
        return;
      }

      const catalog = $('#dmCatalog').val();
      const description = $('#dmDescription').val();
      const createMode = $('#createMode').val();

      const config = {
        target: {
          catalog: catalog,
          tableName: tableName,
          fullName: `${catalog}.${tableName}`,
          description: description,
          createMode: createMode
        },
        sources: {
          tables: selectedTables,
          columns: selectedColumns
        },
        transformations: {
          joins: joinConditions,
          calculatedColumns: computedColumns.filter(c => !c.isModelKey),
          modelKeyColumns: computedColumns.filter(c => c.isModelKey),
          filters: filters
        },
        sql: sql,
        timestamp: new Date().toISOString()
      };

      console.log('Transformation saved:', config);
      showNotification(`Data Mart "${catalog}.${tableName}" saved successfully!`, 'success');

      // In production, this would call an API to save the configuration
    }

    // --- Export Helper Functions ---
    function getWorkspaceSetupConfig() {
      const config = {};

      // 1. Lake Configuration
      const lakeCard = document.querySelector('#ws-lake .lake-card.selected');
      if (lakeCard) {
        const type = lakeCard.getAttribute('data-storage-type');
        config.lake = {
          provider: type,
          details: scrapeForm(`form-${type}`)
        };
      } else {
        config.lake = { status: 'Not Configured' };
      }

      // 2. Staging Configuration
      const stagingCard = document.querySelector('#ws-staging .lake-card.selected');
      if (stagingCard) {
        const type = stagingCard.getAttribute('data-db-type');
        config.staging = {
          type: type,
          details: scrapeForm(`staging-form-${type}`)
        };
      } else {
        config.staging = { status: 'Not Configured' };
      }

      // 3. Metadata (Schedule) Configuration
      const schedCard = document.querySelector('#ws-schedule .lake-card.selected');
      if (schedCard) {
        const type = schedCard.getAttribute('data-db-type');
        config.metadataDatabase = {
          type: type,
          details: scrapeForm(`schedule-form-${type}`)
        };
      } else {
        config.metadataDatabase = { status: 'Not Configured' };
      }

      // 4. Compute Configuration
      config.compute = scrapeForm('compute-form-main');

      // 5. Security Configuration
      config.security = scrapeForm('security-form-main');

      // 6. Naming Standards
      config.naming = scrapeForm('naming-form-main');

      return config;
    }

    function scrapeForm(formId) {
      const form = document.getElementById(formId);
      if (!form) return {};
      const data = {};

      // Inputs & Selects
      form.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(el => {
        const label = findLabel(el);
        // Basic value clean up
        let val = el.value;
        if (el.type === 'password') val = '***REDACTED***';

        if (label) data[label] = val;
      });

      // Checkboxes
      form.querySelectorAll('input[type="checkbox"]').forEach(el => {
        const label = findLabel(el);
        if (label) data[label] = el.checked;
      });

      return data;
    }

    function findLabel(el) {
      // 1. Try previous sibling label
      let prev = el.previousElementSibling;
      if (prev && prev.tagName === 'LABEL') return prev.innerText;

      // 2. Try parent's previous sibling (for input groups)
      if (el.parentElement.classList.contains('input-group')) {
        let parentPrev = el.parentElement.previousElementSibling;
        if (parentPrev && parentPrev.tagName === 'LABEL') {
          // Add prefix if it's an input group with text (e.g. Min/Max)
          const groupText = el.previousElementSibling ? el.previousElementSibling.innerText : '';
          return parentPrev.innerText + (groupText ? ` (${groupText})` : '');
        }
      }

      // 3. Try wrapping label (checkboxes often inside div > label) or next sibling
      if (el.type === 'checkbox') {
        let next = el.nextElementSibling;
        if (next && next.tagName === 'LABEL') return next.innerText;
      }

      return el.name || el.id || 'Field';
    }

    // Show Configuration Summary
    function showConfigurationSummary() {
      // 1. Gather Source Connection Details
      // Note: These IDs should match Step 1 inputs (assuming they exist)
      const sourceConnectionMode = document.querySelector('input[name="connectionMode"]:checked')?.id === 'modeApi' ? 'API' : 'JDBC';
      const sourceConnection = {
        mode: sourceConnectionMode,
        role: $('#connectionRole').val() || 'source',
        workspaceUrl: $('#workspaceUrl').val() || 'N/A',
        accessToken: $('#accessToken').val() ? '***REDACTED***' : 'N/A'
      };

      if (sourceConnectionMode === 'JDBC') {
        sourceConnection.serverHost = $('#serverHost').val() || 'N/A';
        sourceConnection.serverPort = $('#serverPort').val() || 'N/A';
        sourceConnection.httpPath = $('#httpPath').val() || 'N/A';
      }

      // 2. Gather Target Connection Details
      // Assuming Step 2 inputs exist as per original code
      const targetConnMode = document.querySelector('input[name="targetConnectionMode"]:checked')?.value || 'same';
      let targetConnection = {
        mode: targetConnMode,
        role: 'target'
      };

      if (targetConnMode === 'same') {
        targetConnection.details = 'Same as Source Connection';
        targetConnection.connectionId = 'current';
      } else if (targetConnMode === 'existing') {
        const selectedConn = document.getElementById('targetConnectionSelect');
        if (selectedConn) {
          targetConnection.connectionId = selectedConn.value;
          targetConnection.connectionName = selectedConn.options[selectedConn.selectedIndex].text;
        }
      } else if (targetConnMode === 'new') {
        const hostInput = document.getElementById('targetNewHost');
        const tokenInput = document.getElementById('targetNewToken');

        targetConnection.workspaceUrl = hostInput ? (hostInput.value || 'N/A') : 'N/A';
        targetConnection.accessToken = (tokenInput && tokenInput.value) ? '***REDACTED***' : 'N/A';
        if (document.getElementById('targetConnectionRole')) {
          targetConnection.role = document.getElementById('targetConnectionRole').value;
        }
      }

      // 3. Gather Metadata Details
      const metadataDetails = {
        catalog: $('#metaCatalogSelect').val() || $('#metaCatalog').text(),
        schemasLoaded: $('#schemaCount').text() || 'N/A',
        tablesLoaded: $('#tableCount').text() || 'N/A',
        lastSync: $('#lastSync').text() || 'N/A'
      };

      // 4. Gather Design/Transformation Details
      // UPDATED: Use proper IDs from Step 3
      const targetCatalog = $('#dmCatalog').val() || 'main.dm';
      const targetTable = $('#dmTableName').val() || 'output_table';
      const description = $('#dmDescription').val() || '';
      const createMode = $('#createMode').val() || 'CREATE OR REPLACE';

      // UPDATED: Logic for Design Type Radio Buttons
      const designTypeEl = document.querySelector('input[name="designType"]:checked');
      const designType = (designTypeEl && designTypeEl.id === 'designTypeDW') ? 'Data Warehouse' : 'Data Mart';

      const designDetails = {
        designType: designType,
        defaultTableRoles: defaultTableRoles, // Include default role mappings for DM mode
        target: {
          catalog: targetCatalog,
          tableName: targetTable,
          fullName: `${targetCatalog}.${targetTable}`,
          description: description,
          createMode: createMode
        },
        sources: {
          tables: selectedTables,
          tableTypes: tableTypes, // UPDATED: Include Lookup/Driving types
          selectedColumns: selectedColumns
        },
        transformations: {
          joins: joinConditions, // Includes unique IDs and clauses
          calculatedColumns: computedColumns.filter(c => !c.isModelKey),
          modelKeyColumns: computedColumns.filter(c => c.isModelKey),
          filters: filters,
          aggregation: aggregationConfig // UPDATED: Use global config object
        }
      };

      // Get SQL from the Create Query tab
      const generatedSQL = $('#sqlPreviewCreate code').text();

      // Build complete configuration
      const completeConfig = {
        jobName: targetTable,
        createdAt: new Date().toISOString(),
        workspaceSetup: getWorkspaceSetupConfig(), // Added Workspace Config
        sourceConnection: sourceConnection,
        targetConnection: targetConnection,
        metadata: metadataDetails,
        design: designDetails,
        generatedSQL: generatedSQL
      };

      // Display in modal
      $('#configSummaryContent code').text(JSON.stringify(completeConfig, null, 2));

      const modal = new bootstrap.Modal(document.getElementById('configSummaryModal'));
      modal.show();
    }

    // Workflow Stepper Logic
    function activateStep(stepId) {
      // Hide all steps
      $('.step-pane').removeClass('active');
      $('.stepper-step').removeClass('active');

      // Show selected step
      $('#step-' + stepId).addClass('active');

      // Update stepper UI
      const steps = ['connect', 'metadata', 'target', 'transform', 'vcs', 'execute'];
      const activeIndex = steps.indexOf(stepId);

      // Auto-apply Target Preference if entering Target step
      if (stepId === 'target' && window.useSourceForTargetPreference) {
        selectTargetMode('same', document.querySelector('#targetModeGrid .connection-option')); // Simulate click on first option
        document.getElementById('targetConnHelp').innerHTML = '<i class="fas fa-check-circle text-success"></i> <strong>Pre-selected:</strong> You chose to use the Source connection.';
      }

      $('.stepper-step').each(function (index) {
        if (index <= activeIndex) {
          $(this).addClass('active');
        }
      });
    }

    // Copy configuration to clipboard
    function copyConfigToClipboard() {
      const configText = $('#configSummaryContent code').text();
      navigator.clipboard.writeText(configText).then(() => {
        showNotification('Configuration copied to clipboard!', 'success');
      }).catch(err => {
        showNotification('Failed to copy to clipboard', 'error');
        console.error('Copy failed:', err);
      });
    }

    // Download configuration as JSON file
    function downloadConfig() {
      const configText = $('#configSummaryContent code').text();
      const tableName = $('#dmTableName').val() || 'config';
      const filename = `${tableName}_config_${new Date().getTime()}.json`;

      const blob = new Blob([configText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification(`Configuration downloaded as ${filename}`, 'success');
    }

    // Execute Job
    function executeJob() {
      // Show loading state
      const btn = event.target;
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
      btn.disabled = true;

      // Simulate API call
      setTimeout(() => {
        showNotification('Job execution started successfully!', 'success');
        btn.innerHTML = originalHTML;
        btn.disabled = false;

        // Update job status
        updateJobStatus();
      }, 2000);
    }



    // Update job status
    function updateJobStatus() {
      // Simulate real-time job status update
      const jobStatusHTML = `
    <tr>
      <td><strong>sales_summary_dm</strong></td>
      <td><code>run_12346</code></td>
      <td><span class="badge bg-primary">Running</span></td>
      <td>0m 15s</td>
      <td>${new Date().toLocaleString('en-IN')}</td>
      <td>
        <button class="btn btn-sm btn-outline-warning"><i class="fas fa-stop"></i> Cancel</button>
      </td>
    </tr>
  `;

      console.log('Job status updated');
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const alertClass = type === 'success' ? 'alert-success' :
        type === 'error' ? 'alert-danger' :
          type === 'warning' ? 'alert-warning' : 'alert-info';

      const notification = $(`
    <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `);

      $('body').append(notification);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.alert('close');
      }, 5000);
    }

    // Initialize on document ready
    $(document).ready(function () {
      console.log('Databricks ELT UI initialized');

      // Add click handlers for step cards (only for header, not content)
      $('.flow-step-header').on('click', function (e) {
        // Only toggle if clicking on header area, not on buttons
        if (!$(e.target).is('button') && !$(e.target).closest('button').length) {
          const btn = $(this).find('button').first();
          toggleDetails(btn[0]);
        }
      });

      // Add hover effect to cards
      $('.step-card, .flow-step').hover(
        function () {
          $(this).addClass('shadow-lg');
        },
        function () {
          $(this).removeClass('shadow-lg');
        }
      );

      // Simulate real-time updates
      setInterval(() => {
        const now = new Date();
        console.log('Real-time update:', now.toLocaleTimeString());
      }, 30000);

      // Add search functionality for catalog
      $('input[placeholder="Search tables..."]').on('keyup', function () {
        const searchTerm = $(this).val().toLowerCase();
        $('.table tbody tr').filter(function () {
          $(this).toggle($(this).text().toLowerCase().indexOf(searchTerm) > -1);
        });
      });
    });

    // Tab change event
    $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
      const target = $(e.target).attr("href");
      console.log('Tab changed to:', target);

      if (target === '#catalog') {
        showNotification('Loaded 47 tables from Unity Catalog', 'info');
      } else if (target === '#jobs') {
        showNotification('Monitoring 24 active jobs', 'info');
      } else if (target === '#lineage') {
        showNotification('Lineage graph loaded successfully', 'info');
      } else if (target === '#monitoring') {
        showNotification('Real-time metrics updated', 'info');
      }
    });

    // API simulation functions
    function fetchCatalogData() {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            catalogs: ['main', 'analytics'],
            schemas: {
              main: ['dw', 'dm', 'staging'],
              analytics: ['reports']
            },
            tables: {
              'main.dw': [
                { name: 'sales_orders', rows: 2547893, size: '1.2 GB' },
                { name: 'customers', rows: 150432, size: '45 MB' }
              ]
            }
          });
        }, 1000);
      });
    }

    function executeJobAPI(jobConfig) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            run_id: 'run_' + Math.floor(Math.random() * 100000),
            status: 'RUNNING',
            started_at: new Date().toISOString()
          });
        }, 1500);
      });
    }

    function getLineageData(tableName) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            target: tableName,
            sources: ['dw.sales_orders', 'dw.customers', 'dw.products'],
            transformations: ['JOIN', 'AGGREGATE', 'FILTER']
          });
        }, 800);
      });
    }

    // ===== Job Management Functions =====

    // Show schedule modal
    function showScheduleModal() {
      const modal = `
    <div class="modal fade" id="scheduleModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-clock"></i> Schedule Databricks Job</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label"><strong>Job Name</strong></label>
              <input type="text" class="form-control" id="scheduleJobName" 
                     value="sales_summary_dm" readonly>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><strong>Schedule Type</strong></label>
              <select class="form-select" id="scheduleType" onchange="toggleScheduleOptions()">
                <option value="manual">Manual Only</option>
                <option value="cron" selected>Cron Expression</option>
                <option value="interval">Time Interval</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            
            <!-- Cron Expression -->
            <div id="cronOptions" class="mb-3">
              <label class="form-label"><strong>Cron Expression</strong></label>
              <input type="text" class="form-control" id="cronExpression" 
                     placeholder="0 2 * * *" value="0 2 * * *">
              <small class="text-muted">Format: minute hour day month day-of-week</small>
              <div class="mt-2">
                <strong>Quick Templates:</strong>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="setCron('0 0 * * *')">Midnight</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCron('0 2 * * *')">2:00 AM</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCron('0 */6 * * *')">Every 6 hours</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setCron('0 0 * * 0')">Weekly (Sunday)</button>
              </div>
            </div>
            
            <!-- Interval Options -->
            <div id="intervalOptions" class="mb-3" style="display:none;">
              <label class="form-label"><strong>Run Every</strong></label>
              <div class="row">
                <div class="col-md-6">
                  <input type="number" class="form-control" id="intervalValue" min="1" value="6">
                </div>
                <div class="col-md-6">
                  <select class="form-select" id="intervalUnit">
                    <option value="minutes">Minutes</option>
                    <option value="hours" selected>Hours</option>
                    <option value="days">Days</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Daily Options -->
            <div id="dailyOptions" class="mb-3" style="display:none;">
              <label class="form-label"><strong>Time</strong></label>
              <input type="time" class="form-control" id="dailyTime" value="02:00">
            </div>
            
            <!-- Weekly Options -->
            <div id="weeklyOptions" class="mb-3" style="display:none;">
              <label class="form-label"><strong>Day of Week</strong></label>
              <select class="form-select" id="weekDay">
                <option value="0">Sunday</option>
                <option value="1" selected>Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
              <label class="form-label mt-2"><strong>Time</strong></label>
              <input type="time" class="form-control" id="weeklyTime" value="02:00">
            </div>
            
            <!-- Monthly Options -->
            <div id="monthlyOptions" class="mb-3" style="display:none;">
              <label class="form-label"><strong>Day of Month</strong></label>
              <input type="number" class="form-control" id="monthDay" min="1" max="31" value="1">
              <label class="form-label mt-2"><strong>Time</strong></label>
              <input type="time" class="form-control" id="monthlyTime" value="02:00">
            </div>
            
            <div class="mb-3">
              <label class="form-label"><strong>Timezone</strong></label>
              <select class="form-select" id="timezone">
                <option value="UTC">UTC</option>
                <option value="Asia/Kolkata" selected>Asia/Kolkata (IST)</option>
                <option value="America/New_York">America/New_York (EST)</option>
                <option value="Europe/London">Europe/London (GMT)</option>
              </select>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> <strong>Preview:</strong>
              <div id="schedulePreview" class="mt-2">
                Next run: <strong>Tomorrow at 2:00 AM IST</strong>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveSchedule()">
              <i class="fas fa-save"></i> Save Schedule
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

      $('#scheduleModal').remove();
      $('body').append(modal);
      const modalInstance = new bootstrap.Modal(document.getElementById('scheduleModal'));
      modalInstance.show();
    }

    // Toggle schedule options based on type
    function toggleScheduleOptions() {
      const scheduleType = $('#scheduleType').val();

      $('#cronOptions, #intervalOptions, #dailyOptions, #weeklyOptions, #monthlyOptions').hide();

      switch (scheduleType) {
        case 'cron':
          $('#cronOptions').show();
          break;
        case 'interval':
          $('#intervalOptions').show();
          break;
        case 'daily':
          $('#dailyOptions').show();
          break;
        case 'weekly':
          $('#weeklyOptions').show();
          break;
        case 'monthly':
          $('#monthlyOptions').show();
          break;
      }
    }

    // Set cron expression
    function setCron(expression) {
      $('#cronExpression').val(expression);
    }

    // Save schedule
    function saveSchedule() {
      const scheduleType = $('#scheduleType').val();
      const timezone = $('#timezone').val();

      let scheduleConfig = {
        jobName: $('#scheduleJobName').val(),
        type: scheduleType,
        timezone: timezone
      };

      switch (scheduleType) {
        case 'cron':
          scheduleConfig.expression = $('#cronExpression').val();
          break;
        case 'interval':
          scheduleConfig.interval = {
            value: $('#intervalValue').val(),
            unit: $('#intervalUnit').val()
          };
          break;
        case 'daily':
          scheduleConfig.time = $('#dailyTime').val();
          break;
        case 'weekly':
          scheduleConfig.day = $('#weekDay').val();
          scheduleConfig.time = $('#weeklyTime').val();
          break;
        case 'monthly':
          scheduleConfig.day = $('#monthDay').val();
          scheduleConfig.time = $('#monthlyTime').val();
          break;
      }

      console.log('Schedule saved:', scheduleConfig);
      showNotification('Job schedule configured successfully!', 'success');

      // Close modal
      bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();

      // In production, this would call Databricks Jobs API to set the schedule
    }

    // Create new job
    function createNewJob() {
      showNotification('Please create a transformation in the Workflow Designer tab first', 'info');
      // Switch to workflow tab
      $('#workflow-tab').tab('show');
    }

    // Edit job
    function editJob(jobName) {
      const modal = `
    <div class="modal fade" id="editJobModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Job: ${jobName}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label"><strong>Job Name</strong></label>
              <input type="text" class="form-control" value="${jobName}">
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Target Table</strong></label>
              <input type="text" class="form-control" value="main.dm.sales_summary">
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Status</strong></label>
              <select class="form-select">
                <option value="active" selected>Active</option>
                <option value="paused">Paused</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>SQL Query</strong></label>
              <textarea class="form-control" rows="8" readonly>CREATE OR REPLACE TABLE main.dm.sales_summary AS
SELECT 
  c.customer_id,
  c.customer_name,
  c.region,
  SUM(s.amount) as total_sales
FROM dw.customers c
INNER JOIN dw.sales_orders s ON c.customer_id = s.customer_id
GROUP BY c.customer_id, c.customer_name, c.region;</textarea>
            </div>
            <div class="mb-3">
              <button class="btn btn-outline-secondary btn-sm" onclick="showScheduleModal()">
                <i class="fas fa-clock"></i> Edit Schedule
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateJob('${jobName}')">
              <i class="fas fa-save"></i> Update Job
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

      $('#editJobModal').remove();
      $('body').append(modal);
      const modalInstance = new bootstrap.Modal(document.getElementById('editJobModal'));
      modalInstance.show();
    }

    // Update job
    function updateJob(jobName) {
      console.log('Updating job:', jobName);
      showNotification(`Job "${jobName}" updated successfully!`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('editJobModal')).hide();
    }

    // View job details
    function viewJobDetails(jobName) {
      const modal = `
    <div class="modal fade" id="jobDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-info-circle"></i> Job Details: ${jobName}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-3">Configuration</h6>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td><strong>Job Name:</strong></td>
                      <td>${jobName}</td>
                    </tr>
                    <tr>
                      <td><strong>Target Table:</strong></td>
                      <td><code>main.dm.sales_summary</code></td>
                    </tr>
                    <tr>
                      <td><strong>Status:</strong></td>
                      <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    <tr>
                      <td><strong>Schedule:</strong></td>
                      <td>Daily at 2:00 AM IST</td>
                    </tr>
                    <tr>
                      <td><strong>Created:</strong></td>
                      <td>2025-10-15 10:30</td>
                    </tr>
                    <tr>
                      <td><strong>Last Modified:</strong></td>
                      <td>2025-11-03 14:20</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3">Execution Stats (Last 7 Days)</h6>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td><strong>Total Runs:</strong></td>
                      <td>7</td>
                    </tr>
                    <tr>
                      <td><strong>Success:</strong></td>
                      <td><span class="text-success">7 (100%)</span></td>
                    </tr>
                    <tr>
                      <td><strong>Failed:</strong></td>
                      <td><span class="text-danger">0 (0%)</span></td>
                    </tr>
                    <tr>
                      <td><strong>Avg Duration:</strong></td>
                      <td>12m 34s</td>
                    </tr>
                    <tr>
                      <td><strong>Avg Rows Processed:</strong></td>
                      <td>2.1M rows</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <hr>
            
            <h6 class="mb-3">Transformation SQL</h6>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px;"><code>CREATE OR REPLACE TABLE main.dm.sales_summary AS
SELECT 
  c.customer_id,
  c.customer_name,
  c.region,
  c.customer_segment,
  SUM(s.amount) as total_sales,
  COUNT(s.order_id) as order_count,
  AVG(s.amount) as avg_order_value
FROM dw.customers c
INNER JOIN dw.sales_orders s ON c.customer_id = s.customer_id
WHERE s.order_date >= '2024-01-01'
GROUP BY c.customer_id, c.customer_name, c.region, c.customer_segment;</code></pre>
            
            <hr>
            
            <h6 class="mb-3">Recent Runs</h6>
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Run ID</th>
                  <th>Status</th>
                  <th>Started</th>
                  <th>Duration</th>
                  <th>Rows</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>run_12345</code></td>
                  <td><span class="badge bg-success">Success</span></td>
                  <td>2025-11-03 02:00</td>
                  <td>12m 34s</td>
                  <td>2.1M</td>
                </tr>
                <tr>
                  <td><code>run_12344</code></td>
                  <td><span class="badge bg-success">Success</span></td>
                  <td>2025-11-02 02:00</td>
                  <td>11m 58s</td>
                  <td>2.0M</td>
                </tr>
                <tr>
                  <td><code>run_12343</code></td>
                  <td><span class="badge bg-success">Success</span></td>
                  <td>2025-11-01 02:00</td>
                  <td>13m 12s</td>
                  <td>2.2M</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="editJob('${jobName}')">
              <i class="fas fa-edit"></i> Edit Job
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

      $('#jobDetailsModal').remove();
      $('body').append(modal);
      const modalInstance = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
      modalInstance.show();
    }

    // Run job now
    function runJobNow(jobName) {
      if (!confirm(`Are you sure you want to run "${jobName}" now?`)) {
        return;
      }

      showNotification(`Starting job "${jobName}"...`, 'info');

      // Simulate API call
      setTimeout(() => {
        showNotification(`Job "${jobName}" started successfully!`, 'success');
        refreshJobRuns();
      }, 1500);
    }

    // Delete job
    function deleteJob(jobName) {
      if (!confirm(`Are you sure you want to delete the job "${jobName}"? This action cannot be undone.`)) {
        return;
      }

      showNotification(`Job "${jobName}" deleted successfully!`, 'success');

      // Remove from table
      $(`#createdJobsBody button[onclick="deleteJob('${jobName}')"]`).closest('tr').fadeOut(300, function () {
        $(this).remove();
      });
    }

    // Refresh job runs
    function refreshJobRuns() {
      showNotification('Refreshing job runs...', 'info');
      // In production, this would fetch latest runs from Databricks API
      setTimeout(() => {
        showNotification('Job runs refreshed', 'success');
      }, 1000);
    }

    // Export for external use
    function showNodeDetails(node) {
      // Set Modal Title
      $('#detailsModalTitle').html(`<i class="fas ${node.icon === '\uf1c0' ? 'fa-database' : node.icon === '\uf201' ? 'fa-chart-line' : 'fa-table'} me-2"></i> ${node.name}`);

      // Basic Info
      let content = `
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card bg-light border-0">
              <div class="card-body text-center p-2">
                <small class="text-muted d-block uppercase">Type</small>
                <strong>${node.type.toUpperCase()}</strong>
              </div>
            </div>
          </div>
          <div class="col-md-4">
             <div class="card bg-light border-0">
              <div class="card-body text-center p-2">
                <small class="text-muted d-block uppercase">Row Count</small>
                <strong>${node.rowCount}</strong>
              </div>
            </div>
          </div>
          <div class="col-md-4">
             <div class="card bg-light border-0">
              <div class="card-body text-center p-2">
                <small class="text-muted d-block uppercase">Layer</small>
                <strong>${['Raw', 'DW', 'DM', 'BI'][node.layer]}</strong>
              </div>
            </div>
          </div>
        </div>
      `;

      // Mock Columns Data based on layer/type
      let columns = [];
      const getSourceTable = (nodeName) => {
        if (node.type === 'source') return '<span class="text-muted fst-italic">Ingested from Source System</span>';
        if (node.name.includes('dm.')) return node.name.replace('dm', 'dw'); // Simple heuristic
        return 'stg.raw_ingest';
      };

      if (node.type === 'source' || node.type === 'warehouse') {
        columns = [
          { name: 'id', type: 'BIGINT', key: 'PK', source: node.type === 'source' ? 'System_A' : 'stg.crm_raw' },
          { name: 'created_at', type: 'TIMESTAMP', key: '', source: node.type === 'source' ? 'System_A' : 'stg.crm_raw' },
          { name: 'updated_at', type: 'TIMESTAMP', key: '', source: node.type === 'source' ? 'System_A' : 'stg.crm_raw' }
        ];
        if (node.name.includes('sales')) {
          columns.push(
            { name: 'amount', type: 'DECIMAL(10,2)', key: '', source: 'stg.pos_transactions' },
            { name: 'customer_id', type: 'BIGINT', key: 'FK', source: 'stg.users_db' }
          );
        }
        if (node.name.includes('product')) {
          columns.push(
            { name: 'product_name', type: 'VARCHAR(255)', key: '', source: 'stg.inventory_db' },
            { name: 'sku', type: 'VARCHAR(50)', key: '', source: 'stg.inventory_db' }
          );
        }
        if (node.name.includes('customer')) {
          columns.push(
            { name: 'email', type: 'VARCHAR(100)', key: '', source: 'stg.crm_raw' },
            { name: 'status', type: 'VARCHAR(20)', key: '', source: 'stg.crm_raw' }
          );
        }
      } else if (node.type === 'mart') {
        // DM Layer - Show logic
        columns = [
          { name: 'dim_key', type: 'BIGINT', key: 'PK', source: `${node.name} <span class="badge bg-info text-dark">Derived</span>` },
          { name: 'total_amount', type: 'DECIMAL(12,2)', key: 'AGG', source: 'dw.sales_orders.amount' },
          { name: 'record_count', type: 'BIGINT', key: 'AGG', source: 'COUNT(*)' },
          { name: 'updated_at', type: 'TIMESTAMP', key: '', source: 'dw.etl_metadata' }
        ];
      } else {
        // BI Layer
        columns = [
          { name: 'Visual_1', type: 'Bar Chart', key: '-', source: 'dm.sales_summary' },
          { name: 'KPI_Revenue', type: 'Card', key: '-', source: 'dm.sales_summary.total_amount' }
        ];
      }

      // Column Lineage / Schema Table
      content += `
        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-columns text-primary"></i> Schema & Column Lineage</h6>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm table-hover table-bordered" style="font-size: 0.9rem;">
            <thead class="table-light position-sticky top-0" style="z-index: 5;">
              <tr>
                <th style="min-width: 150px;">Column Name</th>
                <th style="min-width: 120px;">Data Type</th>
                <th style="min-width: 100px;">Key / Trans.</th>
                <th style="min-width: 200px;">Source Table / Expression</th>
              </tr>
            </thead>
            <tbody>
              ${columns.map(col => `
                <tr>
                  <td><code>${col.name}</code></td>
                  <td><span class="text-muted">${col.type}</span></td>
                  <td>${col.key && col.key !== '-' ? `<span class="badge bg-secondary">${col.key}</span>` : '<span class="text-muted">-</span>'}</td>
                  <td class="text-muted small"><i class="fas fa-level-up-alt me-1 text-muted"></i> ${col.source}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      // Join Logic (if any)
      if (node.joinKeys && node.joinKeys.length > 0) {
        content += `
          <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-link text-success"></i> Build Logic (Joins)</h6>
          <div class="bg-light p-3 rounded border">
            <ul class="list-unstyled mb-0">
              ${node.joinKeys.map(k => `<li class="mb-1"><code class="text-primary">${k}</code></li>`).join('')}
            </ul>
          </div>
        `;
      }

      $('#detailsModalBody').html(content);
      new bootstrap.Modal(document.getElementById('lineageDetailsModal')).show();
    }

    function downloadConfig() {
      const jsonContent = document.getElementById('configSummaryContent').innerText;
      const blob = new Blob([jsonContent], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "databricks_elt_config.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    window.DatabricksELT = {
      toggleDetails,
      executeJob,
      showWorkflowSummary,
      downloadWorkflowConfig,
      downloadConfig,
      showNotification,
      fetchCatalogData,
      executeJobAPI,
      getLineageData,
      showScheduleModal,
      createNewJob,
      editJob,
      viewJobDetails,
      runJobNow,
      deleteJob,
      refreshJobRuns,
      showNodeDetails
    };
  </script>

  <!-- Lineage Details Modal -->
  <div class="modal fade" id="lineageDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content border-0 shadow-lg" style="height: 80vh;">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="detailsModalTitle">Node Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" id="detailsModalBody" style="overflow-y: auto;">
          <!-- Content injected via JS -->
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i> View in
            Catalog</button>
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Preview Modal -->
  <div class="modal fade" id="dataPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-table text-primary"></i> <span id="previewModalTitle">Table
              Preview</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="previewModalBody">
          <!-- Table content will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration Summary Modal -->
  <div class="modal fade" id="configSummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-file-code text-info"></i> Complete Job Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <pre id="configSummaryContent"
            style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: auto; font-size: 0.9rem;"><code></code></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" onclick="copyConfigToClipboard()">
            <i class="fas fa-copy"></i> Copy to Clipboard
          </button>
          <button type="button" class="btn btn-outline-success" onclick="downloadConfig()">
            <i class="fas fa-download"></i> Download JSON
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Initialize DataTables
    $(document).ready(function () {
      const table = $('#catalogTable').DataTable({
        "paging": true,
        "lengthChange": false,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "pageLength": 10,
        "dom": 'rt<"bottom"ip><"clear">', // Custom DOM positioning to hide default search
        "language": {
          "emptyTable": "No tables found in this catalog"
        }
      });

      // Connect custom search input
      $('#catalogSearchInput').on('keyup', function () {
        table.search(this.value).draw();
      });

      // Initialize Created Jobs Table
      const createdJobsTable = $('#createdJobsTable').DataTable({
        "paging": true,
        "lengthChange": false,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "pageLength": 5,
        "dom": 'rt<"bottom"ip><"clear">',
        "language": {
          "emptyTable": "No jobs created yet"
        }
      });

      $('#createdJobsSearch').on('keyup', function () {
        createdJobsTable.search(this.value).draw();
      });

      // Initialize Recent Runs Table
      const recentRunsTable = $('#recentRunsTable').DataTable({
        "paging": true,
        "lengthChange": false,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "pageLength": 5,
        "dom": 'rt<"bottom"ip><"clear">',
        "language": {
          "emptyTable": "No recent runs found"
        }
      });

      $('#recentRunsSearch').on('keyup', function () {
        recentRunsTable.search(this.value).draw();
      });

      // Initialize Lineage View
      renderLineage('sales_summary_dm');

      // Initialize Design Type (Default to DM/Gold)
      updateDesignType('dm');
    });

    // Lineage State
    let isLineageReversed = false;
    let currentLineageJobId = null;

    function toggleLineageDirection() {
      isLineageReversed = !isLineageReversed;
      if (currentLineageJobId) {
        renderLineage(currentLineageJobId);
      }
    }

    // ===== Data Lineage Logic =====
    // Enterprise Color Palette Helper
    const getStageColor = (type) => {
      switch (type) {
        case 'source': return '#C62828'; // Deep Red
        case 'warehouse': return '#0D47A1'; // Royal Blue
        case 'mart': return '#F57F17'; // Dark Gold/Amber
        case 'bi': return '#4A148C'; // Deep Purple
        default: return '#546E7A'; // Blue Grey
      }
    };

    // Enhanced Data Structure for Graph
    const lineageData = {
      'sales_summary_dm': {
        target: 'main.dm.sales_summary',
        nodes: [
          // Layer 0: Staging/Raw
          { id: 'stg.sales_raw', name: 'stg.sales_raw', layer: 0, type: 'source', rowCount: '2.6M', icon: '\uf1c0' }, // database
          { id: 'stg.product_raw', name: 'stg.product_raw', layer: 0, type: 'source', rowCount: '55K', icon: '\uf1c0' },
          { id: 'stg.customer_raw', name: 'stg.customer_raw', layer: 0, type: 'source', rowCount: '155K', icon: '\uf1c0' },

          // Layer 1: Data Warehouse
          { id: 'dw.sales_orders', name: 'dw.sales_orders', layer: 1, type: 'warehouse', rowCount: '2.5M', icon: '\uf0ce' }, // table
          { id: 'dw.products', name: 'dw.products', layer: 1, type: 'warehouse', rowCount: '50K', icon: '\uf0ce' },
          { id: 'dw.customers', name: 'dw.customers', layer: 1, type: 'warehouse', rowCount: '150K', icon: '\uf0ce' },

          // Layer 2: Data Mart (Target)
          {
            id: 'dm.sales_summary',
            name: 'dm.sales_summary',
            layer: 2,
            type: 'mart',
            rowCount: '500K',
            icon: '\uf201',
            active: true,
            joinKeys: [
              'dw.sales_orders.order_id = dw.customers.id',
              'dw.sales_orders.product_id = dw.products.id'
            ]
          }, // chart-line

          // Layer 3: BI/Consumers
          { id: 'PowerBI', name: 'PowerBI Dashboard', layer: 3, type: 'bi', rowCount: '-', icon: '\uf080' }, // chart-bar
          { id: 'Tableau', name: 'Tableau Report', layer: 3, type: 'bi', rowCount: '-', icon: '\uf6c4' } // chart-pie
        ],
        links: [
          // Staging -> DW
          { source: 'stg.sales_raw', target: 'dw.sales_orders', value: 10 },
          { source: 'stg.product_raw', target: 'dw.products', value: 5 },
          { source: 'stg.customer_raw', target: 'dw.customers', value: 5 },

          // DW -> DM
          { source: 'dw.sales_orders', target: 'dm.sales_summary', value: 15 },
          { source: 'dw.products', target: 'dm.sales_summary', value: 8 },
          { source: 'dw.customers', target: 'dm.sales_summary', value: 8 },

          // DM -> BI
          { source: 'dm.sales_summary', target: 'PowerBI', value: 10 },
          { source: 'dm.sales_summary', target: 'Tableau', value: 10 }
        ]
      },
      'customer_360_view': {
        target: 'main.dm.customer_360',
        nodes: [
          { id: 'stg.crm_raw', name: 'stg.crm_raw', layer: 0, type: 'source', rowCount: '200K', icon: '\uf1c0' },
          { id: 'dw.customers', name: 'dw.customers', layer: 1, type: 'warehouse', rowCount: '150K', icon: '\uf0ce' },
          { id: 'dw.transactions', name: 'dw.transactions', layer: 1, type: 'warehouse', rowCount: '8.1M', icon: '\uf0ce' },
          {
            id: 'dm.customer_360',
            name: 'dm.customer_360',
            layer: 2,
            type: 'mart',
            rowCount: '150K',
            icon: '\uf2c0',
            active: true,
            joinKeys: [
              'dw.customers.id = dw.transactions.customer_id'
            ]
          }, // user-circle
          { id: 'Salesforce', name: 'Salesforce Sync', layer: 3, type: 'bi', rowCount: '-', icon: '\uf0c2' }
        ],
        links: [
          { source: 'stg.crm_raw', target: 'dw.customers', value: 10 },
          { source: 'dw.customers', target: 'dm.customer_360', value: 15 },
          { source: 'dw.transactions', target: 'dm.customer_360', value: 10 },
          { source: 'dm.customer_360', target: 'Salesforce', value: 10 }
        ]
      },
      'product_analytics': {
        target: 'main.dm.product_metrics',
        nodes: [
          { id: 'stg.inventory', name: 'stg.inventory', layer: 0, type: 'source', rowCount: '50K', icon: '\uf1c0' },
          { id: 'dw.products', name: 'dw.products', layer: 1, type: 'warehouse', rowCount: '50K', icon: '\uf0ce' },
          {
            id: 'dm.product_metrics',
            name: 'dm.product_metrics',
            layer: 2,
            type: 'mart',
            rowCount: '20K',
            icon: '\uf201',
            active: true,
            joinKeys: [
              'dw.products.id = dw.sales_orders.product_id'
            ]
          },
          { id: 'Looker', name: 'Looker', layer: 3, type: 'bi', rowCount: '-', icon: '\uf06e' }
        ],
        links: [
          { source: 'stg.inventory', target: 'dw.products', value: 10 },
          { source: 'dw.products', target: 'dm.product_metrics', value: 15 },
          { source: 'dm.product_metrics', target: 'Looker', value: 10 }
        ]
      }
    };

    function renderLineage(jobId) {
      currentLineageJobId = jobId;
      const data = lineageData[jobId];
      if (!data) return;

      // Update Header with Toggle Button
      $('#lineageHeader').html(`
        <div class="d-flex justify-content-between align-items-center w-100">
           <span><i class="fas fa-project-diagram"></i> Lineage Graph for <code>${data.target}</code></span>
           <button class="btn btn-sm btn-outline-secondary" onclick="toggleLineageDirection()">
             <i class="fas fa-exchange-alt"></i> ${isLineageReversed ? 'Show Standard Flow (Lâ†’R)' : 'Reverse Flow (Râ†L)'}
           </button>
        </div>
      `);

      // Update Active List Item
      $('#lineageJobList .list-group-item').removeClass('active');
      $(`#lineageJobList button[onclick="renderLineage('${jobId}')"]`).addClass('active');

      // Clear Canvas
      const containerId = 'lineageCanvas';
      const container = document.getElementById(containerId);
      container.innerHTML = ''; // Clear previous content

      // D3 Settings
      // D3 Settings - Use a fixed logical width for reliable scaling
      const width = 1200; // Fixed logical width
      const height = 500;
      const margin = { top: 60, right: 50, bottom: 20, left: 50 }; // Increased top margin for headers
      const nodeWidth = 180; // Slightly smaller nodes
      const nodeHeight = 45;
      // Calculate spacing based on the fixed logical width
      const layerSpacing = (width - margin.left - margin.right - nodeWidth) / 3;

      // Create Tooltip if not exists
      let tooltip = d3.select('body').selectAll('.d3-tooltip').data([0]);
      tooltip = tooltip.enter().append('div')
        .attr('class', 'd3-tooltip')
        .style('opacity', 0)
        .merge(tooltip);

      // SVG
      const svg = d3.select(container).append('svg')
        .attr('width', '100%') // Responsive width
        .attr('height', '100%') // Responsive height
        .attr('viewBox', [0, 0, width, height]) // Coordinate system
        .attr('preserveAspectRatio', 'xMidYMid meet') // Center and fit
        .style('max-height', '600px') // Prevent it from getting too tall
        .call(d3.zoom().on("zoom", (event) => {
          g.attr("transform", event.transform);
        }))
        .append('g')
        .attr('id', 'main-g');

      const g = svg.append('g');

      // Calculate Nodes positions
      // Group nodes by layer
      const layers = d3.group(data.nodes, d => d.layer);

      data.nodes.forEach(d => {
        // X position based on layer (Handle Reversal)
        // Normal: 0 -> 1 -> 2 -> 3
        // Reverse: 3 -> 2 -> 1 -> 0
        const effectiveLayer = isLineageReversed ? (3 - d.layer) : d.layer;

        // Precise column placement
        d.x = margin.left + (effectiveLayer * layerSpacing);

        // Y position distributed within layer
        const nodesInLayer = layers.get(d.layer);
        const totalInLayer = nodesInLayer.length;
        const indexInLayer = nodesInLayer.indexOf(d);
        const layerHeight = height - margin.top - margin.bottom;
        // Center the group of nodes vertically
        const startY = margin.top + (layerHeight - (totalInLayer * (nodeHeight + 30))) / 2;
        d.y = startY + indexInLayer * (nodeHeight + 40);

        // Add default sizes
        d.width = nodeWidth;
        d.height = nodeHeight;
      });

      // Layer Headers - Render BEFORE transformation so they stay fixed relative to the geometric layout
      let layerLabels = ['Source / Raw', 'Data Warehouse', 'Data Mart (Gold)', 'BI & Consumption'];
      if (isLineageReversed) {
        layerLabels = layerLabels.reverse();
      }

      const headerLayer = g.append('g').attr('class', 'layer-headers');

      layerLabels.forEach((label, i) => {
        headerLayer.append('text')
          .attr('x', margin.left + (i * layerSpacing) + nodeWidth / 2)
          .attr('y', margin.top - 20)
          .attr('text-anchor', 'middle')
          .attr('font-family', 'Inter, sans-serif')
          .attr('font-weight', '600')
          .attr('font-size', '14px')
          .attr('fill', '#555')
          .text(label);
      });

      // Links
      // Map node ids to objects for links
      const nodeMap = new Map(data.nodes.map(d => [d.id, d]));
      const links = data.links.map(l => ({
        source: nodeMap.get(l.source),
        target: nodeMap.get(l.target),
        value: l.value
      })).filter(l => l.source && l.target); // Filter broken links

      // Draw Links
      const link = g.append("g")
        .attr("fill", "none")
        .selectAll("path")
        .data(links)
        .join("path")
        .attr("class", "link")
        .attr("d", d3.linkHorizontal()
          .source(d => [
            isLineageReversed ? d.source.x : d.source.x + d.source.width,
            d.source.y + d.source.height / 2
          ])
          .target(d => [
            isLineageReversed ? d.target.x + d.target.width : d.target.x,
            d.target.y + d.target.height / 2
          ]))
        .attr("stroke", d => {
          // Gradient or static color based on link value
          return "#42A5F5";
        })
        .attr("stroke-width", d => Math.max(2, d.value / 2));

      // Draw Nodes
      const node = g.append("g")
        .selectAll("g")
        .data(data.nodes)
        .join("g")
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .attr("class", "node")
        .on("click", function (event, d) {
          showNodeDetails(d);
          event.stopPropagation();
        })
        .on("mouseover", function (event, d) {
          // Show tooltip
          tooltip.transition().duration(200).style("opacity", .9);
          tooltip.html(`
               <h6><i class="fas ${d.icon === '\uf1c0' ? 'fa-database' : d.icon === '\uf201' ? 'fa-chart-line' : 'fa-table'}"></i> ${d.name}</h6>
               <hr class="my-1">
               <div><strong>Type:</strong> ${d.type.toUpperCase()}</div>
               <div><strong>Rows:</strong> ${d.rowCount}</div>
               <div><strong>Layer:</strong> ${['Raw', 'DW', 'DM', 'BI'][d.layer]}</div>
               <div class="mt-2 text-primary small"><i class="fas fa-mouse-pointer"></i> Click for details</div>
             `)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 28) + "px");

          // Highlight connected links
          const connectedLinks = link.filter(l => l.source === d || l.target === d);
          connectedLinks
            .style('stroke', 'var(--primary-color)')
            .style('stroke-opacity', 1)
            .style('stroke-width', 4);

          // Dim other links
          link.filter(l => l.source !== d && l.target !== d)
            .style('stroke-opacity', 0.1);

          // Scale up node slightly
          d3.select(this).select("rect")
            .transition().duration(200)
            .attr("transform", "scale(1.05)")
            .attr("stroke-width", 3)
            .style("filter", "drop-shadow(0 5px 15px rgba(0,0,0,0.2))");
        })
        .on("mouseout", function (d) {
          tooltip.transition().duration(500).style("opacity", 0);

          // Reset links
          link.style('stroke', '#90CAF9')
            .style('stroke-opacity', 0.6)
            .style('stroke-width', d => Math.max(3, d.value / 2));

          // Reset node
          d3.select(this).select("rect")
            .transition().duration(200)
            .attr("transform", "scale(1)")
            .attr("stroke-width", d => d.active ? 2.5 : 1.5)
            .style("filter", "drop-shadow(0 2px 4px rgba(0,0,0,0.05))");
        });

      // Node Rects
      node.append("rect")
        // Center rect around (0,0) helps with scaling, but here we use corner coordinates. 
        // To fix scaling origin, we'd need to change translate logic, but current simple scale is fine if slight shift is acceptable.
        // Actually for correct center scaling we should use transform-origin css, but D3 transform attr is easier.
        // Let's stick to simple rect for now.
        .attr("width", d => d.width)
        .attr("height", d => d.height)
        .attr("rx", 6)
        .attr("ry", 6)
        .attr("fill", "white")
        // Use stage color for border, thicker if active
        .attr("stroke", d => getStageColor(d.type))
        .attr("stroke-width", d => d.active ? 3 : 1)
        .style("filter", "drop-shadow(0 2px 4px rgba(0,0,0,0.05))");

      // Node Icons
      node.append("text")
        .attr("x", 20)
        .attr("y", d => d.height / 2)
        .attr("dy", "0.35em")
        .attr("font-family", "'Font Awesome 6 Free'")
        .attr("font-weight", "900")
        .attr("fill", d => getStageColor(d.type)) // Use same strong color
        .style("font-size", "16px")
        .text(d => d.icon);

      // Node Labels - Stricter Truncation
      node.append("text")
        .attr("x", 45)
        .attr("y", d => d.height / 2)
        .attr("dy", "0.35em")
        .attr("fill", "#424242")
        .style("font-size", "13px")
        .style("font-weight", "500")
        .style("pointer-events", "none") // Ensure clicks pass through to group
        .text(d => d.name.length > 15 ? d.name.substring(0, 14) + '...' : d.name);

      // Shift main graph down a bit to make room for headers
      // g.attr("transform", "translate(0, 40)"); // Already handled by margin.top 
    }

    // Fix for hoisting issue: Assign functions defined in this block to the global object
    if (window.DatabricksELT) {
      Object.assign(window.DatabricksELT, {
        renderLineage,
        toggleLineageDirection
      });
    }

    // ===== Monitoring Charts =====
    const ctxTrends = document.getElementById('jobTrendsChart').getContext('2d');
    new Chart(ctxTrends, {
      type: 'line',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
          label: 'Successful Runs',
          data: [120, 132, 101, 134, 145, 150, 142],
          borderColor: '#7AC143',
          backgroundColor: 'rgba(122, 193, 67, 0.1)',
          tension: 0.4,
          fill: true
        }, {
          label: 'Failed Runs',
          data: [2, 4, 1, 5, 2, 3, 2],
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    const ctxResource = document.getElementById('resourceChart').getContext('2d');
    new Chart(ctxResource, {
      type: 'doughnut',
      data: {
        labels: ['Compute', 'Storage', 'Network'],
        datasets: [{
          data: [65, 25, 10],
          backgroundColor: [
            '#0099FF',
            '#7AC143',
            '#ffc107'
          ],
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
          }
        }
      }
    });
  </script>
  <!-- Column Edit Modal -->
  <div class="modal fade" id="columnEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title fs-6 fw-bold">Edit Column Configuration</h5>
          <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <input type="hidden" id="editTableName">
          <input type="hidden" id="editOriginalName">

          <div class="row g-3 mb-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label small fw-bold text-uppercase text-muted" style="letter-spacing: 0.5px;">Column
                Name</label>
              <input type="text" class="form-control" id="editColumnName">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold text-uppercase text-muted" style="letter-spacing: 0.5px;">Data
                Type</label>
              <select class="form-select" id="editColumnType" onchange="toggleEditTypeFields()">
                <!-- Options populated by JS -->
              </select>
            </div>
            <div class="col-md-5">
              <div class="row g-2">
                <div class="col-12" id="editLengthGroup" style="display:none;">
                  <label class="form-label small fw-bold text-uppercase text-muted"
                    style="letter-spacing: 0.5px;">Length</label>
                  <input type="number" class="form-control" id="editColumnLength" placeholder="e.g. 255">
                </div>
                <div class="col-6" id="editPrecisionGroup" style="display:none;">
                  <label class="form-label small fw-bold text-uppercase text-muted"
                    style="letter-spacing: 0.5px;">Precision</label>
                  <input type="number" class="form-control" id="editColumnPrecision" placeholder="e.g. 10">
                </div>
                <div class="col-6" id="editScaleGroup" style="display:none;">
                  <label class="form-label small fw-bold text-uppercase text-muted"
                    style="letter-spacing: 0.5px;">Scale</label>
                  <input type="number" class="form-control" id="editColumnScale" placeholder="e.g. 2">
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3 w-50">
            <label class="form-label small fw-bold text-uppercase text-muted"
              style="letter-spacing: 0.5px;">Sensitivity</label>
            <select class="form-select" id="editColumnSensitivity">
              <option value="None">None</option>
              <option value="PII">PII</option>
              <option value="Masked">Masked</option>
              <option value="Hash">Hash</option>
            </select>
          </div>

          <!-- New Transformation UI -->
          <div class="mb-4">
            <label class="form-label small fw-bold text-uppercase text-muted"
              style="letter-spacing: 0.5px;">Transformation Expression</label>
            <div class="input-group">
              <textarea class="form-control font-monospace bg-light" id="editColumnExpression" rows="3"
                placeholder="e.g. UPPER(column_name)" style="font-size: 0.9rem;"></textarea>
            </div>
            <div class="form-text small">Using Spark SQL syntax. Leave empty for no transformation.</div>
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold text-uppercase text-muted"
              style="letter-spacing: 0.5px;">Transformation Helpers</label>
            <ul class="nav nav-tabs nav-tabs-sm" id="transformTabs" role="tablist">
              <li class="nav-item"><button class="nav-link active py-1 small" data-bs-toggle="tab"
                  data-bs-target="#tabString" type="button">String</button></li>
              <li class="nav-item"><button class="nav-link py-1 small" data-bs-toggle="tab" data-bs-target="#tabDate"
                  type="button">Date</button></li>
              <li class="nav-item"><button class="nav-link py-1 small" data-bs-toggle="tab" data-bs-target="#tabNumeric"
                  type="button">Numeric</button></li>
            </ul>
            <div class="tab-content border border-top-0 p-3 bg-light rounded-bottom">
              <div class="tab-pane fade show active" id="tabString">
                <div class="d-flex flex-wrap gap-2">
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('UPPER', 'UPPER(@col)')">UPPER</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('LOWER', 'LOWER(@col)')">LOWER</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('TRIM', 'TRIM(@col)')">TRIM</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('CONCAT', 'CONCAT(@col, \'suffix\')')">CONCAT</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('REPLACE', 'REPLACE(@col, \'old\', \'new\')')">REPLACE</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('SUBSTRING', 'SUBSTRING(@col, 1, 5)')">SUBSTRING</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('INITCAP', 'INITCAP(@col)')">INITCAP</button>
                </div>
              </div>
              <div class="tab-pane fade" id="tabDate">
                <div class="d-flex flex-wrap gap-2">
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('TO_DATE', 'TO_DATE(@col)')">TO_DATE</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('DATE_FORMAT', 'DATE_FORMAT(@col, \'yyyy-MM-dd\')')">FORMAT</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('DATE_TRUNC', 'DATE_TRUNC(\'MM\', @col)')">TRUNC</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('DATE_ADD', 'DATE_ADD(@col, 1)')">ADD</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('DATEDIFF', 'DATEDIFF(NOW(), @col)')">DIFF</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('YEAR', 'YEAR(@col)')">YEAR</button>
                </div>
              </div>
              <div class="tab-pane fade" id="tabNumeric">
                <div class="d-flex flex-wrap gap-2">
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('ABS', 'ABS(@col)')">ABS</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('ROUND', 'ROUND(@col, 2)')">ROUND</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('CEIL', 'CEIL(@col)')">CEIL</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('FLOOR', 'FLOOR(@col)')">FLOOR</button>
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="insertFunction('CAST', 'CAST(@col AS INT)')">CAST</button>
                </div>
              </div>
            </div>
          </div>


          <div class="form-check mt-3">
            <input class="form-check-input border border-secondary" type="checkbox" id="editColumnNullable">
            <label class="form-check-label small user-select-none" for="editColumnNullable">
              Nullable (Allow NULL values)
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveColumnChanges()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Lookup Modal -->
  <div class="modal fade" id="lookupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-link text-primary"></i> Add Dimension Lookup</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info py-2 px-3 mb-3">
            <i class="fas fa-info-circle me-1"></i> Configure how to join your driving table with a lookup table.
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Driving Table Column (FK)</label>
              <select class="form-select" id="lookupFkColumn">
                <option value="">Select column...</option>
              </select>
              <div class="form-text">Column from your main fact table</div>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Lookup Table</label>
              <select class="form-select" id="lookupDimTable" onchange="updateLookupModalDimColumns()">
                <option value="">Select table...</option>
              </select>
              <div class="form-text">Dimension table to join</div>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Lookup Table Key (PK)</label>
              <select class="form-select" id="lookupDimKey">
                <option value="">Select key column...</option>
              </select>
              <div class="form-text">Primary key of the dimension table</div>
            </div>

            <!-- Model Key Configuration Removed -->

            <div class="col-md-6">
              <label class="form-label small fw-bold">Join Type</label>
              <select class="form-select" id="lookupJoinType">
                <option value="INNER">INNER JOIN (Matching records only)</option>
                <option value="LEFT">LEFT JOIN (All driving records)</option>
                <option value="RIGHT">RIGHT JOIN (All lookup records)</option>
              </select>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveLookupFromModal()">Add Lookup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Computed Column Modal -->
  <div class="modal fade" id="computedColumnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-calculator text-primary"></i> Add Computed Column</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">


            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label small fw-bold">Column Name</label>
                <input type="text" class="form-control" id="computedColName" placeholder="e.g., total_amount">
              </div>

              <!-- Regular Column Inputs -->
              <div id="regularColInputs">
                <div class="mb-3">
                  <label class="form-label small fw-bold">Data Type</label>
                  <select class="form-select" id="computedColType">
                    <option value="STRING">STRING</option>
                    <option value="INT">INT</option>
                    <option value="DECIMAL">DECIMAL</option>
                    <option value="BOOLEAN">BOOLEAN</option>
                    <option value="DATE">DATE</option>
                    <option value="TIMESTAMP">TIMESTAMP</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label small fw-bold">SQL Expression</label>
                  <textarea class="form-control" id="computedColExpr" rows="5"
                    placeholder="e.g., quantity * unit_price"></textarea>
                  <div class="form-text">Use Spark SQL syntax. Click columns on the right to insert.</div>
                </div>
              </div>


            </div>
            <div class="col-md-4 border-start">
              <label class="form-label small fw-bold mb-2">Available Columns</label>
              <div id="computedAvailableCols" class="d-flex flex-column gap-1"
                style="max-height: 300px; overflow-y: auto;">
                <!-- Columns injected here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveComputedColumnFromModal()">Add Column</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-filter text-primary"></i> Add WHERE Filter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <ul class="nav nav-tabs mb-3" id="filterTabs" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="simple-filter-tab" data-bs-toggle="tab"
                data-bs-target="#simpleFiltered" type="button">Basic Builder</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="advanced-filter-tab" data-bs-toggle="tab" data-bs-target="#advancedFilter"
                type="button">Advanced SQL</button>
            </li>
          </ul>

          <div class="tab-content" id="filterTabContent">
            <!-- Basic Builder -->
            <div class="tab-pane fade show active" id="simpleFiltered">
              <div id="filterRowsContainer">
                <!-- Rows injected by JS -->
              </div>

              <button class="btn btn-sm btn-outline-primary mt-2" onclick="addFilterRow()">
                <i class="fas fa-plus"></i> Add Condition
              </button>

              <div class="alert alert-light border mt-3 small">
                <i class="fas fa-info-circle text-primary"></i> <strong>Preview:</strong> <code
                  id="filterBuilderPreview">...</code>
              </div>
            </div>

            <!-- Advanced SQL -->
            <div class="tab-pane fade" id="advancedFilter">
              <div class="mb-3">
                <label class="form-label small fw-bold">Filter Condition (SQL)</label>
                <textarea class="form-control" id="filterCondition" rows="3"
                  placeholder="e.g., status = 'Active' AND amount > 1000"></textarea>
                <div class="form-text">Enter a valid SQL WHERE clause condition.</div>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveFilterFromModal()">Add Filter</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Aggregation Modal -->
  <div class="modal fade" id="aggregationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-layer-group text-primary"></i> Aggregations & Group By</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Group By Section -->
            <div class="col-md-5 border-end">
              <h6 class="fw-bold mb-3"><i class="fas fa-object-group text-secondary"></i> Group By</h6>
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm" id="aggGroupBySearch"
                  placeholder="Search columns...">
              </div>
              <div id="aggGroupByList" class="border rounded p-2"
                style="height: 300px; overflow-y: auto; background: #f8f9fa;">
                <!-- Checkboxes injected here -->
              </div>
            </div>

            <!-- Aggregations Section -->
            <div class="col-md-7">
              <h6 class="fw-bold mb-3"><i class="fas fa-calculator text-secondary"></i> Aggregations</h6>
              <div class="mb-2 d-flex gap-2">
                <select class="form-select form-select-sm" id="aggFuncCol" style="width: 50%;">
                  <option value="">Select column...</option>
                </select>
                <select class="form-select form-select-sm" id="aggFuncType" style="width: 30%;">
                  <option value="SUM">SUM</option>
                  <option value="COUNT">COUNT</option>
                  <option value="AVG">AVG</option>
                  <option value="MIN">MIN</option>
                  <option value="MAX">MAX</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="addAggExpression()"><i class="fas fa-plus"></i></button>
              </div>

              <label class="form-label small text-muted mt-2">Defined Aggregations</label>
              <div id="aggExpressionList" class="border rounded p-2" style="height: 200px; overflow-y: auto;">
                <!-- Added expressions list -->
              </div>

              <div class="mt-2">
                <label class="form-label small fw-bold">Manual override (SQL)</label>
                <textarea class="form-control form-control-sm" id="aggExpressions" rows="2"
                  placeholder="Generated SQL will appear here..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveAggregationFromModal()">Save & Apply</button>
        </div>
      </div>
    </div>
  </div>






  <script>
    /*
    ============================================================================
       SECTION 10: CONNECTION MANAGEMENT & UI
       - Target connection UI logic
       - Connection selection/filtering
       - Connection summary pages
    ============================================================================
    */
    // --- Target Setup Logic ---
    function selectTargetMode(mode, element) {
      // Update visual selection
      document.querySelectorAll('#targetModeGrid .connection-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');

      // Update hidden radio state for compatibility
      const radio = document.querySelector(`input[name="targetConnectionMode"][value="${mode}"]`);
      if (radio) {
        radio.checked = true;
      }

      // Trigger UI update
      updateTargetConnectionUI();
    }

    function updateTargetConnectionUI() {
      // Get mode from hidden radio which acts as state
      const radio = document.querySelector('input[name="targetConnectionMode"]:checked');
      const mode = radio ? radio.value : 'same';

      const selectGroup = document.getElementById('targetConnSelectGroup');
      const newGroup = document.getElementById('targetConnNewGroup');
      const helpText = document.getElementById('targetConnHelp');

      if (selectGroup) selectGroup.style.display = mode === 'existing' ? 'block' : 'none';
      if (newGroup) {
        newGroup.style.display = mode === 'new' ? 'block' : 'none';
        if (mode === 'new') {
          // Render connections grid in the target area if not already done or just always refresh
          renderConnections('', 'targetNewConnGrid', 'target');
        }
      }

      if (helpText) {
        if (mode === 'same') {
          helpText.style.display = 'block';
        } else {
          helpText.style.display = 'none';
        }
      }

      // Hide schema config for New Connection mode to avoid confusion
      const schemaConfig = document.getElementById('targetSchemaConfig');
      if (schemaConfig) {
        schemaConfig.style.display = mode === 'new' ? 'none' : 'block';
      }
    }

    function updateTargetSchemaOptions() {
      const catalog = document.getElementById('targetCatalog').value;
      const schemaSelect = document.getElementById('targetSchema');

      // Clear existing options
      schemaSelect.innerHTML = '';

      let schemas = [];
      if (catalog === 'main') {
        schemas = ['dm', 'dw', 'staging'];
      } else if (catalog === 'analytics') {
        schemas = ['reports', 'dashboards'];
      } else {
        schemas = ['default'];
      }

      schemas.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.text = s;
        if (s === 'dm') option.selected = true;
        schemaSelect.appendChild(option);
      });

      updateFullTargetPath();
    }

    function updateFullTargetPath() {
      const catalog = document.getElementById('targetCatalog').value;
      const schema = document.getElementById('targetSchema').value;
      const table = 'sales_summary'; // configuring fixed table for now, or get from somewhere else

      document.getElementById('fullTargetPath').textContent = `${catalog}.${schema}.${table}`;
      // Also update the compact display in Build step
      document.getElementById('compactTargetPath').textContent = `${catalog}.${schema}.${table}`;
    }

    // --- Connection Setup Logic ---
    const connections = [
      { id: 'databricks', name: 'Databricks', type: 'Data Warehouse', icon: 'fas fa-layer-group', score: 100 },
      { id: 'snowflake', name: 'Snowflake', type: 'Data Warehouse', icon: 'far fa-snowflake', score: 95 },
      { id: 'redshift', name: 'AWS Redshift', type: 'Data Warehouse', icon: 'fab fa-aws', score: 90 },
      { id: 'bigquery', name: 'Google BigQuery', type: 'Data Warehouse', icon: 'fab fa-google', score: 85 },
      { id: 'synapse', name: 'Azure Synapse', type: 'Data Warehouse', icon: 'fab fa-microsoft', score: 80 },
      { id: 'postgres', name: 'PostgreSQL', type: 'Database', icon: 'fas fa-database', score: 75 },
      { id: 'mysql', name: 'MySQL', type: 'Database', icon: 'fas fa-database', score: 70 },
      { id: 'sqlserver', name: 'SQL Server', type: 'Database', icon: 'fas fa-server', score: 65 },
      { id: 'oracle', name: 'Oracle', type: 'Database', icon: 'fas fa-database', score: 60 },
      { id: 's3', name: 'Amazon S3', type: 'File System', icon: 'fab fa-aws', score: 55 },
      { id: 'adls', name: 'Azure Data Lake', type: 'File System', icon: 'fab fa-microsoft', score: 50 },
      { id: 'gcs', name: 'Google Cloud Storage', type: 'File System', icon: 'fab fa-google', score: 45 },
      // Added Shared Folders & Web Service
      { id: 'smb', name: 'SMB / CIFS Share', type: 'Network Share', icon: 'fas fa-network-wired', score: 50 },
      { id: 'ftp', name: 'FTP Server', type: 'Network Share', icon: 'fas fa-file-export', score: 48 },
      { id: 'nfs', name: 'NFS Mount', type: 'Network Share', icon: 'fas fa-hdd', score: 47 },
      { id: 'sftp', name: 'SFTP (Secure)', type: 'Network Share', icon: 'fas fa-file-shield', score: 49 },
      { id: 'webservice', name: 'Web Service (REST/SOAP)', type: 'Web Service', icon: 'fas fa-globe-americas', score: 52 }
    ];

    let currentSort = 'score';
    let selectedConnectionId = null;
    let selectedTargetConnectionId = null; // Track target side selection

    function filterTargetConnections(text) {
      renderConnections(text, 'targetNewConnGrid', 'target');
    }

    function filterConnections(text) {
      renderConnections(text);
    }

    function renderConnections(filterText = '', containerId = 'connectionsGrid', context = 'source') {
      const grid = document.getElementById(containerId);
      if (!grid) return;
      grid.innerHTML = '';

      let filtered = connections.filter(c => c.name.toLowerCase().includes(filterText.toLowerCase()));

      if (currentSort === 'title') {
        filtered.sort((a, b) => a.name.localeCompare(b.name));
      } else {
        filtered.sort((a, b) => b.score - a.score);
      }

      filtered.forEach(conn => {
        const isRecommended = conn.id === 'databricks';
        const isSelected = context === 'source' ? selectedConnectionId === conn.id : selectedTargetConnectionId === conn.id;

        const card = document.createElement('div');
        // Use simpler card style for target grid if needed, or same style
        card.className = `connection-card ${isSelected ? 'selected' : ''} ${isRecommended ? 'recommended' : ''}`;

        // Adjust sizing for target grid if nested
        if (context === 'target') {
          card.style.minWidth = '150px';
          card.style.flex = '0 0 auto'; /* Prevent excessive growing */
        }

        card.onclick = () => selectConnection(conn.id, context);

        // Render FontAwesome Icon
        const iconHtml = `<div class="connection-icon-wrapper" style="font-size: 30px; color: var(--primary-color); margin-bottom: 10px;">
                            <i class="${conn.icon}"></i>
                          </div>`;

        const badgeHtml = isRecommended ? `<div class="recommended-badge"><i class="fas fa-star me-1"></i> Recommended</div>` : '';

        // Added visual indicator for Source & Target Workable
        const workableHtml = `<div class="text-muted small mt-2" style="font-size: 0.75rem;"><i class="fas fa-exchange-alt text-success me-1"></i> Source & Target</div>`;

        card.innerHTML = `
          ${badgeHtml}
          ${iconHtml}
          <div class="connection-name" style="font-size:0.9rem;">${conn.name}</div>
          ${workableHtml}
        `;
        grid.appendChild(card);
      });
    }

    function selectConnection(id, context = 'source') {
      const conn = connections.find(c => c.id === id);

      if (context === 'source') {
        selectedConnectionId = id;
        renderConnections(document.getElementById('connectionSearch').value, 'connectionsGrid', 'source');

        if (id === 'databricks') {
          document.getElementById('connect-grid-view').style.display = 'none';
          document.getElementById('connect-form-view').style.display = 'block';
          document.getElementById('selectedConnName').textContent = conn.name;
        } else {
          alert(`Configuration for ${conn.name} is not yet implemented in this demo.`);
        }
      } else {
        // Target Context
        selectedTargetConnectionId = id;
        renderConnections('', 'targetNewConnGrid', 'target');

        // Show config form in separate view, hide grid wrapper
        document.getElementById('targetConnNewGridWrapper').style.display = 'none';
        document.getElementById('targetConnNewFormWrapper').style.display = 'block';
        document.getElementById('targetNewConnTypeLabel').textContent = conn.name;
      }
    }

    function showConnectionGrid() {
      document.getElementById('connect-form-view').style.display = 'none';
      document.getElementById('connect-grid-view').style.display = 'block';
    }

    function showTargetConnectionGrid() {
      document.getElementById('targetConnNewFormWrapper').style.display = 'none';
      document.getElementById('targetConnNewGridWrapper').style.display = 'block';
    }

    function filterConnections(text) {
      renderConnections(text);
    }

    function toggleTargetConnectionFormMode(mode) {
      if (mode === 'api') {
        document.getElementById('target-api-fields').style.display = 'block';
        document.getElementById('target-jdbc-fields').style.display = 'none';
      } else {
        document.getElementById('target-api-fields').style.display = 'none';
        document.getElementById('target-jdbc-fields').style.display = 'block';
      }
    }

    function testTargetConnection() {
      const btn = document.getElementById('btnTestTargetConnection');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
      btn.disabled = true;

      return new Promise((resolve) => {
        setTimeout(() => {
          document.getElementById('targetConnectionStatus').className = 'connection-status connected';
          const statusText = document.getElementById('targetConnectionText');
          statusText.innerText = 'Connected';
          statusText.classList.add('text-success', 'fw-bold');

          btn.innerHTML = '<i class="fas fa-check"></i> Verified';
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');

          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
            btn.disabled = false;
            resolve(true);
          }, 2000);
        }, 1500);
      });
    }

    async function saveTargetConnection() {
      const btn = document.getElementById('btnSaveTarget');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      btn.disabled = true;

      // Simulate API call
      setTimeout(async () => {
        // Verify connection if not already connected
        if (!document.getElementById('targetConnectionStatus').classList.contains('connected')) {
          // This would be replaced by actual connection verification
          // For demo, we skip or assume success if checking "new"
        }

        btn.innerHTML = '<i class="fas fa-check"></i> Saved';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        // Mark step as completed (optional visual cue)
        document.querySelector('.stepper-step[onclick*="target"]').classList.add('completed');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-primary');
          btn.disabled = false;
          activateStep('transform');
        }, 1000);
      }, 1500);
    }

    // --- Connection Summary Page Logic ---
    function loadConnectionSummaryPage() {
      // 1. Populate Source
      const sourceBody = document.getElementById('pageSourceBody');
      if (selectedConnectionId) {
        const conn = connections.find(c => c.id === selectedConnectionId);
        const sourceName = document.getElementById('connectionName').value || conn.name;
        const sourceDesc = document.getElementById('connectionDescription').value || 'Primary data ingestion source for this pipeline.';
        const mode = document.getElementById('modeApi').checked ? 'API Integration' : 'JDBC Connector';

        sourceBody.innerHTML = `
          <div class="hero-section">
             <div class="d-flex align-items-center">
                 <div class="bg-white text-primary rounded-circle p-3 me-4 shadow-sm" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="${conn.icon} fa-2x"></i>
                 </div>
                 <div>
                    <h5 class="text-white-50 text-uppercase small fw-bold mb-1">Source Connection</h5>
                    <h2 class="fw-bold mb-0 text-white">${sourceName}</h2>
                    <div class="mt-2"><span class="badge bg-white bg-opacity-25 border border-white border-opacity-25 text-white"><i class="fas fa-check-circle me-1"></i> Active</span></div>
                 </div>
             </div>
          </div>
          
          <div class="metric-grid">
              <div class="metric-box">
                  <div class="metric-label">Provider Type</div>
                  <div class="metric-value"><i class="fas fa-server text-secondary me-2"></i> ${conn.type}</div>
              </div>
              <div class="metric-box">
                  <div class="metric-label">Connection Mode</div>
                  <div class="metric-value"><i class="fas fa-plug text-primary me-2"></i> ${mode}</div>
              </div>
              <div class="metric-box">
                  <div class="metric-label">Last Sync</div>
                  <div class="metric-value"><i class="fas fa-clock text-info me-2"></i> Just now</div>
              </div>
               <div class="metric-box">
                  <div class="metric-label">Security</div>
                  <div class="metric-value"><i class="fas fa-shield-alt text-success me-2"></i> TLS 1.3</div>
              </div>
          </div>

          <div class="px-4 pb-4">
              <div class="metric-label mb-2">Description</div>
              <p class="text-muted small mb-4">${sourceDesc}</p>

              <div class="d-flex gap-2 border-top pt-4">
                  <button class="btn btn-primary"><i class="fas fa-edit me-2"></i> Edit Configuration</button>
                  <button class="btn btn-outline-secondary"><i class="fas fa-sync me-2"></i> Test Connection</button>
                  <button class="btn btn-outline-secondary ms-auto"><i class="fas fa-history me-2"></i> Logs</button>
              </div>
          </div>
        `;
      } else {
        sourceBody.innerHTML = `<div class="d-flex flex-column align-items-center justify-content-center h-100 py-5">
           <div class="icon-box bg-light text-secondary rounded-circle p-4 mb-3" style="font-size: 2rem;">
              <i class="fas fa-database"></i>
           </div>
           <h4 class="text-dark fw-bold">No Source Configured</h4>
           <p class="text-muted small mb-4">Please set up a source connection to proceed.</p>
           <button class="btn btn-primary px-4 rounded-pill" onclick="$('#workflow-tab').tab('show'); activateStep('connect');">
              <i class="fas fa-plus me-2"></i> Configure Source
           </button>
         </div>`;
      }

      // 2. Populate Target
      const targetBody = document.getElementById('pageTargetBody');
      const isTargetConnected = selectedTargetConnectionId || document.getElementById('targetConnectionStatus').classList.contains('connected');

      if (isTargetConnected) {
        let targetName = 'Same as Source';
        let targetType = 'Inherited';
        let targetDesc = 'Using source connection credentials for destination writing.';
        let targetIcon = 'fas fa-sync';
        let iconClass = 'text-secondary';

        const mode = document.querySelector('input[name="targetConnectionMode"]:checked')?.value || 'same';

        if (mode === 'same') {
          if (selectedConnectionId) {
            const srcConn = connections.find(c => c.id === selectedConnectionId);
            targetName = document.getElementById('connectionName').value + ' (Target)';
            targetType = 'Inherited / ' + srcConn.type;
            targetIcon = srcConn.icon;
            iconClass = 'text-primary';
          }
        } else if (mode === 'new') {
          targetName = document.getElementById('targetConnectionName').value;
          targetDesc = document.getElementById('targetConnectionDescription').value || 'Custom target configuration';
          const conn = connections.find(c => c.id === selectedTargetConnectionId);
          if (conn) {
            targetType = conn.type;
            targetIcon = conn.icon;
            iconClass = 'text-warning';
          }
        }

        const catalog = document.getElementById('targetCatalog').value;
        const schema = document.getElementById('targetSchema').value;

        targetBody.innerHTML = `
             <div class="hero-section target-hero">
             <div class="d-flex align-items-center">
                 <div class="bg-white rounded-circle p-3 me-4 shadow-sm" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="${targetIcon} fa-2x ${iconClass}"></i>
                 </div>
                 <div>
                    <h5 class="text-white-50 text-uppercase small fw-bold mb-1">Target Configuration</h5>
                    <h2 class="fw-bold mb-0 text-white">${targetName}</h2>
                    <div class="mt-2"><span class="badge bg-white bg-opacity-25 border border-white border-opacity-25 text-white"><i class="fas fa-check-circle me-1"></i> Ready</span></div>
                 </div>
             </div>
          </div>

          <div class="metric-grid">
              <div class="metric-box">
                  <div class="metric-label">Attributes</div>
                  <div class="metric-value"><i class="fas fa-server text-secondary me-2"></i> ${targetType}</div>
              </div>
              <div class="metric-box">
                  <div class="metric-label">Catalog</div>
                  <div class="metric-value"><i class="fas fa-book text-warning me-2"></i> ${catalog}</div>
              </div>
              <div class="metric-box">
                  <div class="metric-label">Schema</div>
                  <div class="metric-value"><i class="fas fa-layer-group text-primary me-2"></i> ${schema}</div>
              </div>
              <div class="metric-box">
                  <div class="metric-label">Write Mode</div>
                  <div class="metric-value"><i class="fas fa-pen text-secondary me-2"></i> Overwrite</div>
              </div>
          </div>

          <div class="px-4 pb-4">
              <div class="metric-label mb-2">Context</div>
              <p class="text-muted small mb-4">${targetDesc}</p>

               <div class="d-flex gap-2 border-top pt-4">
                  <button class="btn btn-warning text-dark"><i class="fas fa-edit me-2"></i> Modify Target</button>
                  <button class="btn btn-outline-secondary ms-auto"><i class="fas fa-code me-2"></i> View DDL</button>
              </div>
          </div>
            `;
      } else {
        targetBody.innerHTML = `<div class="d-flex flex-column align-items-center justify-content-center h-100 py-5">
           <div class="icon-box bg-light text-secondary rounded-circle p-4 mb-3" style="font-size: 2rem;">
              <i class="fas fa-bullseye"></i>
           </div>
           <h4 class="text-dark fw-bold">Target Not Configured</h4>
           <p class="text-muted small mb-4">Please define where the data should be written.</p>
           <button class="btn btn-warning px-4 rounded-pill" onclick="$('#workflow-tab').tab('show'); activateStep('target');">
              <i class="fas fa-plus me-2"></i> Configure Target
           </button>
         </div>`;
      }
    }

    function showConnectionDetail(type, btn) {
      // Reset all buttons to default state
      document.querySelectorAll('#connectionSidebar .list-group-item').forEach(el => {
        el.classList.remove('bg-light', 'active-source', 'active-target'); // custom active classes
        el.classList.add('text-muted');

        // Reset icon colors
        const iconBox = el.querySelector('.icon-box');
        if (iconBox) {
          iconBox.classList.remove('text-primary', 'text-warning');
          iconBox.classList.add('text-secondary');
        }
      });

      // Activate the clicked button
      if (btn) {
        btn.classList.remove('text-muted');
        const iconBox = btn.querySelector('.icon-box');
        iconBox.classList.remove('text-secondary');

        if (type === 'source') {
          btn.classList.add('active-source'); // CSS class for Source highlight
          iconBox.classList.add('text-primary');
        } else if (type === 'target') {
          btn.classList.add('active-target'); // CSS class for Target highlight
          iconBox.classList.add('text-warning');
        }
      }

      // Toggle Content Visibility
      ['source', 'target'].forEach(section => {
        const el = document.getElementById(`connDetail-${section}`);
        if (el) el.style.display = (section === type) ? 'block' : 'none';
      });
    }

    // --- Metadata Explorer Logic ---
    function showMetadataExplorer() {
      const modal = new bootstrap.Modal(document.getElementById('metadataExplorerModal'));
      modal.show();
      renderMetadataTree();

      // Attach Filter Listener
      document.getElementById('metaExplorerSearch').addEventListener('keyup', function (e) {
        renderMetadataTree(e.target.value);
      });
    }

    function renderMetadataTree(filterText = '') {
      const treeContainer = document.getElementById('metaExplorerTree');
      // Mock Data Structure (Demo)
      const metadata = {
        name: 'main',
        type: 'catalog',
        children: [
          {
            name: 'dw',
            type: 'schema',
            children: [
              { name: 'customers', type: 'table', rowCount: 15420, size: '2.5 GB' },
              { name: 'sales_orders', type: 'table', rowCount: 450012, size: '18.2 GB' },
              { name: 'products', type: 'table', rowCount: 3200, size: '150 MB' },
              { name: 'dim_date', type: 'table', rowCount: 7300, size: '2 MB' }
            ]
          },
          {
            name: 'dm',
            type: 'schema',
            children: [
              { name: 'report_monthly_sales', type: 'table', rowCount: 48, size: '100 KB' },
              { name: 'report_top_customers', type: 'table', rowCount: 100, size: '50 KB' }
            ]
          },
          {
            name: 'staging',
            type: 'schema',
            children: [
              { name: 'raw_events', type: 'table', rowCount: 0, size: '0 GB' }
            ]
          }
        ]
      };

      const lowerFilter = filterText.toLowerCase();

      // Recursive filter function
      const filterNode = (node) => {
        // If node name matches, return it (and all children)
        if (node.name.toLowerCase().includes(lowerFilter)) return node;

        // If not, check children
        if (node.children) {
          const filteredChildren = node.children.map(filterNode).filter(n => n !== null);
          if (filteredChildren.length > 0) {
            return { ...node, children: filteredChildren };
          }
        }
        return null;
      };

      const filteredMetadata = filterText ? filterNode(metadata) : metadata;

      if (!filteredMetadata) {
        treeContainer.innerHTML = '<div class="text-muted p-3">No matching items found.</div>';
        return;
      }

      let html = `<ul class="list-unstyled ms-2">`;

      const renderNode = (node) => {
        const isLeaf = !node.children;
        const hasChildren = node.children && node.children.length > 0;
        // Auto-expand on filter OR if it is the root catalog
        const isOpen = filterText.length > 0 || node.type === 'catalog';

        let itemHtml = `<li>`;

        if (node.type === 'catalog') {
          itemHtml += `
              <div class="d-flex align-items-center p-1 rounded" style="cursor: pointer;" onclick="toggleTree(this)">
                <i class="fas ${isOpen ? 'fa-caret-down' : 'fa-caret-right'} text-muted me-2"></i>
                <i class="fas fa-database text-warning me-2"></i>
                <strong>${node.name}</strong>
              </div>
              <ul class="list-unstyled ms-4 ${isOpen ? '' : 'd-none'}">`;
        } else if (node.type === 'schema') {
          itemHtml += `
              <div class="d-flex align-items-center p-1 rounded" style="cursor: pointer;" onclick="toggleTree(this)">
                <i class="fas ${isOpen ? 'fa-caret-down' : 'fa-caret-right'} text-muted me-2"></i>
                <i class="fas fa-folder text-primary me-2"></i>
                ${node.name}
              </div>
              <ul class="list-unstyled ms-4 ${isOpen ? '' : 'd-none'}">`;
        } else {
          // Table
          itemHtml += `
              <div class="d-flex align-items-center p-1 rounded tree-item" style="cursor: pointer;" 
                   onclick="showMetaDetails('table', '${node.name}', {rowCount: ${node.rowCount}, size: '${node.size}'}, this)">
                <i class="fas fa-table text-success me-2 ms-2"></i>
                <span class="text-dark">${node.name}</span>
              </div>`;
        }

        if (hasChildren) {
          node.children.forEach(child => {
            itemHtml += renderNode(child);
          });
        }

        if (!isLeaf) {
          itemHtml += `</ul>`;
        }
        itemHtml += `</li>`;
        return itemHtml;
      };

      html += renderNode(filteredMetadata);
      html += `</ul>`;
      treeContainer.innerHTML = html;
    }

    function toggleTree(element) {
      const childrenContainer = element.nextElementSibling;
      const icon = element.querySelector('.fa-caret-down, .fa-caret-right');
      if (childrenContainer) {
        childrenContainer.classList.toggle('d-none');
        if (icon) {
          icon.classList.toggle('fa-caret-down');
          icon.classList.toggle('fa-caret-right');
        }
      }
    }

    function showMetaDetails(type, name, data, element) {
      // 1. Reset ALL tree items to default state
      document.querySelectorAll('.tree-item').forEach(el => {
        // Container reset
        el.classList.remove('bg-primary', 'text-white');

        // Icon reset (back to green)
        const icon = el.querySelector('i');
        if (icon) {
          icon.classList.remove('text-white');
          icon.classList.add('text-success');
        }

        // Text reset (back to dark)
        const span = el.querySelector('span');
        if (span) {
          span.classList.remove('text-white');
          span.classList.add('text-dark');
        }
      });

      // 2. Highlight SELECTED item
      if (element) {
        // Container highlight
        element.classList.add('bg-primary', 'text-white');

        // Icon highlight (white)
        const icon = element.querySelector('i');
        if (icon) {
          icon.classList.remove('text-success');
          icon.classList.add('text-white');
        }

        // Text highlight (white)
        const span = element.querySelector('span');
        if (span) {
          span.classList.remove('text-dark');
          span.classList.add('text-white');
        }
      }

      const pane = document.getElementById('metaDetailPane');
      if (type === 'table') {
        const columns = [
          { name: 'id', type: 'INT', key: 'PK' },
          { name: 'created_at', type: 'TIMESTAMP', key: '' },
          { name: 'updated_at', type: 'TIMESTAMP', key: '' },
          { name: 'status', type: 'VARCHAR(20)', key: '' }
        ];

        // Add random mock columns based on name
        if (name.includes('customer')) columns.push({ name: 'email', type: 'VARCHAR(100)', key: '' }, { name: 'full_name', type: 'VARCHAR(100)', key: '' });
        if (name.includes('sales')) columns.push({ name: 'amount', type: 'DECIMAL(10,2)', key: '' }, { name: 'customer_id', type: 'INT', key: 'FK' });

        let colsHtml = columns.map(c => `
            <tr>
                <td>${c.key === 'PK' ? '<i class="fas fa-key text-warning" title="Primary Key"></i> ' : c.key === 'FK' ? '<i class="fas fa-key text-muted" title="Foreign Key"></i> ' : ''}<strong>${c.name}</strong></td>
                <td><code>${c.type}</code></td>
                <td><span class="badge bg-secondary">No</span></td>
            </tr>
        `).join('');

        pane.innerHTML = `
          <h4 class="mb-4"><i class="fas fa-table text-primary me-2"></i>${name}</h4>
          
          <div class="row mb-4">
             <div class="col-6">
                <div class="card p-3 border-0 bg-white shadow-sm">
                    <small class="text-muted text-uppercase">Row Count</small>
                    <div class="fs-4 fw-bold">${data.rowCount.toLocaleString()}</div>
                </div>
             </div>
             <div class="col-6">
                <div class="card p-3 border-0 bg-white shadow-sm">
                    <small class="text-muted text-uppercase">Size</small>
                    <div class="fs-4 fw-bold">${data.size}</div>
                </div>
             </div>
          </div>

          <h6 class="fw-bold border-bottom pb-2 mb-3">Columns Schema</h6>
          <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Column Name</th>
                    <th>Data Type</th>
                    <th>Nullable</th>
                </tr>
            </thead>
            <tbody>${colsHtml}</tbody>
          </table>
        `;
      }
    }




    function copyToClipboard() {
      const activeTabId = document.querySelector('#exportTabs .nav-link.active').getAttribute('id');
      let content = '';
      if (activeTabId === 'json-tab') {
        content = document.getElementById('workflowJsonContent').textContent;
      } else {
        content = document.getElementById('workflowYamlContent').textContent;
      }

      navigator.clipboard.writeText(content).then(() => {
        alert("Configuration copied to clipboard!");
      });
    }
    function sortConnections(sortBy) {
      currentSort = sortBy;
      renderConnections(document.getElementById('connectionSearch').value);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderConnections();
      updateTargetConnectionUI(); // Ensure default "Same as Source" is active
      updatePrerequisitesStatus(); // Check workspace readiness

      // Lake Configuration Card Interaction
      document.querySelectorAll('#ws-lake .lake-card').forEach(card => {
        card.addEventListener('click', function () {
          // 1. Visual Selection Logic
          document.querySelectorAll('.lake-card').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');

          // 2. Form Display Logic
          const type = this.getAttribute('data-storage-type');
          const formsContainer = document.getElementById('lake-config-forms');

          // Show container
          formsContainer.style.display = 'block';

          // Hide all specific forms
          document.querySelectorAll('.lake-form').forEach(f => f.style.display = 'none');

          // Show selected form
          const targetForm = document.getElementById(`form-${type}`);
          if (targetForm) {
            targetForm.style.display = 'block';

            // Smooth scroll to form
            targetForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }

          // 3. Update Status Bar
          updatePrerequisitesStatus();
        });
      });

      // Force Data Warehouse Default (with slight delay to ensure UI is ready)
      setTimeout(() => {
        updateDesignType('dw');
      }, 100);
    });

    // End of Connection Setup
    function selectWorkspaceOption(card) {
      // 1. Visual Selection
      const parent = card.closest('.row');
      if (parent) {
        parent.querySelectorAll('.lake-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
      }

      // 2. Show Configuration Forms
      const section = card.closest('.workspace-section');
      if (!section) return; // Should not happen

      const formsContainer = section.querySelector('[id$="-config-forms"]');
      if (formsContainer) {
        formsContainer.style.display = 'block';

        // Hide all specific forms first (for multi-choice sections like Staging/Schedule)
        const specificForms = formsContainer.querySelectorAll('.generic-form');
        specificForms.forEach(f => f.style.display = 'none');

        // Show specific form based on data-db-type (if exists) or just the main form
        const dbType = card.getAttribute('data-db-type');
        if (dbType) {
          const sectionId = section.id.replace('ws-', ''); // e.g., 'staging'
          const targetForm = document.getElementById(`${sectionId}-form-${dbType}`);
          if (targetForm) {
            targetForm.style.display = 'block';
            setTimeout(() => targetForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
          }
        } else {
          // Fallback or single form logic might not be needed if simple sections don't call this
          // But for safety, if we click something else:
        }
      }
    }

    function saveGenericConfig(sectionType, btn) {
      // 1. Identify Context
      const sectionId = `ws-${sectionType}`; // e.g. ws-staging
      const formsContainerId = `${sectionType}-config-forms`;
      const summaryContainerId = `${sectionType}-config-summary`;
      const summaryBodyId = `${sectionType}-summary-body`;

      const section = document.getElementById(sectionId);
      const formsContainer = document.getElementById(formsContainerId);
      const summaryContainer = document.getElementById(summaryContainerId);
      const summaryBody = document.getElementById(summaryBodyId);

      // 2. "Simulate" Validation & Saving
      // Find visible inputs in the forms container
      const inputs = formsContainer.querySelectorAll('input:not([type="hidden"]), select');
      let summaryHtml = '';
      let isValid = true;

      inputs.forEach(input => {
        // Skip hidden checks or unchecked switches if logic requires, but simple list is fine
        if (input.offsetParent === null) return; // Skip invisible inputs (e.g. from the other DB form)

        // Basic validation
        if (input.type !== 'checkbox' && !input.value && input.hasAttribute('required')) {
          isValid = false;
          input.classList.add('is-invalid');
        } else {
          input.classList.remove('is-invalid');
        }

        // Add to summary
        let label = 'Field';
        const labelEl = input.previousElementSibling;
        if (labelEl && labelEl.tagName === 'LABEL') {
          label = labelEl.innerText;
        } else if (input.parentElement.classList.contains('input-group')) {
          // Handle input groups (Min/Max etc)
          const prevText = input.previousElementSibling ? input.previousElementSibling.innerText : '';
          const parentLabel = input.parentElement.previousElementSibling ? input.parentElement.previousElementSibling.innerText : '';
          label = parentLabel + (prevText ? ` (${prevText})` : '');
        } else if (input.parentElement.classList.contains('form-check')) {
          label = input.nextElementSibling.innerText;
        }

        let value = input.value;
        if (input.type === 'password') value = '********';
        if (input.type === 'checkbox') value = input.checked ? 'Enabled' : 'Disabled';

        summaryHtml += `
          <tr>
            <td class="text-muted small text-uppercase" style="width: 40%;">${label}</td>
            <td class="fw-bold text-dark">${value}</td>
          </tr>
        `;
      });

      if (!isValid) {
        alert("Please fill in all required fields.");
        return;
      }

      // 3. UI Transition
      // Simulate API delay
      const originalBtnText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Saving...';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = originalBtnText;
        btn.disabled = false;

        formsContainer.style.display = 'none';
        summaryBody.innerHTML = summaryHtml;
        summaryContainer.style.display = 'block';

        // Also scroll to top of section
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Show notification
        // Assuming showNotification exists, else fallback
        if (typeof showNotification === 'function') {
          showNotification(`${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)} configuration saved!`, 'success');
        } else {
          alert("Configuration saved!");
        }

        // Update overall platform status if needed (optional)
        if (typeof updatePrerequisitesStatus === 'function') {
          updatePrerequisitesStatus();
        }
      }, 800);
    }

    function editGenericConfig(sectionType) {
      document.getElementById(`${sectionType}-config-summary`).style.display = 'none';
      const formsContainer = document.getElementById(`${sectionType}-config-forms`);
      formsContainer.style.display = 'block';

      // If it's a multi-form section (like staging), we need to ensure the correct sub-form is shown.
      // Ideally we remember which one, but for now, showing the container might be enough if we didn't hide the specific generic-form.
      // HOWEVER, selectWorkspaceOption hides them. 
      // BETTER LOGIC: Just show the container. The specific form inside should still be 'display: block' unless we explicitly hid it on save.
      // We hid 'formsContainer' entirely, so the inner 'display: block' state should persist.
    }

    function toggleTheme() {
      const checkbox = document.getElementById('theme-checkbox');
      if (checkbox.checked) {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
      }
    }

    // Initialize Theme
    (function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        const checkbox = document.getElementById('theme-checkbox');
        if (checkbox) checkbox.checked = true;
      }
    })();

    // --- Workspace Tab Logic ---
    function showWorkspaceSection(sectionId, btnElement) {
      // 1. Hide all sections
      document.querySelectorAll('.workspace-section').forEach(el => el.style.display = 'none');

      // 2. Show selected section
      const target = document.getElementById('ws-' + sectionId);
      if (target) {
        target.style.display = 'block';
      }

      // 3. Update active sidebar item
      if (btnElement) {
        const sidebar = document.getElementById('workspaceSidebar');
        sidebar.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        btnElement.classList.add('active');

        // Handle bolding logic manually or trust CSS
        // Reset all primary bold spans inside buttons if needed, but simple class switching usually suffices 
        // if CSS targets .active descendants.
      }
    }
    function updatePrerequisitesStatus() {
      // 1. Lake Storage Check
      // Logic: A lake card must be selected OR valid config saved
      const lakeSelected = document.querySelector('#ws-lake .lake-card.selected');
      // Ideally check if config is valid, but selection is good proxy for now

      const lakeStatusEl = document.getElementById('status-lake');

      if (lakeSelected) {
        lakeStatusEl.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i> <span class="text-success fw-bold">Lake Storage Ready</span>';
      } else {
        lakeStatusEl.innerHTML = '<i class="fas fa-exclamation-circle text-warning me-2"></i> <span class="text-warning">Lake Storage Pending</span>';
      }

      // 2. Compute Defaults (Mock Check - Assume Ready for Demo)
      // In real app, check if #ws-compute inputs are populated
      const computeStatusEl = document.getElementById('status-compute');
      // computeStatusEl.innerHTML = ... (Already static check for demo)

      // 3. Update Main Banner State
      const banner = document.querySelector('#workspaceReadinessBar > div');
      const iconBox = banner.querySelector('.icon-box');

      if (lakeSelected) {
        // All Ready State
        banner.style.borderLeft = '5px solid #198754'; // Success Green
        iconBox.className = 'icon-box bg-success text-white rounded-circle me-3 d-flex align-items-center justify-content-center';
        iconBox.innerHTML = '<i class="fas fa-check"></i>';
      } else {
        // Pending State
        banner.style.borderLeft = '5px solid #ffc107'; // Warning Amber
        iconBox.className = 'icon-box bg-warning text-dark rounded-circle me-3 d-flex align-items-center justify-content-center';
        iconBox.innerHTML = '<i class="fas fa-clipboard-check"></i>';
      }
    }
    // --- Lookup Modal Logic ---
    function openLookupModal() {
      // 1. Populate Driving Table Columns (FK Source)
      const drivingTable = selectedTables[0]; // Assume first table is driving
      const fkSelect = document.getElementById('lookupFkColumn');
      fkSelect.innerHTML = '<option value="">Select column...</option>';

      if (drivingTable && columnSchema[drivingTable]) {
        Object.keys(columnSchema[drivingTable]).forEach(col => {
          fkSelect.add(new Option(col, `${drivingTable}.${col}`));
        });
      }

      // 2. Populate Lookup Tables (Dimensions)
      const dimSelect = document.getElementById('lookupDimTable');
      dimSelect.innerHTML = '<option value="">Select table...</option>';

      // Populate with other selected tables (excluding driving)
      selectedTables.slice(1).forEach(table => {
        dimSelect.add(new Option(table, table));
      });

      // Also allow picking from loaded metadata (if not already on canvas)
      // For demo, we just use what's on canvas or mockup
      if (dimSelect.options.length === 1) {
        // Fallback if no other tables on canvas
        // Use keys that actually exist in tableMetadata (e.g., dw.customers)
        dimSelect.add(new Option('dim_customers', 'dw.customers'));
        dimSelect.add(new Option('dim_products', 'dw.products'));
        dimSelect.add(new Option('dim_transactions', 'dw.transactions'));
      }

      const modal = new bootstrap.Modal(document.getElementById('lookupModal'));
      modal.show();
    }

    function updateLookupModalDimColumns() {
      const dimTable = document.getElementById('lookupDimTable').value;
      const keySelect = document.getElementById('lookupDimKey');
      keySelect.innerHTML = '<option value="">Select key column...</option>';

      if (!dimTable) return;

      // Mock columns for demo if not in schema
      let columns = [];
      if (columnSchema[dimTable]) {
        columns = Object.keys(columnSchema[dimTable]);
      } else {
        // Fallback mocks
        if (dimTable.includes('customer')) columns = ['customer_sk', 'customer_id', 'email', 'name'];
        else if (dimTable.includes('product')) columns = ['product_sk', 'product_id', 'sku', 'name'];
        else if (dimTable.includes('date')) columns = ['date_sk', 'date_key', 'calendar_date', 'year'];
        else columns = ['id', 'key', 'name', 'created_at'];
      }

      columns.forEach(col => {
        keySelect.add(new Option(col, col));
      });
    }

    function saveLookupFromModal() {
      const drivingColFull = document.getElementById('lookupFkColumn').value; // table.col
      const lookupTable = document.getElementById('lookupDimTable').value;
      const lookupKey = document.getElementById('lookupDimKey').value;
      const joinType = document.getElementById('lookupJoinType').value;

      if (!drivingColFull || !lookupTable || !lookupKey) {
        alert("Please select driving column, lookup table, and join key.");
        return;
      }

      const lastDotIndex = drivingColFull.lastIndexOf('.');
      const drivingTable = drivingColFull.substring(0, lastDotIndex);
      const drivingCol = drivingColFull.substring(lastDotIndex + 1);

      // Ensure Lookup Table is selected/added to canvas metadata
      // This populates columnSchema and ensures it's in selectedTables for SQL generation
      if (typeof selectedTables !== 'undefined' && !selectedTables.includes(lookupTable)) {
        // Use addTableToCanvas to handle UI and Metadata consistency
        // Note: This relies on lookupTable key matching tableMetadata keys
        if (typeof addTableToCanvas === 'function') {
          addTableToCanvas(lookupTable);
        }
      }

      // Add Join Section with forced parameters
      // NOTE: We do NOT use addJoinSection() here because the user wants to avoid adding
      // visual artifacts (Join Card) to the canvas. We Updates State Only.
      // addJoinSection(drivingTable, lookupTable, { left: drivingCol, right: lookupKey }, joinType);

      const joinId = `join-${drivingTable.replace(/\./g, '-')}-${lookupTable.replace(/\./g, '-')}`;
      joinConditions.push({
        id: joinId,
        leftTable: drivingTable,
        rightTable: lookupTable,
        joinType: joinType,
        clauses: [
          { leftColumn: drivingCol, rightColumn: lookupKey, logic: 'AND' }
        ]
      });

      // --- UI UPDATE: Restore "Dimension Lookups" List ---
      if (document.getElementById('dimensionLookupList')) {
        dimensionLookupCounter++;
        const lookupId = `dimLookup-${dimensionLookupCounter}`;
        const html = `
            <div class="transformation-item" id="${lookupId}">
                <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-primary me-2">JOIN</span>
                    <strong>${joinType} JOIN</strong> 
                    <span class="mx-2 text-muted">|</span>
                    <code>${drivingTable}.${drivingCol}</code> = <code>${lookupTable}.${lookupKey}</code>
                </div>
                <!-- Note: The canvas remove button handles the actual logic. This is just a list view helper. -->
                <button class="btn btn-sm btn-outline-danger" onclick="removeDimensionLookupListEntry('${lookupId}', '${lookupTable}')">
                    <i class="fas fa-trash-alt"></i>
                </button>
                </div>
            </div>
          `;
        const container = document.getElementById('dimensionLookupList');
        container.classList.remove('d-none');
        container.classList.add('mt-3');
        container.insertAdjacentHTML('beforeend', html);
      }

      showNotification(`Added Join with ${lookupTable}`, 'success');

      // Close Modal
      const modalEl = document.getElementById('lookupModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      generateSQL(); // Already called by addJoinSection but safe to call again
    }

    // --- Programmatic Transformation Helpers (for AI Builder) ---
    function addFilter(tableName, condition) {
      if (!condition) return;

      filterCounter++;
      const id = `filter-${filterCounter}`;

      // Add to state
      filters.push({ id: id, condition: condition, table: tableName });

      // Update UI
      renderFiltersList();
      generateSQL();
    }

    function removeFilter(id) {
      filters = filters.filter(f => f.id !== id);
      renderFiltersList();
      generateSQL();
    }

    function addAggregation(tableName, groupBy, expressions) {
      if (!expressions) return;

      // Update state
      aggregationConfig[tableName] = {
        expressions: expressions,
        groupBy: groupBy || ''
      };

      // Update UI
      renderAggregationsList();
      generateSQL();
    }




    function saveComputedColumnFromModal() {
      const colName = document.getElementById('computedColName').value;

      if (!colName) {
        alert('Column Name is required');
        return;
      }

      let colType = document.getElementById('computedColType').value;
      let colExpr = document.getElementById('computedColExpr').value;

      if (!colExpr) {
        alert('SQL Expression is required');
        return;
      }

      // We need to update addComputedColumn to store metadata if we want to persist "Model Key" status.
      // Now updated to accept metadata
      addComputedColumn(colName, colType, colExpr, false, null);

      const modal = bootstrap.Modal.getInstance(document.getElementById('computedColumnModal'));
      modal.hide();

      // Clear inputs
      document.getElementById('computedColName').value = '';
      document.getElementById('computedColExpr').value = '';
    }

    function addComputedColumn(name, type, expr, isModelKey, modelKeyType) {
      if (!name || !expr) return;
      computedColumnCounter++;
      const id = `compCol-${computedColumnCounter}`;

      // Add to state
      computedColumns.push({
        id: id,
        name: name,
        type: type || 'STRING',
        expr: expr,
        isModelKey: !!isModelKey,
        modelKeyType: modelKeyType || null,
        isComputed: true
      });

      // Update UI
      renderComputedColumnsList();
      generateSQL();
    }

    function removeComputedColumn(id) {
      computedColumns = computedColumns.filter(c => c.id !== id);
      renderComputedColumnsList();
      generateSQL();
    }

    function saveLakeConfiguration(btn) {
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Saving...';
      btn.disabled = true;

      // Identify active form and type
      const activeCard = document.querySelector('.lake-card.selected');
      const type = activeCard ? activeCard.getAttribute('data-storage-type') : 's3'; // Default to s3 if none (shouldn't happen)

      // Get values based on type (Generic approach for demo)
      let summaryData = [];
      const form = document.getElementById(`form-${type}`);
      if (form) {
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
          const label = input.previousElementSibling ? input.previousElementSibling.innerText : 'Field';
          const value = input.value || '(Not Set)';
          // Mask secrets
          const finalValue = (input.type === 'password') ? '********' : value;
          summaryData.push({ label, value: finalValue });
        });
      }

      // Simulate API call
      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-2"></i> Saved';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        // Find checked prerequisites again to be sure
        updatePrerequisitesStatus();

        setTimeout(() => {
          // Reset Button
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-primary');
          btn.disabled = false;

          // Populate Summary Grid
          const summaryBody = document.getElementById('lake-summary-body');
          summaryBody.innerHTML = '';

          // Add Provider Name
          const providerName = activeCard ? activeCard.querySelector('h6').innerText : 'Unknown';
          summaryBody.innerHTML += `<tr><td class="text-muted small w-25">Provider</td><td class="fw-bold">${providerName}</td></tr>`;

          // Add Fields
          summaryData.forEach(item => {
            summaryBody.innerHTML += `<tr><td class="text-muted small">${item.label}</td><td>${item.value}</td></tr>`;
          });

          // Switch Views
          document.getElementById('lake-config-forms').style.display = 'none';
          document.getElementById('lake-config-summary').style.display = 'block';

        }, 1000);
      }, 1000);
    }

    function editLakeConfiguration() {
      document.getElementById('lake-config-summary').style.display = 'none';
      document.getElementById('lake-config-forms').style.display = 'block';

      // Ensure correct form is visible (it should be, but just in case)
      const activeCard = document.querySelector('.lake-card.selected');
      if (activeCard) {
        const type = activeCard.getAttribute('data-storage-type');
        document.querySelectorAll('.lake-form').forEach(f => f.style.display = 'none');
        document.getElementById(`form-${type}`).style.display = 'block';
      }
    }

    function runDryRun(btn) {
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
      btn.disabled = true;

      // Simulate Job Run
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;

        // Generate Mock Output
        // Use logic similar to 'generateMockData' but for the Target Table
        const tableName = document.getElementById('dmTableName').value || 'target_table';

        // Mock Columns (based on visual designer output or just default + random)
        // Ideally we'd parse the SQL preview, but for demo we can mock standard columns + 1 agg
        const columns = [
          { name: 'id', type: 'int' },
          { name: 'category', type: 'string' },
          { name: 'total_sales', type: 'double' },
          { name: 'last_updated', type: 'date' }
        ];

        const mockData = generateMockData(tableName, columns);

        // Populate Table
        const table = document.getElementById('dryRunTable');
        let headerHtml = '<tr>';
        columns.forEach(c => headerHtml += `<th>${c.name}</th>`);
        headerHtml += '</tr>';
        table.querySelector('thead').innerHTML = headerHtml;

        let bodyHtml = '';
        mockData.forEach(row => {
          bodyHtml += '<tr>';
          columns.forEach(c => bodyHtml += `<td>${row[c.name]}</td>`);
          bodyHtml += '</tr>';
        });
        table.querySelector('tbody').innerHTML = bodyHtml;

        // Show Results
        document.getElementById('dryRunResults').style.display = 'block';
        document.getElementById('dryRunResults').scrollIntoView({ behavior: 'smooth' });

      }, 2000);
    }

    // AI Data Builder Functions
    // Helper to remove entry from the sidebar list (Visual only, actual logic via Canvas)
    function removeDimensionLookupListEntry(id, tableName) {
      const el = document.getElementById(id);
      if (el) el.remove();

      // Optionally trigger removal of the table from canvas if desired?
      // For now, let's just remove the list item as the user might want to keep the table on canvas.
      // If we want to remove the JOIN, we would need to find the specific join condition.
      // Given the complexity of finding the exact join object without an ID, 
      // we'll assume this button primarily cleans up the "List View".
      // But to be helpful, let's try to remove the table if it's a lookup table.
      if (confirm(`Do you also want to remove the table "${tableName}" from the canvas?`)) {
        if (typeof removeTable === 'function') {
          removeTable(tableName);
        }
      }
    }

    function openAiBuilderModal() {
      // Clear previous input
      document.getElementById('aiBuilderInput').value = '';
      const modal = new bootstrap.Modal(document.getElementById('aiBuilderModal'));
      modal.show();
    }

    function generatePipelineFromAi() {
      const input = document.getElementById('aiBuilderInput').value;
      const modalElement = document.getElementById('aiBuilderModal');
      const modal = bootstrap.Modal.getInstance(modalElement);

      if (!input.trim()) {
        alert("Please describe your pipeline requirements.");
        return;
      }

      const inputLower = input.toLowerCase();
      let tablesAdded = 0;
      let transformationsAdded = 0;

      // 1. Identify Tables
      // key: keyword to match, value: table ID to add
      const keywordMap = {
        'customer': 'dw.customers',
        'order': 'dw.sales_orders',
        'product': 'dw.products',
        'transaction': 'dw.transactions',
        'inventory': 'dw.products'
      };

      Object.keys(keywordMap).forEach(key => {
        if (inputLower.includes(key)) {
          if (typeof addTableToCanvas === 'function') {
            // Check if already selected to avoid duplicates
            if (!selectedTables.includes(keywordMap[key])) {
              addTableToCanvas(keywordMap[key]);
              tablesAdded++;
            }
          }
        }
      });

      // 2. Identify Filters (WHERE clauses)
      // Pattern: "filter <table?> where <condition>" or "keep <condition>"
      // Regex tries to capture condition after 'where' or 'filter'
      // Example: "Filter customers where region is 'NY'" -> tableName: customers, condition: region is 'NY'

      if (inputLower.includes('filter') || inputLower.includes('where')) {
        // Simple heuristic: extract text after "where"
        const whereSplit = input.split(/where/i);
        if (whereSplit.length > 1) {
          let condition = whereSplit[1].split('.')[0].trim(); // Take until next sentence
          // Clean up common verbal fluff
          condition = condition.replace(/^is\s+/, '').replace(/^are\s+/, '');

          // Try to associate with a table
          let targetTable = selectedTables[0]; // Default to first table
          selectedTables.forEach(t => {
            if (inputLower.includes(t.split('.')[1].replace('_', ' '))) { // fuzzy match table name in prompt
              targetTable = t;
            }
          });

          // Convert semantic condition to SQL if simple
          // e.g. "region is 'NY'" -> "region = 'NY'"
          if (condition.includes(' is ') && !condition.includes('=')) {
            condition = condition.replace(' is ', ' = ');
          }

          addFilter(targetTable, condition);
          transformationsAdded++;
        }
      }

      // 3. Identify Aggregations
      // Pattern: "sum amount by customer" -> Aggregation
      if (inputLower.includes('aggregate') || inputLower.includes('sum ') || inputLower.includes('count ') || inputLower.includes('average ')) {
        // Heuristic: Check for 'by' for grouping
        const bySplit = input.split(/ by /i);
        let groupBy = '';
        let expressions = '';

        if (bySplit.length > 1) {
          groupBy = bySplit[1].split(/[\.,]/)[0].trim(); // Take simple group column
        }

        // Look for aggregates
        const aggs = [];
        if (inputLower.includes('sum')) aggs.push('SUM(amount)'); // Placeholder guess
        if (inputLower.includes('count')) aggs.push('COUNT(*)');
        if (inputLower.includes('avg') || inputLower.includes('average')) aggs.push('AVG(amount)');

        if (aggs.length > 0) {
          expressions = aggs.join(', ');
          // Find facts table usually
          const targetTable = selectedTables.find(t => t.includes('sales') || t.includes('trans')) || selectedTables[0];
          addAggregation(targetTable, groupBy, expressions);
          transformationsAdded++;
        }
      }

      // 4. Identify Computed Columns
      // Pattern: "calculate <name> as <expr>"
      if (inputLower.includes('calculate') || inputLower.includes('compute')) {
        const calcMatch = input.match(/(?:calculate|compute)\s+(\w+)\s+(?:as|=)\s+(.+?)(?:[\.,]|$)/i);
        if (calcMatch) {
          const colName = calcMatch[1];
          const expr = calcMatch[2];
          addComputedColumn(colName, 'DECIMAL', expr);
          transformationsAdded++;
        }
      }

      modal.hide();

      // Feedback
      setTimeout(() => {
        let msg = `AI Builder: Configured pipeline based on your request.`;
        if (tablesAdded > 0) msg += `\n- Added ${tablesAdded} tables.`;
        if (transformationsAdded > 0) msg += `\n- Applied ${transformationsAdded} transformations (Filters, Aggregations, Calcs).`;

        if (tablesAdded === 0 && transformationsAdded === 0) {
          msg = "AI Builder: Could not identify specific actions. Try phrases like 'Add customers table', 'Filter where region is NY', or 'Calculate total as sum(amount)'.";
        }



        alert(msg);
      }, 500);
    }
  </script>

  <script>
    /* --- Import Configuration Logic --- */
    function openImportConfigModal() {
      const modal = new bootstrap.Modal(document.getElementById('importConfigModal'));
      modal.show();
    }

    async function importConfiguration() {
      const jsonText = document.getElementById('importConfigJson').value;
      if (!jsonText) {
        showNotification('Please paste a configuration JSON.', 'warning');
        return;
      }

      try {
        const config = JSON.parse(jsonText);

        // Wait for application
        await applyConfiguration(config);

        bootstrap.Modal.getInstance(document.getElementById('importConfigModal')).hide();
        showNotification('Configuration imported successfully!', 'success');
      } catch (e) {
        console.error("Import Failed:", e);
        alert(`Import Error: ${e.message}`); // Direct user feedback
        showNotification(`Invalid JSON or Import Error: ${e.message}`, 'danger');
      }
    }

    async function applyConfiguration(config) {
      // SET IMPORT FLAG: Prevents addTableToCanvas from auto-creating Joins
      window.isImporting = true;
      try {
        // 1. Meta / Design Type
        const designType = config.meta?.designType;
        if (designType === 'DATA_MART' || designType === 'Data Mart') { // Support both
          const el = document.getElementById('designTypeDM');
          if (el && !el.checked) el.click();
        } else {
          const el = document.getElementById('designTypeDW');
          if (el && !el.checked) el.click();
        }
        if (config.meta?.jobName) {
          const el = document.getElementById('scheduleJobName');
          if (el) el.value = config.meta.jobName;
        }

        // 1b. Restore defaultTableRoles if available (for sidebar badge display)
        if (config.sources) {
          config.sources.forEach(s => {
            if (s.role) defaultTableRoles[s.table] = s.role.toLowerCase();
          });
        }

        // 2. Clear Current State
        if (typeof selectedTables !== 'undefined') {
          // Create a copy to iterate, remove safely
          const tablesToRemove = [...selectedTables];
          tablesToRemove.forEach(t => {
            // We try to use the UI function to remove visuals
            if (typeof removeTable === 'function') {
              try { removeTable(t); } catch (e) { console.warn("Error removing table " + t, e); }
            }
          });
          // FORCE CLEAR if UI removal failed or state desync
          selectedTables = [];
        }
        filters = [];
        computedColumns = [];
        joinConditions = [];
        if (typeof lookups !== 'undefined') lookups = [];

        if (typeof aggregationConfig !== 'undefined') {
          Object.keys(aggregationConfig).forEach(k => delete aggregationConfig[k]);
        }

        renderFiltersList();
        renderComputedColumnsList();
        renderAggregationsList();
        renderDimensionLookupList();

        // 3. Source Connection
        const sourceId = config.source?.id || config.sourceConnection?.id; // Backward compat
        if (sourceId) {
          selectConnection(sourceId, 'source');
        }

        // 4. Target Connection
        const target = config.target || config.targetConnection || {};
        if (target) {
          if (target.catalog) { const el = document.getElementById('targetCatalog'); if (el) el.value = target.catalog; }
          if (target.schema) { const el = document.getElementById('targetSchema'); if (el) el.value = target.schema; }
          if (target.table) { const el = document.getElementById('dmTableName'); if (el) el.value = target.table; }
          if (target.writeMode) { const el = document.getElementById('createMode'); if (el) el.value = target.writeMode; }
        }

        // 5. Inputs (Tables & Canvas)
        const sources = config.sources || config.inputs || [];
        if (sources && Array.isArray(sources)) {
          selectedTables = [];
          for (const input of sources) {
            // HYDRATION FIX: Ensure metadata exists for the imported table
            if (typeof tableMetadata === 'undefined') window.tableMetadata = {};

            if (!tableMetadata[input.table]) {
              console.warn(`Hydrating missing metadata for ${input.table} from import definition.`);
              tableMetadata[input.table] = {
                name: input.table,
                columns: input.columns.map(c => ({
                  name: c.sourceColumn,
                  type: c.dataType || 'STRING',
                  isPK: false
                }))
              };
            }

            if (typeof addTableToCanvas === 'function') {
              try {
                addTableToCanvas(input.table);

                // REHYDRATION FIX: Restore Column Selection
                if (input.columns && Array.isArray(input.columns)) {
                  if (!selectedColumns[input.table]) selectedColumns[input.table] = [];

                  input.columns.forEach(col => {
                    // Handle both format variations (sourceColumn from storage vs name from hydration)
                    const colName = col.sourceColumn || col.name;

                    // 1. Update State
                    if (!selectedColumns[input.table].includes(colName)) {
                      selectedColumns[input.table].push(colName);
                    }

                    // 2. Update UI (Checkboxes)
                    // We use the data attributes injected by addTableToCanvas
                    const checkbox = document.querySelector(`input.column-checkbox[data-table="${input.table}"][data-column="${colName}"]`);
                    if (checkbox) {
                      checkbox.checked = true;
                    }
                  });
                }
              } catch (err) {
                console.error(`Failed to add table ${input.table}:`, err);
              }
            }
          }
        }

        // 6. Logic / Transformations
        const logic = config.transformations || config.logic || {};
        if (logic) {
          // Joins
          if (logic.joins) {
            logic.joins.forEach(j => {
              const condition = j.conditions && j.conditions[0];
              if (condition) {
                addJoinSection(j.left, j.right, { left: condition.left, right: condition.right }, j.type);
              }
            });
          }

          // Filters
          if (logic.filters) {
            logic.filters.forEach(fStr => {
              addFilter(selectedTables[0] || '', fStr);
            });
          }

          // Computed Columns
          if (logic.calculatedColumns) {
            logic.calculatedColumns.forEach(c => {
              addComputedColumn(c.name, c.type, c.expression, false, null);
            });
          }

          // Aggregations
          if (logic.aggregations) {
            logic.aggregations.forEach(agg => {
              addAggregation(agg.table, agg.groupBy, agg.measures);
            });
          }

          // SCD (if present)
          if (logic.scd) {
            if (logic.scd.strategy) $('#scdType').val(logic.scd.strategy);
            if (logic.scd.keys) $('#scdKeys').val(logic.scd.keys.join(', '));
          }
        }

        generateSQL();
      } finally {
        // CLEANUP: Reset import flag so manual actions work again
        window.isImporting = false;

      }
    }

    /* --- Rendering Helpers --- */
    function renderFiltersList() {
      const container = document.getElementById('filtersList');
      if (!container) return;
      container.innerHTML = '';

      if (filters.length === 0) {
        container.classList.add('d-none');
        container.classList.remove('mt-3');
        return;
      }

      container.classList.remove('d-none');
      container.classList.add('mt-3');

      filters.forEach(f => {
        const tableBadge = f.table ? `<span class="badge bg-info text-dark me-2" title="Applied to ${f.table}">${f.table}</span>` : '';
        const html = `
          <div class="transformation-item" id="${f.id}">
             <div class="d-flex justify-content-between align-items-center">
                <div>
                   ${tableBadge}
                   <span class="badge bg-warning text-dark me-2">WHERE</span>
                   <code>${f.condition}</code>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeFilter('${f.id}')">
                   <i class="fas fa-trash-alt"></i>
                </button>
              </div>
          </div>`;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    function renderComputedColumnsList() {
      const container = document.getElementById('computedColumnsList');
      if (!container) return;
      container.innerHTML = '';

      if (computedColumns.length === 0) {
        container.classList.add('d-none');
        container.classList.remove('mt-3');
        return;
      }

      container.classList.remove('d-none');
      container.classList.add('mt-3');

      computedColumns.forEach(c => {
        let badge = '<span class="badge bg-info text-dark me-2">CALC</span>';
        if (c.isModelKey) {
          badge = (c.modelKeyType === 'SK')
            ? '<span class="badge bg-primary me-2">SK</span>'
            : '<span class="badge bg-warning text-dark me-2">BK</span>';
        }
        const html = `
            <div class="transformation-item" id="${c.id}">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  ${badge}
                  <strong>${c.name}</strong> <small class="text-muted">(${c.type || 'STRING'})</small>
                  <div class="small text-muted mt-1"><code>${c.expr}</code></div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeComputedColumn('${c.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    function renderDimensionLookupList() {
      const container = document.getElementById('dimensionLookupList');
      if (!container) return;
      container.innerHTML = '';

      if (typeof lookups === 'undefined' || lookups.length === 0) {
        container.classList.add('d-none');
        container.classList.remove('mt-3');
        return;
      }

      container.classList.remove('d-none');
      container.classList.add('mt-3');

      lookups.forEach(l => {
        const html = `
          <div class="transformation-item" id="${l.id}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="badge bg-primary me-2">LOOKUP</span>
                <code class="text-muted">JOIN ${l.dimTable} ON ${l.dimTable}.${l.dimKey} = ${activeTableContext}.${l.fkColumn} (${l.joinType})</code>
              </div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeLookup('${l.id}')">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });
    }


    // Populate Available Tables dynamically from tableMetadata
    function renderAvailableTables() {
      const tableList = document.getElementById('tableList');
      if (!tableList) return;

      tableList.innerHTML = ''; // Clear existing tables

      // Get all tables from table Metadata and sort them
      Object.keys(tableMetadata).sort().forEach(tableName => {
        const displayName = tableName.split('.')[1]; // Remove 'dw.' prefix
        const html = `
      <div class="table-item" onclick="addTableToCanvas('${tableName}')" data-table="${tableName}" title="${tableName}">
        <div><strong>${displayName}</strong></div>
        <small class="text-muted">${tableName}</small>
      </div>
    `;
        tableList.insertAdjacentHTML('beforeend', html);
      });
    }

    // Call on page load
    $(document).ready(function () {
      renderAvailableTables();
    });















  </script>

  <!-- Hidden Data Containers for SQL Generation (Required for Export) -->
  <div class="d-none">
    <div id="sqlPreviewCreate"><code></code></div>
    <div id="sqlPreviewSelect"><code></code></div>
    <div id="configPreviewKeys"><code></code></div>
    <div id="configPreviewValues"><code></code></div>
  </div>

  <!-- AI Data Builder Modal -->
  <div class="modal fade" id="aiBuilderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-robot me-2"></i>AI Pipeline Builder</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <p class="text-muted mb-3">Describe your data pipeline requirements in plain English, and I'll generate the
            configuration for you.</p>
          <div class="mb-3">
            <textarea class="form-control" id="aiBuilderInput" rows="5"
              placeholder="Example: Join customers and sales_orders on customer_id, filter for recent orders, and aggregate total sales by customer."></textarea>
          </div>
          <div class="alert alert-light border" role="alert">
            <small class="text-muted"><i class="fas fa-info-circle me-1"></i> I can identify tables, join keys, and
              simple transformations.</small>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="generatePipelineFromAi()">
            <i class="fas fa-magic me-2"></i>Generate Config
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Configuration Modal -->
  <div class="modal fade" id="importConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-file-import text-purple"></i> Import Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Configuration JSON / YAML</label>
            <textarea class="form-control font-monospace" id="importConfigJson" rows="12"
              placeholder="Paste your configuration here..."></textarea>
            <div class="form-text">Paste the full JSON configuration object (from 'View Config').</div>
          </div>
          <div class="alert alert-warning border-0 bg-soft-warning small">
            <i class="fas fa-exclamation-triangle me-2"></i> <strong>Warning:</strong> Importing will overwrite your
            current canvas and transformation settings.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-purple" onclick="importConfiguration()">
            <i class="fas fa-check me-2"></i> Import & Apply
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Workflow Summary Modal -->
  <div class="modal fade" id="workflowSummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-project-diagram text-primary"></i> Workflow Configuration (Updated)
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Tabs -->
          <ul class="nav nav-tabs nav-tabs-custom px-3 pt-3" id="workflowTabs" role="tablist">
            <li class="nav-item d-none" id="jobs-tab-li">
              <a class="nav-link" id="jobs-tab" data-bs-toggle="tab" href="#workflow-jobs" role="tab">
                <i class="fas fa-tasks me-2"></i> Select Jobs
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" id="json-tab" data-bs-toggle="tab" href="#workflow-json" role="tab">
                <i class="fab fa-js me-2"></i> JSON
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="yaml-tab" data-bs-toggle="tab" href="#workflow-yaml" role="tab">
                <i class="fas fa-file-code me-2"></i> YAML
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="narrative-tab" data-bs-toggle="tab" href="#workflow-narrative" role="tab">
                <i class="fas fa-file-alt me-2"></i> Narrative
              </a>
            </li>
          </ul>
          <div class="tab-content p-3" id="workflowTabContent">
            <!-- Job Selection Tab -->
            <div class="tab-pane fade" id="workflow-jobs" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 text-muted">Select tasks to include in the workflow:</h6>
                <div>
                  <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleAllJobs(true)">Select
                    All</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllJobs(false)">Deselect All</button>
                </div>
              </div>
              <div id="workflowJobList" class="list-group list-group-flush border rounded mb-3"
                style="max-height: 400px; overflow-y: auto;">
                <!-- Jobs will be rendered here -->
                <div class="text-center p-4 text-muted"><i class="fas fa-spinner fa-spin me-2"></i> Loading tasks...
                </div>
              </div>
              <div class="alert alert-info small border-0 bg-soft-info">
                <i class="fas fa-info-circle me-2"></i> The JSON, YAML and Narrative will automatically update based on
                your selection.
              </div>
            </div>

            <div class="tab-pane fade show active" id="workflow-json" role="tabpanel">
              <div class="position-relative">
                <button class="btn btn-sm btn-outline-primary position-absolute top-0 end-0 m-2"
                  onclick="copyToClipboard('workflowJsonContent')">
                  <i class="fas fa-copy me-1"></i> Copy
                </button>
                <pre id="workflowJsonContent" class="bg-light p-3 rounded"
                  style="max-height: 500px; overflow-y: auto;"><code></code></pre>
              </div>
            </div>
            <div class="tab-pane fade" id="workflow-yaml" role="tabpanel">
              <div class="position-relative">
                <button class="btn btn-sm btn-outline-primary position-absolute top-0 end-0 m-2"
                  onclick="copyToClipboard('workflowYamlContent')">
                  <i class="fas fa-copy me-1"></i> Copy
                </button>
                <pre id="workflowYamlContent" class="bg-light p-3 rounded"
                  style="max-height: 500px; overflow-y: auto;"><code></code></pre>
              </div>
            </div>
            <div class="tab-pane fade" id="workflow-narrative" role="tabpanel">
              <div id="workflowNarrativeContent" class="p-3 bg-white" style="max-height: 500px; overflow-y: auto;">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Close
          </button>
          <button type="button" class="btn btn-outline-primary" onclick="copyActiveTabContent()">
            <i class="fas fa-clipboard me-1"></i> Copy to Clipboard
          </button>
          <button type="button" class="btn btn-primary" onclick="downloadWorkflowConfig()">
            <i class="fas fa-download me-1"></i> Download JSON
          </button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>